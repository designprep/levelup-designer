<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">    <title>레벨업 디자이너</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* [폰트] Pretendard */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

/* [1. 전체 화면 및 바디 설정] */
html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #191F28; overflow: hidden; position: fixed; touch-action: none; }

/* ▼▼▼ [추가/수정] 화면 잘림 방지용 강제 스타일 ▼▼▼ */
canvas {
    display: block !important;
    width: 100% !important;
    height: 100% !important;
    touch-action: none;
}
/* 2. 게임 컨테이너: 비율 고정(aspect-ratio) 삭제 -> 화면 전체 사용 */
#game-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    margin: 0;
    padding: 0;
    overflow: hidden;
    z-index: 1;
}

/* [모바일 등 세로가 더 긴 화면일 때의 예외 처리] */
@media (max-aspect-ratio: 9/16) {
    #game-container {
        width: 100vw;       /* 너비를 화면 꽉 차게 */
        height: auto;       /* 높이는 비율에 맞춰 자동 */
        max-height: 100vh;
    }
}


        /* [2. 인트로 화면: 위 컨테이너 크기를 따라감] */
        #intro-layer {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            z-index: 99999; 
            background-color: #191F28;
            display: flex; flex-direction: column; 
            justify-content: space-between; 
            align-items: center;
            cursor: pointer;
            padding: 80px 0 70px 0;
            box-sizing: border-box;
        }

        /* 배경 이미지 */
        .intro-bg {
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%;
            object-fit: cover; object-position: center;
            z-index: -1; opacity: 0; animation: fadeIn 2s forwards;
        }
/* 로고 */
.logo-container { width: 100%; text-align: center; opacity: 0; animation: slideDown 1s ease-out 0.5s forwards; }
.intro-logo { width: 80%; max-width: 280px; height: auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); margin-bottom: 10px; }
.intro-subtitle { font-size: 20px; font-weight: 800; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); margin: 0; letter-spacing: 1px; }

/* 시작 메시지 */
.start-msg { font-size: 16px; font-weight: 500; color: #fff; animation: blink 1.5s infinite 1s; opacity: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

/* 애니메이션 */
@keyframes fadeIn { to { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

/* 3. UI 레이어: 화면 전체 사용 */
#ui-layer, #phase2-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; }
        #phase2-ui-layer { display: none; } 

        .top-bar, .menu-bar, .bottom-area, .popup, #modal-overlay, #ad-overlay, .nav-btn, .debug-btn, .full-btn, .sign-btn, .project-widget { pointer-events: auto; }

        .debug-btn { position: absolute; top: 120px; left: 20px; z-index: 9999; background: rgba(255, 50, 50, 0.8); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }

/* 2. 상단바: 좌우 패딩 16px 적용 */
.top-bar { 
    position: absolute; top: 0; left: 0; width: 100%; height: auto;
    background: linear-gradient(180deg, rgba(25,31,40,0.98) 0%, rgba(25,31,40,0) 100%);
    z-index: 15;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: 10px;
    
    /* ★ 핵심: 내용물이 양옆 16px 떨어지게 설정 */
    padding-left: 16px; 
    padding-right: 16px; 
    
    display: flex; flex-direction: column; 
    box-sizing: border-box; /* 패딩 포함해서 너비 계산 */
}

/* [신규] 1열: 설정 버튼 + 날짜 */
.top-row {
    display: flex; 
    align-items: center; 
    margin-bottom: 4px;
}

/* [수정] 설정 버튼: 배경/테두리 제거하고 아이콘만 심플하게 */
.btn-gear {
    background: transparent; /* 배경 투명화 */
    border: none;            /* 테두리 삭제 */
    
    color: rgba(255, 255, 255, 0.8); /* 약간 투명한 흰색 (세련됨) */
    font-size: 22px;         /* 아이콘 크기 조절 */
    
    /* 터치 영역 확보를 위한 패딩 */
    padding: 4px;
    width: auto; 
    height: auto;
    
    display: flex; 
    align-items: center; 
    justify-content: center;
    cursor: pointer;
    margin-right: 2px; /* 날짜와 간격 좁힘 */
    transition: transform 0.2s; /* 누를 때 애니메이션용 */
}

/* 눌렀을 때 살짝 돌아가게 (선택사항) */
.btn-gear:active {
    transform: rotate(90deg);
    color: #fff;
}

/* 날짜 텍스트 */
#ui-week, #p2-ui-week {
    font-size: 13px; color: #8B95A1; font-weight: 600;
}

/* [신규] 2열: 금액 + 직급 뱃지 */
.money-row {
    display: flex; 
    align-items: center; 
    margin-bottom: 10px; /* 게이지바와 간격 */
}

#ui-money, #p2-ui-money {
    font-size: 28px; font-weight: 800; color: #fff; 
    letter-spacing: -0.5px; line-height: 1.0;
}

/* 직급 뱃지 (티어 포함) */
.rank-badge { 
    font-size: 12px; padding: 4px 8px; border-radius: 6px; 
    font-weight: 700; 
    background: rgba(255, 215, 0, 0.15); 
    border: 1px solid rgba(255, 215, 0, 0.4); 
    color: #FFD700; 
    margin-left: 10px; 
    transform: translateY(-1px);
}

/* [수정] 게이지 바 (꽉 차게) */
.bar-container {
    display: flex; align-items: center; 
    margin-bottom: 8px; 
    width: 100%; 
}
.bar-label { 
    width: 32px; font-weight: 700; font-size: 12px; color: #B0B8C1; 
    flex-shrink: 0; 
}
.bar-bg { 
    flex: 1; /* 남은 공간 100% 차지 */
    height: 10px; background: #333D4B; border-radius: 10px; 
    overflow: hidden; position: relative; 
}
        .bar-container { display: flex; align-items: center; margin-bottom: 8px; }
        .bar-label { width: 30px; font-weight: 700; font-size: 12px; color: #B0B8C1; }
        .bar-bg { flex: 1; height: 10px; background: #333D4B; border-radius: 10px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 0%; border-radius: 10px; transition: width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        #hp-bar, #p2-mental-bar { background: #75D06A; } 
        #exp-bar, #p2-skill-bar { background: #9956DE; } 
        #pf-bar, #p2-perf-bar { background: #FF8B8B; } 

        #ui-deadline { text-align:right; font-size:13px; color:#FF8B8B; font-weight:700; margin-top: 4px; height: 20px;}

        /* [Phase 2 프로젝트 위젯] */
        .project-widget {
            position: absolute; top: calc(170px + env(safe-area-inset-top)); right: 16px; width: 120px;
            background: #FFF9C4; color: #333; padding: 12px; border-radius: 2px 2px 10px 2px;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3); transform: rotate(2deg); z-index: 12;
            display: none; /* JS로 제어 */ font-family: 'Pretendard', sans-serif;
            pointer-events: auto;
        }
        .project-widget h4 { margin: 0 0 5px 0; font-size: 11px; color: #F57F17; font-weight: 800; text-transform: uppercase; }
        .pw-title { font-size: 13px; font-weight: 700; line-height: 1.3; margin-bottom: 8px; display: block; }
        .pw-info { font-size: 11px; color: #555; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .pw-bar-bg { width: 100%; height: 6px; background: #E0E0E0; border-radius: 3px; overflow: hidden; }
        .pw-bar-fill { height: 100%; background: #FBC02D; width: 0%; transition: width 0.3s; }
        .pw-stamp { 
            position: absolute; bottom: 5px; right: 5px; border: 2px solid #FF5F5F; color: #FF5F5F; 
            font-size: 10px; font-weight: 900; padding: 2px 4px; transform: rotate(-15deg); opacity: 0; transition: opacity 0.3s;
        }

        /* [2. 메뉴 버튼] */
       .menu-bar { 
            position: absolute; 
            bottom: 280px; 
            left: 0;       
            width: 100%;   
            
            display: flex; 
            justify-content: center; 
            align-items: center;
            
            gap: 6px; /* 버튼 간격 미세 조정 */
            
            z-index: 20;   
            pointer-events: auto; 
            
            /* ★ 핵심: 양옆 여백을 4px로 아주 얇게 줌 ★ */
            padding: 0 4px; 
            box-sizing: border-box; 
        }
        .menu-btn { background: rgba(51, 61, 75, 0.95); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 8px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .menu-btn:active { transform: scale(0.95); background: #454F5D; }

        /* [3. 하단 영역] */

.bottom-area { 
    position: absolute; bottom: 0; left: 0; width: 100%; height: auto;
    background: linear-gradient(0deg, #191F28 90%, rgba(25,31,40,0.95) 100%);
    z-index: 15;
    padding-top: 20px; 
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    
    /* ★ 핵심: 하단 UI도 양옆 16px 여백 확보 */
    padding-left: 16px;
    padding-right: 16px;
    
    display: flex; flex-direction: column; justify-content: flex-end;
    box-sizing: border-box; 
}
/* 기존 .log-box, .action-grid 의 width: 94% 등은 100%로 변경하거나 삭제해도 무방함 (패딩이 있으므로) */
.log-box, .action-grid { width: 100%; margin: 0; }
       .log-box, .action-grid { 
    width: 100%; 
    margin: 0 0 15px 0; /* 마진 오토 삭제 */
}
        .log-box { background: #333D4B; border-radius: 16px; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 15px; box-sizing: border-box; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { height: 60px; border: none; border-radius: 18px; cursor: pointer; font-family: 'Pretendard'; color: #fff; display: flex; flex-direction: column; align-items: flex-start; justify-content: center; padding: 0 20px; position: relative; overflow: hidden; transition: transform 0.1s, filter 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .action-btn:active { transform: scale(0.96); filter: brightness(0.9); }
        .action-btn div { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .action-btn span { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); }

        .btn-skill { background-color: #9956DE; } 
        .btn-project { background-color: #FF8B8B; } 
        .btn-alba { background-color: #FFB356; } 
        .btn-social { background-color: #7274ED; } 
        .btn-rest { background-color: #75D06A; } 

        .action-btn::after { content: attr(data-icon); position: absolute; right: 15px; bottom: 12px; font-size: 24px; opacity: 0.4; }

        /* [팝업 UI] */
        #modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9000; }
        .popup { display: none; flex-direction: column; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; max-height: 80vh; background: #242A36; border: 1px solid rgba(255,255,255,0.05); padding: 24px; color: #fff; z-index: 10000; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow-y: auto; overflow-x: hidden; }
        .popup h2 { margin: 0 0 20px 0; color: #fff; text-align: left; font-size: 20px; font-weight: 800; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #333D4B; color: #fff; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 16px; font-weight: bold; cursor: pointer; display:flex; align-items:center; justify-content:center; }
        
        .item-list { list-style: none; padding: 0; margin: 0; width: 100%; box-sizing: border-box; }
        .item-list li, .card-btn { background: #333D4B; border: none; padding: 16px; margin-bottom: 10px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; width: 100%; box-sizing: border-box; cursor: pointer; }
        .item-list li:active, .card-btn:active { background: #454F5D; transform: scale(0.98); }
        .card-info h3 { margin: 0; font-size: 15px; font-weight: 700; color: #fff; } .card-info p { margin: 4px 0 0 0; font-size: 12px; color: #B0B8C1; }
        
        .shop-item { display: flex !important; align-items: center; justify-content: space-between; width: 100%; }
        .shop-left { display: flex; align-items: center; flex: 1; }
        .shop-thumb { width: 44px; height: 44px; background:#191F28; margin-right: 14px; object-fit: contain; border-radius: 12px; border: 1px solid #333; }
        .shop-info { display: flex; flex-direction: column; text-align: left; }
        .shop-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .shop-desc { font-size: 11px; color: #8B95A1; }
        .shop-price { font-size: 13px; color: #7274ED; margin-top: 4px; font-weight: 700; }

        .btn-buy { background: #3182F6; color: #fff; padding: 8px 14px; border-radius: 8px; border:none; font-weight:600; font-size:12px; min-width: 60px; text-align: center;} .btn-buy:disabled { background: #454F5D; color: #8B95A1; }
        .btn-action { background: #FF8B8B; color: white; padding: 8px 16px; border-radius:8px; border:none; font-weight:700;}
        .btn-ad { width: 100%; padding: 14px; background: #333D4B; color: #FFB356; border: 1px dashed #FFB356; margin-top: 10px; border-radius:12px; font-weight: 700; }
        .card-btn .btn-ad { width: auto; margin-top: 0; padding: 8px 16px; border-radius: 8px; font-size: 12px; min-width: 60px; }
        .full-btn { width: 100%; padding: 14px; background: #3182F6; color: white; font-size: 16px; margin-top: 10px; border: none; border-radius: 16px; font-weight:700; cursor: pointer;}
        
        .job-card { display:flex; align-items:center; font-size:15px; color: #fff; font-weight: 600; }
        .job-tier { font-size: 11px; padding: 4px 8px; border-radius: 6px; margin-right: 12px; font-weight: 800; width: 50px; text-align: center; }
        .tier-Unicorn { background: rgba(255, 179, 86, 0.2); color: #FFB356; border:1px solid #FFB356; } 
        .tier-TopTier { background: rgba(114, 116, 237, 0.2); color: #7274ED; border:1px solid #7274ED; } 
        .tier-Agency { background: rgba(255, 255, 255, 0.1); color: #B0B8C1; border:1px solid #8B95A1; }
        .btn-apply { background: #3182F6; color: white; padding: 8px 14px; border-radius: 8px; border: none; font-weight:700; font-size:12px; min-width: 70px;} .btn-apply:disabled { background: #454F5D; color: #8B95A1; }

        .input-name { width: 100%; padding: 14px; background: #191F28; border: 1px solid #333; color: #fff; margin-bottom: 12px; box-sizing: border-box; outline: none; border-radius: 12px; font-size:14px;} .input-name:focus { border-color: #3182F6; }
        .select-group { display: flex; gap: 10px; height: 160px; margin-bottom: 15px; }
        .select-col { flex: 1; display: flex; flex-direction: column; } .select-col h3 { font-size: 13px; color: #8B95A1; margin-bottom: 8px; font-weight: 600; }
        .scroll-box { flex: 1; overflow-y: scroll; border: 1px solid #333; background: #191F28; padding: 6px; border-radius: 12px; }
        .radio-item { display: block; padding: 10px; border-bottom: 1px solid #222; font-size: 13px; cursor: pointer; color: #fff; } .radio-item:hover { background: #333; }
        
        #ad-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 20000; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; }
        #ad-overlay h1 { color: #FFF; } #ad-overlay p { color: #8B95A1; }

        .toggle-switch { position: relative; width: 40px; height: 24px;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #454F5D; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3182F6; }
        input:checked + .slider:before { transform: translateX(16px); }

        .ranking-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 40px; font-size: 16px; font-weight: 800; color: #B0B8C1; text-align: center; }
        .rank-num.top { color: #FFD700; font-size: 18px; }
        .rank-name { flex: 1; font-size: 14px; font-weight: 600; color: #fff; }
        .rank-score { font-size: 14px; font-weight: 700; color: #3182F6; }
        .my-rank { background: rgba(49, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(49, 130, 246, 0.3); }

        #success-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 20000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .paper-notice { background: #fdfbf7; width: 100%; max-width: 380px; padding: 30px 25px; border-radius: 8px; box-shadow: 0 15px 40px rgba(0,0,0,0.6), inset 0 0 60px rgba(255,253,240,0.5); text-align: center; position: relative; overflow: hidden; animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .notice-header { margin-bottom: 25px; position: relative; }
        .notice-title { color: #333; font-size: 22px; font-weight: 800; margin: 10px 0; letter-spacing: -0.5px; }
        .deco-line { height: 2px; background: #333; width: 40px; margin: 0 auto; opacity: 0.3; }
        .final-stamp { position: absolute; top: -10px; right: -10px; border: 4px double #d32f2f; color: #d32f2f; font-weight: 900; font-size: 16px; padding: 8px 12px; transform: rotate(-15deg); border-radius: 4px; text-transform: uppercase; opacity: 0.9; mix-blend-mode: multiply; }
        .approved-stamp { position: absolute; top: 30px; left: -15px; color: rgba(49, 130, 246, 0.2); font-size: 40px; font-weight: 900; transform: rotate(-30deg); z-index: 0; pointer-events: none; }
        .notice-body { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; position: relative; z-index: 1; }
        .char-stamp-box { width: 100px; height: 120px; background: #fff; border: 1px solid #ddd; padding: 5px; margin-bottom: 15px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); transform: rotate(-2deg); }
        .success-char-img { width: 100%; height: 100%; object-fit: contain; background: #f5f5f5; }
        .notice-text { color: #555; font-size: 14px; line-height: 1.6; word-break: keep-all; }
/* [수정] 회사명 스타일 (Block 제거 -> 글자 옆에 '의'가 붙도록 변경) */
        .company-name {color: #3182F6; font-size: 22px; /* 폰트 크기 유지 */ font-weight: 800; text-decoration: underline; }        
        .score-box { background: linear-gradient(135deg, #fff9e6 0%, #fff 100%); border: 2px solid #FFD700; border-radius: 12px; padding: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); }
        .score-label { font-size: 13px; color: #b78a00; font-weight: 700; margin-bottom: 5px; }
        .score-value { color: #333; font-size: 18px; font-weight: 700; }
        .score-desc { font-size: 12px; color: #999; margin-top: 5px; font-style: italic; }
        .notice-footer { font-size: 13px; color: #777; }
        .footer-note { font-size: 11px; color: #aaa; margin-top: 5px; }
        .sign-btn { background: #333; margin-top: 20px; border-radius: 8px; font-size: 15px; }
        
        .quiz-box { text-align: center; margin-bottom: 20px; }
        .quiz-q { font-size: 18px; font-weight: 700; color: #FFB356; margin-bottom: 15px; word-break: keep-all; line-height: 1.4; }
        .quiz-input { width: 100%; box-sizing: border-box; padding: 14px; background: #191F28; border: 2px solid #7274ED; color: #fff; font-size: 16px; border-radius: 12px; text-align: center; margin-bottom: 10px; outline: none; }
        .quiz-input:focus { border-color: #3182F6; }
        .pantry-option { text-align: left; border: 1px solid rgba(255,255,255,0.05); }
        .pantry-tag { font-size: 11px; padding: 3px 6px; border-radius: 4px; font-weight: 700; margin-bottom: 4px; display: inline-block; }
/* [NEW] 캐릭터 말풍선 스타일 */
.speech-bubble {
    position: absolute;
    /* 위치: 캐릭터 좌측 상단 (포스트잇 피함) */
    top: 230px; 
    left: 30px;
    max-width: 140px;
    
    background: #fff;
    color: #000;
    padding: 10px 12px;
    border-radius: 12px;
    border: 2px solid #000;
    font-size: 12px;
    font-weight: 700;
    line-height: 1.4;
    z-index: 14; /* UI(15)보다는 뒤, 캐릭터보다는 앞 */
    box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
    
    /* 팝업 애니메이션 */
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none; /* 클릭 방해 안 함 */
}

/* 말풍선 꼬리 (오른쪽 아래로 향함) */
.speech-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px;
    right: 20px;
    border-width: 8px 8px 0;
    border-style: solid;
    border-color: #fff transparent;
    display: block;
    width: 0;
}
.speech-bubble::before { /* 꼬리 테두리 */
    content: '';
    position: absolute;
    bottom: -11px;
    right: 18px;
    border-width: 9px 9px 0;
    border-style: solid;
    border-color: #000 transparent;
    display: block;
    width: 0;
    z-index: -1;
}
        /* [직급 배지 스타일] */
        .tier-Global { background: rgba(76, 217, 100, 0.2); color: #4CD964; border:1px solid #4CD964; } 
        .tier-Space { background: rgba(255, 99, 71, 0.2); color: #FF6347; border:1px solid #FF6347; }
/* [튜토리얼 스타일] */
#tutorial-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* 배경 어둡게 */
    z-index: 50000; /* 최상단 */
    display: flex; justify-content: center; align-items: center; /* 중앙 정렬 */
}

.tuto-dialog {
    width: auto; margin: 0 24px; max-width: 340px;
    background: #fff; color: #333;
    padding: 24px; border-radius: 20px;
    border: 3px solid #3182F6;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    text-align: left;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.tuto-name { font-size: 15px; font-weight: 900; color: #3182F6; margin-bottom: 10px; display: block; }
.tuto-text { font-size: 17px; line-height: 1.6; color: #222; font-weight: 600; margin-bottom: 25px; min-height: 54px; word-break: keep-all; }
.tuto-next-btn { width: 100%; padding: 14px; background: #191F28; color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
.tuto-next-btn:active { background: #333; transform: scale(0.98); }

/* [플로팅 텍스트 애니메이션] */
@keyframes floatUp {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
    100% { transform: translateY(-40px) scale(1); opacity: 0; }
}

.float-text {
    position: absolute;
    pointer-events: none; /* 클릭 방해 금지 */
    font-family: 'Pretendard', sans-serif;
    font-weight: 900;
    font-size: 20px;
    z-index: 99999; /* 최상단 표시 */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* 가독성 그림자 */
    animation: floatUp 0.8s ease-out forwards;
    white-space: nowrap;
}
/* [면접 팝업 전용 스타일] */
.interview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.interview-question {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    text-align: center;
    margin-bottom: 8px;
    line-height: 1.4;
    word-break: keep-all; /* 단어 단위 줄바꿈 */
}

.interview-hint-badge {
    display: inline-block;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(255, 95, 95, 0.15); /* 붉은색 배경 연하게 */
    color: #FF5F5F;
    margin-bottom: 25px; /* 질문과 버튼 사이 간격 */
    border: 1px solid rgba(255, 95, 95, 0.3);
}

/* 힌트가 파란색일 때(탑티어 이상) 덮어씌울 클래스 */
.hint-blue {
    background: rgba(49, 130, 246, 0.15) !important;
    color: #3182F6 !important;
    border: 1px solid rgba(49, 130, 246, 0.3) !important;
}

/* 답변 버튼 디자인 (메인 테마 적용) */
/* [수정] 면접 답변 버튼 (공통 베이스) */
.interview-btn {
    width: 100%;
    color: #fff;
    padding: 16px 20px;
    margin-bottom: 10px;
    border-radius: 12px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    word-break: keep-all;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    
    /* 기본 배경색 (혹시 모를 대비용) */
    background-color: #333D4B; 
}

/* ★ 첫 번째 버튼: 메인 블루 (Main Blue) */
.interview-btn:nth-child(1) {
    background-color: #3182F6; 
}
.interview-btn:nth-child(1):hover { background-color: #1b64da; }

/* ★ 두 번째 버튼: 인디고 퍼플 (Indigo) - 블루와 유사하면서 세련됨 */
.interview-btn:nth-child(2) {
    background-color: #6B76FF; 
}
.interview-btn:nth-child(2):hover { background-color: #505ce6; }

/* ★ 세 번째 버튼: 딥 민트/틸 (Teal) - 산뜻하고 포인트가 됨 */
.interview-btn:nth-child(3) {
    background-color: #00C4B4; 
}
.interview-btn:nth-child(3):hover { background-color: #00a396; }

/* 눌렀을 때 공통 효과 */
.interview-btn:active {
    transform: scale(0.98);
    opacity: 0.9;
}
/* [스크롤바 디자인 커스텀] */
/* 스크롤바 전체 너비 */
.item-list::-webkit-scrollbar {
    width: 6px; 
}
/* 스크롤바 뒷배경 (트랙) */
.item-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2); 
    border-radius: 4px;
}
/* 움직이는 막대 (썸) */
.item-list::-webkit-scrollbar-thumb {
    background: #555; 
    border-radius: 4px;
}
/* 막대에 마우스 올렸을 때 */
.item-list::-webkit-scrollbar-thumb:hover {
    background: #777; 
}

/* [목록과 스크롤바 사이 간격 확보] */
#inventory-list, #shop-list {
    padding-right: 10px; /* 스크롤바와 내용물이 닿지 않게 여백 추가 */
}
/* [상점 목록 스크롤 강제 적용] */
#shop-list {
    max-height: 300px;   /* 높이를 제한해야 스크롤이 생김 */
    overflow-y: auto;    /* 스크롤바 활성화 */
    padding-right: 10px; /* 내용물과 스크롤바 사이 간격 */
}
/* [토스 스타일 종료 팝업 디자인] */
#exit-popup {
    /* 화면 고정 */
    position: fixed; 
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    
    /* ★ 핵심 1: 맨 위로 올리기 (블러나 다른 UI보다 높게 설정) */
    z-index: 9999 !important; 
    
    /* ★ 핵심 2: 내용물 중앙 정렬 */
    display: flex; 
    justify-content: center; 
    align-items: center; 
    
    /* 배경 어둡게 처리 (선택사항) */
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px); /* 배경 흐림 효과 */
}
/* 1. 팝업 박스 (흰색 카드 형태) */
.popup-content.toss-style {
    background-color: #FFFFFF; /* 흰색 배경 */
    width: 85%;
    max-width: 320px;
    border-radius: 24px; /* 둥글게 (가이드 반영) */
    padding: 24px 20px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    
    /* 중앙 정렬을 위한 설정 (부모 flex 설정 따름) */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* 2. 타이틀 텍스트 */
.popup-title {
    font-size: 20px;
    font-weight: 700;
    color: #191F28; /* 진한 회색 */
    line-height: 1.4;
    margin: 10px 0 30px 0; /* 버튼과의 간격 확보 */
    word-break: keep-all;
}

/* 3. 버튼 그룹 (가로 배치) */
.popup-btn-group {
    display: flex;
    width: 100%;
    gap: 12px; /* 버튼 사이 간격 */
}

/* 4. 버튼 공통 스타일 */
.popup-btn {
    flex: 1; /* 1:1 비율로 꽉 채우기 */
    height: 52px; /* 터치하기 좋은 높이 */
    border-radius: 12px; /* 버튼 모서리 둥글게 */
    font-size: 16px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

/* 5. [닫기] 버튼 (회색 배경) */
.btn-cancel {
    background-color: #F2F4F6; /* 연한 회색 */
    color: #4E5968; /* 중간 회색 텍스트 */
}
.btn-cancel:active {
    background-color: #d1d6db; /* 눌렀을 때 반응 */
}

/* 6. [종료하기] 버튼 (토스 블루) */
.btn-confirm {
    background-color: #3182F6; /* ★ Toss Blue */
    color: #FFFFFF; /* 흰색 텍스트 */
}
.btn-confirm:active {
    background-color: #1b64da; /* 눌렀을 때 반응 */
}

/* [수정] 브릿지 뷰: 토스 스타일의 고급스러운 그라데이션 배경 */
#bridge-view {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 200000; /* 최상단 */
    
    /* 위쪽은 약간 밝은 다크그레이(#3a3a3a), 아래쪽은 게임 배경색(#191F28)으로 자연스럽게 이어짐 */
    background: linear-gradient(180deg, rgba(58, 58, 58, 0.98) 0%, #191F28 100%);
    
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center;
    transition: opacity 0.8s ease-out, visibility 0.8s; /* 부드럽게 사라지는 효과 */
}

/* 로고 박스 (스쿼클 형태) */
.bridge-logo {
    width: 72px; height: 72px;
    background-color: #333; /* 로고 없을 때 배경 */
    border-radius: 22px; /* iOS/토스 스타일 라운드 */
    display: flex; justify-content: center; align-items: center;
    margin: 0 auto 24px auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    overflow: hidden;
}
.bridge-logo img { width: 100%; height: 100%; object-fit: cover; }

/* 텍스트 스타일 */
.bridge-text {
    font-size: 22px; font-weight: 700; color: #fff;
    line-height: 1.4; text-align: center; margin: 0;
    font-family: 'Pretendard', sans-serif;
    opacity: 0; animation: fadeUp 0.8s ease-out 0.2s forwards;
}
.highlight { color: #3182F6; } /* 토스 블루 포인트 */

/* [수정] 연령 등급 배지: 인트로 화면 우측 상단 고정 */
.rating-badge-mini {
    position: absolute; 
    /* 아이폰 노치 영역만큼 띄워줌 + 기본 여백 20px */
    top: calc(20px + env(safe-area-inset-top)); 
    right: 20px;
    z-index: 10;
    
    /* 배경이나 테두리 없이 깔끔하게 이미지만 보여줌 */
    background: none; 
    border: none;
    padding: 0;
    
    /* (선택사항) 살짝 떠있는 느낌을 주는 그림자 */
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
}

/* 등급 이미지 크기 조절 */
.rating-badge-mini img {
    width: 54px; /* 너무 크지 않게 적당한 크기 */
    height: auto;
    object-fit: contain;
}


/* 애니메이션 및 숨김 처리 */
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* [필수] 브릿지 뷰 숨김 처리용 클래스 (없으면 추가하세요!) */
.bridge-hidden {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important; /* 클릭 통과시키기 */
}

@keyframes bridgeFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* [토스 스타일 커스텀 알림창] */
#custom-alert-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); z-index: 999999;
    align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
    opacity: 0; transition: opacity 0.2s;
}
#custom-alert-box {
    background: #fff; width: 85%; max-width: 320px;
    border-radius: 24px; padding: 24px; text-align: center;
    transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
#custom-alert-msg {
    font-size: 17px; color: #333; line-height: 1.5; margin-bottom: 24px; font-weight: 600; word-break: keep-all;
}
#custom-alert-btn {
    width: 100%; padding: 16px; background: #3182F6; color: #fff;
    border: none; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer;
}
#custom-alert-btn:active { background: #1b64da; transform: scale(0.98); }

/* 활성화 클래스 */
.alert-active { display: flex !important; opacity: 1 !important; }
.alert-active #custom-alert-box { transform: scale(1) !important; }

/* =========================================
   [통합] 토스 스타일 버튼 터치 효과 (손맛)
   ========================================= */

/* 1. 모든 버튼류에 부드러운 애니메이션 적용 */
button, 
.menu-btn, .action-btn, .card-btn, 
.full-btn, .btn-buy, .btn-action, .btn-ad, .btn-apply, 
.close-btn, .btn-gear, .popup-btn, #custom-alert-btn {
    /* 쫀득한 텐션 (눌렀다 뗄 때 찰랑거리는 느낌) */
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s;
    transform-origin: center center;
    cursor: pointer;
    /* 모바일에서 터치 하이라이트(파란 박스) 제거 */
    -webkit-tap-highlight-color: transparent; 
}

/* 2. 눌렀을 때 (Active) 공통 효과 */
button:active, 
.menu-btn:active, .action-btn:active, .card-btn:active, 
.full-btn:active, .btn-buy:active, .btn-action:active, .btn-ad:active, .btn-apply:active, 
.close-btn:active, .btn-gear:active, .popup-btn:active, #custom-alert-btn:active {
    /* 0.96배로 살짝 축소 (너무 작아지면 촌스러움) */
    transform: scale(0.96) !important;
    
    /* 아주 살짝 어두워져서 눌린 깊이감 표현 */
    filter: brightness(0.92);
}

/* [예외 처리] 톱니바퀴 설정 버튼은 회전 효과 유지 */
.btn-gear:active {
    transform: scale(0.9) rotate(90deg) !important;
}


/* [수정] 로그 메시지 레이어 (위치 조정) */
#scene-message-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; 
    z-index: 105;
    
    display: flex; flex-direction: column; 
    
    /* ★ 핵심 수정: 중앙(center)이 아니라 하단(flex-end) 정렬 */
    justify-content: flex-end; 
    align-items: center;
    
    /* 바닥에서 어느 정도 띄울지 설정 (캐릭터 발 아래 위치) */
    padding-bottom: 150px; 
    box-sizing: border-box;
}

/* [수정] 대화창 스타일 (다크 모드 적용) */
.scene-message-box {
    /* ★ 핵심 1: 배경을 어두운 색(#222~#333 계열) + 반투명으로 변경 */
    background: rgba(33, 37, 45, 0.95); 
    
    /* ★ 핵심 2: 아주 얇은 흰색 테두리를 줘서 배경과 구분감(고급짐)을 줌 */
    border: 1px solid rgba(255, 255, 255, 0.15);
    
    backdrop-filter: blur(12px); /* 블러 효과 */
    padding: 24px 30px;
    border-radius: 24px; 
    
    /* 그림자를 좀 더 진하게 줘서 떠있는 느낌 강조 */
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
    
    max-width: 80%;
    text-align: center;
    transform: none; 
    
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 텍스트 스타일 */
#scene-msg-text {
    font-size: 18px; 
    font-weight: 700; 
    
    /* ★ 핵심 3: 글씨색을 밝은 흰색으로 변경 */
    color: #FFFFFF; 
    
    line-height: 1.5;
    word-break: keep-all;
    letter-spacing: -0.5px; /* 자간 미세 조정 */
}

/* ▼▼▼ [추가] 어워드 팝업 스타일 ▼▼▼ */
#award-popup {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.9); z-index: 30000;
    justify-content: center; align-items: center; overflow: hidden;
}

/* 빙글빙글 돌아가는 후광 */
.award-ray {
    position: absolute; width: 200%; height: 200%;
    background: repeating-conic-gradient(#FFD700 0% 5%, transparent 5% 10%);
    animation: rotateRay 10s linear infinite; opacity: 0.2;
}
@keyframes rotateRay { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.award-content {
    position: relative; width: 85%; max-width: 340px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #FFD700; border-radius: 20px;
    padding: 30px 20px; text-align: center;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    animation: popInBounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}
@keyframes popInBounce { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }

.award-header { color: #FFD700; font-size: 14px; font-weight: 900; letter-spacing: 2px; margin-bottom: 20px; }
.award-icon { 
    font-size: 80px; 
    margin-bottom: 10px; 
    filter: drop-shadow(0 0 10px rgba(255,215,0,0.5)); 
    /* 애니메이션 줄 삭제됨 */
}.award-title { color: #fff; font-size: 24px; font-weight: 800; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.award-score { color: #888; font-size: 13px; margin-bottom: 25px; }

.award-prize-box { background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
.prize-label { color: #FFD700; font-size: 11px; font-weight: 700; letter-spacing: 1px; margin-bottom: 4px; }
.prize-amount { color: #fff; font-size: 22px; font-weight: 900; }

.award-btn { background: #FFD700 !important; color: #000 !important; font-weight: 900 !important; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); border:none; }
.award-btn:active { transform: scale(0.95); }
/* ▼▼▼ [추가] 두근두근 심장박동 애니메이션 ▼▼▼ */
@keyframes heartBeat {
    0% { transform: scale(1); }
    15% { transform: scale(1.3); }
    30% { transform: scale(1); }
    45% { transform: scale(1.15); }
    60% { transform: scale(1); }
}
.heart-effect {
    animation: heartBeat 1.2s infinite;
}

/* [추가] 면접 반응판 전용 스타일 */
#interview-stats-display {
    transition: all 0.3s ease;
    min-width: 120px; /* 최소 너비 확보 */
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

/* 반응이 갱신될 때 깜빡이는 효과 */
.reaction-pop {
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: rgba(255, 255, 255, 0.1) !important; /* 배경 살짝 밝게 */
    border: none !important;
}

/* ▼▼▼ [추가] AI 라이벌 모드 (위험 연출) ▼▼▼ */
.project-widget.rival-mode {
    background: linear-gradient(135deg, #3a0000 0%, #1a0000 100%) !important; /* 검붉은 배경 */
    border: 2px solid #FF5F5F !important; /* 빨간 테두리 */
    box-shadow: 0 0 15px rgba(255, 95, 95, 0.4) !important;
    animation: pulseRed 1.5s infinite alternate !important; /* 두근두근 효과 */
}
.project-widget.rival-mode h4 { color: #FF5F5F !important; } /* 제목 빨간색 */
.project-widget.rival-mode .pw-title { color: #fff !important; }
.project-widget.rival-mode .pw-bar-fill { background: #FF5F5F !important; } /* 게이지 빨간색 */

@keyframes pulseRed {
    0% { transform: rotate(2deg) scale(1); box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
    100% { transform: rotate(2deg) scale(1.02); box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
}

.rival-target-score {
    background: rgba(0, 0, 0, 0.5);
    color: #FF5F5F;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    margin-top: 5px;
    display: flex; justify-content: space-between;
}
/* ▼▼▼ [교체] 결과 팝업 스타일 (Ver 99.2 Fix) ▼▼▼ */
.result-card {
    background: #191F28;
    width: 80%; max-width: 280px; /* 슬림하게 */
    padding: 30px 20px;
    border-radius: 20px;
    text-align: center; /* 전체 중앙 정렬 */
    position: relative;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    display: flex; flex-direction: column; align-items: center;
    animation: slideUpFade 0.3s ease-out;
}

/* 헤더 뱃지 */
.result-header { margin-bottom: 25px; width: 100%; display: flex; justify-content: center; }
#result-type-badge {
    font-size: 10px; font-weight: 800; letter-spacing: 2px;
    text-transform: uppercase; color: #555;
    background: #222; padding: 4px 8px; border-radius: 4px;
}

/* 도장 박스 (높이 확보) */
.result-stamp-box {
    width: 100%; height: 60px; /* 공간 확보 */
    display: flex; justify-content: center; align-items: center;
    margin-bottom: 10px;
    position: relative;
}

/* ★ 도장 텍스트 스타일 (무조건 보이게 설정) */
.result-stamp-text {
    font-size: 32px; font-weight: 900;
    border: 4px solid;
    padding: 5px 15px;
    border-radius: 10px;
    transform: rotate(-10deg);
    text-transform: uppercase;
    display: inline-block;
    
    /* 애니메이션: 쾅! 찍히는 효과 */
    animation: stampCrash 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    opacity: 0; /* 시작은 투명 */
}

@keyframes stampCrash {
    0% { transform: scale(3) rotate(-10deg); opacity: 0; }
    100% { transform: scale(1) rotate(-10deg); opacity: 1; } /* 끝나면 불투명 */
}

/* 성공(파랑) / 실패(빨강) 테마 */
.res-success .result-stamp-text { color: #3182F6; border-color: #3182F6; }
.res-fail .result-stamp-text { color: #FF5F5F; border-color: #FF5F5F; }

/* 제목 (중앙 정렬) */
#result-title {
    margin: 10px 0 20px 0;
    font-size: 18px; font-weight: 700; color: #fff;
    width: 100%; text-align: center; word-break: keep-all;
    line-height: 1.4;
}

/* 점수표 */
.result-stats {
    width: 100%; background: rgba(0,0,0,0.3);
    border-radius: 12px; padding: 15px; margin-bottom: 20px;
    box-sizing: border-box;
}
.stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }
.stat-row:last-child { margin-bottom: 0; }


/* ▼▼▼ [수정] AI 라이벌 컷신 스타일 (Ver 99.4: 대화창 슬림화) ▼▼▼ */
.rival-bg-img {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0;
    animation: dramaFadeIn 2s forwards, slowZoom 10s infinite alternate;
}

@keyframes dramaFadeIn { to { opacity: 1; } }
@keyframes slowZoom { from { transform: scale(1); } to { transform: scale(1.1); } }

.rival-dialog-box {
    position: absolute;
    bottom: 30px; /* 하단 위치 살짝 조정 */
    left: 20px; right: 20px;
    background: rgba(0, 0, 0, 0.85);
    border: 1px solid #FF5F5F;
    border-radius: 16px;
    padding: 15px; /* 패딩 감소 (25 -> 15) */
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    animation: slideUpFade 0.5s ease-out 1s backwards;
}

.rival-speaker {
    color: #FF5F5F;
    font-size: 13px; font-weight: 800;
    margin-bottom: 5px; /* 마진 감소 */
    letter-spacing: 1px;
    text-transform: uppercase;
}

.rival-text {
    color: #fff;
    font-size: 15px;
    line-height: 1.3; /* 줄 간격 촘촘하게 */
    font-weight: 600;
    /* min-height: 50px;  <-- 삭제 (불필요한 공간 제거) */
    margin-bottom: 10px; /* 마진 감소 */
    word-break: keep-all;
}

.rival-mission-info {
    border-top: 1px dashed rgba(255,255,255,0.2);
    padding-top: 10px; /* 패딩 감소 */
    margin-bottom: 10px; /* 마진 감소 */
    display: flex; justify-content: space-between; align-items: center;
    font-weight: 700; color: #888; font-size: 12px;
}

/* 버튼 슬림하게 수정 */
.rival-dialog-box .rival-btn {
    background: #FF5F5F !important;
    border: none;
    font-weight: 800;
    box-shadow: 0 4px 15px rgba(255, 95, 95, 0.4);
    padding: 12px; /* 패딩 줄임 */
    height: auto; /* 높이 자동 조절 */
    font-size: 15px; /* 글씨 크기 살짝 줄임 */
}


/* ▼▼▼ [필수] 미니게임 통합 스타일 (트랙, 빨간선, 상자) ▼▼▼ */

/* 1. 게임 트랙 (배경) */
.game-track-container {
    position: relative !important; /* 기준점 */
    width: 100%;
    height: 60px;
    background: #e0e0e0; /* 연한 회색 */
    border: 2px solid #333;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
}

/* 2. 빨간 기준선 (중앙) - ★ 이게 없어서 안 보였던 것! */
.center-line {
    position: absolute !important;
    left: 50%;
    top: 0; 
    bottom: 0;
    width: 4px; /* 잘 보이게 두께 4px로 키움 */
    background-color: #FF0000; /* 새빨간색 */
    transform: translateX(-50%); /* 정확히 중앙 정렬 */
    z-index: 10; /* 상자보다 뒤에 위치 */
}

/* 3. 움직이는 검은 상자 */
.moving-block {
    position: absolute !important;
    top: 10px; 
    bottom: 10px;
    width: 20px;
    background: #333;
    left: 0;
    border-radius: 4px;
    z-index: 20; /* 선보다 앞에 위치 */
    transition: none !important; /* 부드러운 움직임 필수 */
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
}

/* ▼▼▼ [수정] 위기 상황 스타일 (난이도/레이아웃 개선) ▼▼▼ */
.save-bar-container {
    width: 100%;
    height: 36px; /* 높이 조금 키움 */
    background: rgba(0,0,0,0.4);
    border: 3px solid #fff;
    border-radius: 18px;
    position: relative;
    overflow: hidden;
    margin: 0 auto; /* 중앙 정렬 */
}

.save-bar-fill {
    width: 50%;
    height: 100%;
    background: #4CD964;
    transition: width 0.05s linear; /* 반응 속도 더 빠르게 */
}

#save-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 14px;
    font-weight: 800;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    white-space: nowrap;
}

/* 연타 버튼 눌림 효과 강화 */
#mash-btn:active {
    transform: scale(0.96) translateY(4px);
    box-shadow: 0 2px 0 #005a9e !important;
}

/* [추가] 마감 연장 성공 팝업 스타일 */
#extension-success-popup {
    text-align: center;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%); /* 고급진 배경 */
    border: 1px solid #7274ED; /* 포인트 컬러 (보라색 계열) */
}

/* 통화 아이콘 애니메이션 */
.call-anim-icon {
    font-size: 50px;
    background: #4CD964; /* 통화 성공 녹색 */
    width: 80px; height: 80px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px;
    box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7);
    animation: pulseGreen 1.5s infinite;
}

@keyframes pulseGreen {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

/* 클라이언트 말풍선 */
.client-bubble-box {
    background: #fff;
    color: #333;
    padding: 15px 20px;
    border-radius: 20px;
    border-bottom-left-radius: 2px; /* 말풍선 꼬리 느낌 */
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}
.client-bubble-box::after { /* 말풍선 꼬리 */
    content: ''; position: absolute; bottom: -8px; left: 10px;
    border-width: 10px 10px 0; border-style: solid;
    border-color: #fff transparent; display: block; width: 0;
}

.client-name { font-size: 12px; font-weight: 800; color: #7274ED; margin-bottom: 5px; display: block; }
.client-text { font-size: 15px; font-weight: 600; line-height: 1.5; word-break: keep-all; }

/* --- [수정] 결과 배지 스타일 시작 --- */

/* 1. 배지를 감싸는 컨테이너 */
.result-badge-row {
    display: flex;        /* 가로 배열 */
    width: 100%;          /* 팝업 너비 꽉 채우기 */
    gap: 10px;            /* 배지 사이 간격 */
    margin-bottom: 25px;
}

/* 2. 배지 공통 구조 (여기가 핵심!) */
.res-badge {
    /* ★ 핵심: flex: 1을 주어 두 배지가 공간을 정확히 반반씩 나눠가짐 (대칭) */
    flex: 1;

    /* 내부 콘텐츠 정렬 */
    display: flex;
    justify-content: center; /* 텍스트 가운데 정렬 */
    align-items: center;
    gap: 6px;             /* 아이콘-텍스트 간격 */

    /* 모양 및 크기 */
    padding: 12px 0;      /* 상하 패딩으로 높이 조절 */
    border-radius: 10px;  /* 둥근 모서리 */
    border: none;         /* 테두리 제거 */

    /* 텍스트 스타일 */
    font-size: 14px;
    font-weight: 700;
    letter-spacing: -0.3px;
    white-space: nowrap;  /* 텍스트 한 줄 유지 */
}

/* 3. 초록색 (성공) 배경 및 글씨색 */
.badge-green {
    background-color: rgba(76, 217, 100, 0.15); /* 연한 초록 배경 */
    color: #4CD964; /* 진한 초록 글씨 */
}

/* 4. 붉은색 (경고) 배경 및 글씨색 */
.badge-red {
    background-color: rgba(255, 95, 95, 0.15); /* 연한 빨강 배경 */
    color: #FF5F5F; /* 진한 빨강 글씨 */
}
/* --- 결과 배지 스타일 끝 --- */

/* [신규] 면접 결과 팝업 스타일 */
#interview-result-popup {
    text-align: center;
    align-items: center;
    justify-content: center;
    background: transparent; /* 배경 투명 (카드만 보이게) */
    box-shadow: none;
    border: none;
    overflow: visible;
}

/* 공통 카드 디자인 */
.result-card-box {
    width: 100%;
    background: #191F28;
    border-radius: 24px;
    padding: 30px 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 상단 아이콘 박스 */
.result-icon-box {
    width: 70px; height: 70px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    margin-bottom: 20px;
    margin-top: -50px; /* 카트 위로 튀어나오게 */
    background: #333;
    border: 4px solid #191F28; /* 배경색과 맞춰서 구멍 뚫린 느낌 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

/* 텍스트 스타일 */
.res-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; color: #fff; }
.res-subtitle { font-size: 14px; font-weight: 600; color: #B0B8C1; margin-bottom: 20px; }
.res-desc-box {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 20px;
}
.res-message { font-size: 15px; line-height: 1.5; color: #fff; font-weight: 500; word-break: keep-all; }
.res-sub-message { font-size: 12px; color: #FF5F5F; margin-top: 8px; font-weight: 700; }

/* 성공 테마 */
.theme-success .result-icon-box { background: #3182F6; color: #fff; box-shadow: 0 0 20px rgba(49, 130, 246, 0.5); }
.theme-success .res-title { color: #3182F6; }
.theme-success { border: 1px solid #3182F6; }

/* 실패 테마 */
.theme-fail .result-icon-box { background: #FF5F5F; color: #fff; box-shadow: 0 0 20px rgba(255, 95, 95, 0.5); }
.theme-fail .res-title { color: #FF5F5F; }
.theme-fail { border: 1px solid #FF5F5F; }


/* [신규] 박물관 그리드 레이아웃 */
.museum-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2열 배치 */
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px; /* 스크롤바 공간 */
}

/* 박물관 아이템 카드 */
.museum-item {
    background: #2C3038;
    border: 1px solid #444;
    border-radius: 12px;
    padding: 15px 10px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 130px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: transform 0.1s;
}

/* 획득한 유물 스타일 */
.museum-item.acquired {
    border: 1px solid #FFD700;
    background: linear-gradient(135deg, #2C3038 0%, #3D3520 100%);
}

/* 빈 슬롯 스타일 */
.museum-item.empty {
    border: 1px dashed #555;
    background: rgba(0,0,0,0.2);
    opacity: 0.4;
}

/* 유물 아이콘 */
.artifact-icon {
    font-size: 36px;
    margin-bottom: 8px;
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
}

/* 유물 이름 */
.artifact-name {
    font-size: 13px;
    font-weight: 800;
    color: #FFD700;
    margin-bottom: 4px;
    word-break: keep-all;
    line-height: 1.3;
}

/* 유물 설명 */
.artifact-desc {
    font-size: 10px;
    color: #aaa;
    line-height: 1.3;
    word-break: keep-all;
}
/* [신규] 박물관 가이드 박스 스타일 */
.museum-guide-box {
    background: rgba(255, 215, 0, 0.1); /* 금색 배경 연하게 */
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    margin-bottom: 5px;
}

.museum-guide-box p {
    font-size: 13px;
    color: #ccc;
    line-height: 1.5;
    margin: 0;
    word-break: keep-all;
}

/* [신규] SSS급 인트로 스타일 */
.sss-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 50000; /* 최상단 */
    background: #000;
    display: flex; flex-direction: column; justify-content: flex-end;
}

/* 배경 이미지 (서서히 줌인 효과) */
.sss-bg-img {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.6; /* 텍스트 가독성을 위해 살짝 어둡게 */
    animation: fadeInZoom 3s forwards ease-out;
}

@keyframes fadeInZoom {
    0% { opacity: 0; transform: scale(1); }
    100% { opacity: 1; transform: scale(1.05); }
}

/* 텍스트 콘텐츠 박스 */
.sss-content {
    position: relative; z-index: 1;
    padding: 30px;
    background: linear-gradient(to top, rgba(0,0,0,1) 10%, rgba(0,0,0,0) 100%);
    text-align: center;
    padding-bottom: 50px;
}

/* 타이틀 (위에서 떨어짐) */
.sss-title {
    font-size: 32px; font-weight: 900; color: #fff;
    text-transform: uppercase; letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(49, 130, 246, 0.8); /* 파란 네온 */
    margin-bottom: 10px;
    opacity: 0; animation: slideDownFade 0.8s 0.5s forwards;
}

/* 서브타이틀 */
.sss-subtitle {
    font-size: 14px; color: #B0B8C1; margin-bottom: 30px;
    letter-spacing: 4px;
    opacity: 0; animation: fadeIn 1s 1s forwards;
}

/* 대사 박스 */
.sss-dialog {
    background: rgba(255, 255, 255, 0.1);
    border-left: 4px solid #FF5F5F;
    padding: 15px;
    text-align: left;
    font-size: 14px; color: #ddd;
    line-height: 1.6;
    margin-bottom: 30px;
    border-radius: 4px;
    opacity: 0; animation: slideUpFade 0.8s 1.5s forwards;
}

/* 시작 버튼 (깜빡임 효과) */
.sss-start-btn {
    background: #fff !important; color: #000 !important;
    font-weight: 900 !important; font-size: 18px !important;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    opacity: 0; animation: popIn 0.5s 2.5s forwards, blinkBtn 2s infinite 3s;
}

@keyframes slideDownFade { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideUpFade { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes blinkBtn { 0% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.9); } 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); } }

/* =========================================================
   🔒 [출시용] 치트 및 테스트 버튼 완전 숨김 (CSS 강제 적용)
   자바스크립트보다 먼저 적용되어 깜빡임 현상이 100% 사라집니다.
   ========================================================= */
#cheat-panel,              /* 왼쪽 아래 치트 패널 */
.debug-btn,                /* 상단/중간 디버그 버튼들 */
button[onclick*="cheat"],  /* 클릭 기능에 'cheat'가 들어간 모든 버튼 */
button[onclick*="test"],   /* 클릭 기능에 'test'가 들어간 모든 버튼 */
button[onclick*="resetGameData"] /* 초기화 버튼 (설정창 포함) */
{
    display: none !important;
}

/* style 태그 맨 끝에 추가 */
canvas { display: block !important; width: 100% !important; height: 100% !important; }


    </style>

</head>
<body>
    <div id="game-container">

<div id="custom-alert-overlay">
    <div id="custom-alert-box">
        <div id="custom-alert-msg">알림 내용</div>
        <button id="custom-alert-btn" onclick="closeCustomAlert()">확인</button>
    </div>
</div>
<div id="scene-message-layer" style="display:none;">
    <div class="scene-message-box">
        <div id="scene-msg-text">텍스트가 들어갑니다.</div>
    </div>
</div>

<div id="intro-layer" onclick="startGame()">
    <img src="assets/intro_bg.png" class="intro-bg" alt="배경">
    

    <div class="logo-container">
        <img src="assets/intro_logo.png" class="intro-logo" alt="로고">
        <p class="intro-subtitle">레벨업 디자이너</p>
    </div>
    <p class="start-msg">터치하여 시작하기</p>
</div>

        <div id="ui-layer" style="display:none;">
            <button class="debug-btn" style="display:block;" onclick="testEnding()">🎬 엔딩 테스트</button>

<div class="top-bar">
    <div class="top-row">
        <button class="btn-gear" onclick="openPopup('settings-popup')">⚙️</button>
        <span id="ui-week">1년 1월 1주</span>
    </div>

    <div class="money-row">
        <span id="ui-money">500,000</span>
    </div>

    <div class="bar-container">
        <span class="bar-label">HP</span>
        <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="width:100%"></div></div>
    </div>
    <div class="bar-container">
        <span class="bar-label">Lv.<span id="ui-lv">1</span></span>
        <div class="bar-bg"><div id="exp-bar" class="bar-fill" style="width:0%"></div></div>
    </div>
    <div class="bar-container">
        <span class="bar-label">PF</span>
        <div class="bar-bg"><div id="pf-bar" class="bar-fill" style="width:0%"></div></div>
    </div>
    <div id="ui-deadline"></div>
</div>

            <div class="menu-bar">
                <button class="menu-btn" onclick="renderShop(); openPopup('shop-popup');">🛒 상점</button>
                <button class="menu-btn" onclick="renderInventory(); openPopup('inventory-popup');">🎒 장비</button>
                <button class="menu-btn" onclick="renderHistory(); openPopup('portfolio-popup');">📂 포폴</button>
                <button class="menu-btn" id="btn-job" onclick="openJobMarket(); openPopup('job-popup');">💼 취업</button>
            </div>

            <div class="bottom-area">
                <div class="log-box">
                    <span id="log-text">레벨 업! 디자이너 Start</span>
                </div>
                
                <div class="action-grid">
                    <button class="action-btn btn-skill" data-icon="⚡" onclick="openPopup('skill-popup')"><div>스킬 업</div><span>능력치 상승</span></button>
                    <button class="action-btn btn-project" id="btn-work" data-icon="💼" onclick="handleProjectButton()"><div>새 프로젝트</div><span>포트폴리오</span></button>
                    <button class="action-btn btn-alba" data-icon="💸" onclick="openAlbaPopup()"><div>알바하기</div><span>돈 벌기</span></button>
                    <button class="action-btn btn-rest" data-icon="🛌" onclick="openPopup('rest-popup')"><div>휴식하기</div><span>체력 회복</span></button>
                </div>
            </div>
        </div>

        <div id="phase2-ui-layer">
           <button class="debug-btn" style="display:block; top: 280px; background: rgba(50, 100, 255, 0.8);" onclick="testNextTier()">🚀 티어 상승 (테스트)</button>
<div class="top-bar">
    <div class="top-row">
        <button class="btn-gear" onclick="openPopup('settings-popup')">⚙️</button>
        <span id="p2-ui-week">1년 1월 1일</span>
    </div>

    <div class="money-row">
        <span id="p2-ui-money">2,500,000</span>
        <div id="p2-rank-badge" class="rank-badge">사원 (Agency)</div>
    </div>

    <div class="bar-container">
        <span class="bar-label">멘탈</span>
        <div class="bar-bg"><div id="p2-mental-bar" class="bar-fill" style="width:100%"></div></div>
    </div>
    <div class="bar-container">
        <span class="bar-label">Lv.<span id="p2-ui-lv">1</span></span>
        <div class="bar-bg"><div id="p2-skill-bar" class="bar-fill" style="width:0%"></div></div>
    </div>
    <div class="bar-container">
        <span class="bar-label">성과</span>
        <div class="bar-bg"><div id="p2-perf-bar" class="bar-fill" style="width:0%"></div></div>
    </div>
</div>

            <div id="p2-project-widget" class="project-widget">
                <h4>Current Project</h4>
                <span class="pw-title" id="pw-title">대기중...</span>
                <div class="pw-info"><span>마감 D-<span id="pw-day">0</span></span><span id="pw-percent">0%</span></div>
                <div class="pw-bar-bg"><div id="pw-bar" class="pw-bar-fill"></div></div>
                <div id="pw-stamp" class="pw-stamp">반려됨!</div>
                
                <button id="pw-extend-btn" style="display:none; width:100%; background:#FF5F5F; color:#fff; border:none; border-radius:4px; padding:5px; font-size:11px; font-weight:bold; margin-top:8px; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onclick="openExtensionPopup()">
                    📞 제발... 기한 연장
                </button>
            </div>

<div class="menu-bar" style="gap: 4px;"> 
    
    <button class="menu-btn" onclick="renderShop(); openPopup('shop-popup');">
        🛒 상점
    </button>
    
    <button class="menu-btn" onclick="renderInventory(); openPopup('inventory-popup');">
        🎒 장비
    </button>

    <button id="btn-museum" class="menu-btn" onclick="openMuseum()" style="display: none; border: 1px solid #FFD700; color:#FFD700;">
        🏛️ 박물관
    </button>

    <button class="menu-btn" onclick="openHallOfFame()">
        🏆 명예
    </button>

    <button class="menu-btn" onclick="openJobMarket(); openPopup('job-popup');">
        🚀 이직
    </button>
</div>

            <div class="bottom-area">
                <div class="log-box">
                    <span id="p2-log-text">신입 디자이너로 첫 출근했습니다!</span>
                </div>
                
                <div class="action-grid">
                    <button class="action-btn btn-skill" data-icon="📚" onclick="openP2SkillPopup()">
                        <div>자기 계발</div><span>스킬 상승</span>
                    </button>

                    <button class="action-btn btn-project" data-icon="🖥️" onclick="doP2Work()"><div>업무 수행</div><span>성과 상승</span></button>
                    <button class="action-btn btn-social" data-icon="🤝" onclick="openSocialPopup()"><div>사회생활</div><span>정치/처세술</span></button>
                    <button class="action-btn btn-rest" data-icon="☕" onclick="openP2RestPopup()"><div>휴식 하기</div><span>멘탈 회복</span></button>
                </div>
            </div>
        </div>
<div id="interview-popup" class="popup" style="z-index: 11000; background: #191F28; border: 1px solid #333;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #333;">
        <h2 style="margin:0; color:#fff; font-size:18px;">👔 면접 진행 중</h2>
        <div style="background:rgba(0,0,0,0.4); padding:6px 12px; border-radius:15px; font-size:13px; border:1px solid #444;">
            <span id="interview-stats-display">🔥10 | 🧠10 | ✨10</span>
        </div>
    </div>

    <div class="interview-container">
        <div style="font-size:48px; margin-bottom:15px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));">
            👤
        </div>
        
        <div id="interview-q-text" class="interview-question">
            질문 로딩 중...
        </div>

        <div id="interview-q-hint" class="interview-hint-badge">
            목표: 열정을 보여주세요!
        </div>
    </div>

    <div id="interview-answers" style="display:flex; flex-direction:column; gap:0; margin-top:10px;">
        </div>
</div>
<div id="suspense-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:40000; flex-direction:column; justify-content:center; align-items:center; color:#fff;">
    <div style="font-size:60px; margin-bottom:20px;">💓</div>
    <div id="suspense-text" style="font-size:18px; font-weight:700; text-align:center; line-height:1.6;">
        면접관들이 상의 중입니다...
    </div>
</div>

<div id="interview-result-popup" class="popup" style="z-index: 12000;">
    <div id="interview-result-card" class="result-card-box">
        <div id="res-icon" class="result-icon-box">🎉</div>
        
        <h2 id="res-title" class="res-title">합격 축하합니다!</h2>
        <div id="res-company" class="res-subtitle">Tooss 채용팀</div>
        
        <div class="res-desc-box">
            <div id="res-msg" class="res-message">
                "귀하의 뛰어난 역량을 높이 평가하여<br>최종 합격을 통보합니다."
            </div>
            <div id="res-sub-msg" class="res-sub-message"></div>
        </div>

        <div id="res-btn-area" style="width: 100%;">
            </div>
    </div>
</div>

<div id="award-popup">
    <div class="award-ray"></div> <div class="award-content">
        <div class="award-header">✨ ANNUAL DESIGN AWARDS ✨</div>
        <div class="award-icon" id="award-icon">🏆</div>
        <div class="award-title" id="award-title">대상 (Grand Prix)</div>
        <div class="award-score">최고 점수: <span id="award-score-val">0</span>점</div>
        
        <div class="award-prize-box">
            <div class="prize-label">TOTAL PRIZE</div>
            <div class="prize-amount" id="award-money">₩ 500,000,000</div>
        </div>

        <button class="full-btn award-btn" onclick="claimAward()">상금 수령하기</button>
    </div>
</div>

<div id="result-popup" class="popup" style="z-index: 22000; background: transparent; box-shadow: none; border: none; align-items: center; justify-content: center;">
    
    <div class="result-card">
        <div class="result-header">
            <span id="result-type-badge">PROJECT REPORT</span>
        </div>

        <div class="result-stamp-box">
            <div id="result-stamp" class="result-stamp-text">APPROVED</div>
        </div>

        <h2 id="result-title">결과 제목</h2>

        <div id="result-stat-box" class="result-stats">
            </div>

        <button class="full-btn" onclick="closeResultPopup()">확인</button>
    </div>
</div>

<div id="rival-intro-layer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: 40000; background:#000;">
    
    <img src="assets/ai.png" class="rival-bg-img" alt="AI Rival Art">

    <div class="rival-dialog-box">
        <div class="rival-speaker">🤖 Alpha-D</div>
        <div id="rival-typing-text" class="rival-text">
            </div>
        
        <div class="rival-mission-info">
            <span>TARGET SCORE</span>
            <span id="rival-intro-target" style="color:#FF5F5F; font-size:20px;">0</span>
        </div>

        <button class="full-btn rival-btn" onclick="closeRivalIntro()">도전 수락 (Accept)</button>
    </div>
</div>

<div id="rival-warning-popup" class="popup" style="z-index: 45000; background: rgba(20, 0, 0, 0.95); border: 2px solid #FF5F5F; box-shadow: 0 0 50px rgba(255, 95, 95, 0.3); 
    display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
    
    <div style="font-size: 50px; margin-bottom: 20px;">🚨</div>
    
    <h2 style="color: #FF5F5F; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; width: 100%; text-align: center;">SYSTEM WARNING</h2>
    
    <p style="color: #fff; font-size: 16px; line-height: 1.6; font-weight: 600; word-break: keep-all; width: 100%; text-align: center;">
        "경쟁사가 AI 시스템을 가동했습니다."<br>
        <span style="color: #FF5F5F; font-size: 14px;">(감지된 개체: Alpha-D)</span>
    </p>
    
    <button class="full-btn" onclick="confirmRivalWarning()" style="background: #FF5F5F; color: #fff; font-weight: 800; margin-top: 20px; border: none; box-shadow: 0 4px 15px rgba(255, 95, 95, 0.4); width: 100%;">
        확인 (진입)
    </button>
</div>
<div id="sss-intro-layer" class="sss-layer" style="display:none;">
    <img src="assets/sss_intro.png" class="sss-bg-img" alt="Final Battle">
    
    <div class="sss-content">
        <div class="sss-title">PROJECT:<br>SINGULARITY</div>
        <div class="sss-subtitle">"HUMAN vs AI: The Final Test"</div>
        
        <div class="sss-dialog">
            <span style="color:#FF5F5F; font-weight:800;">🤖 Alpha-D:</span><br>
            "박물관이 완성되었군요.<br>
            하지만 이것만으론 부족합니다.<br>
            <br>
            저에게 당신의 <span style="color:#fff; text-decoration:underline;">영혼</span>을 증명하십시오."
        </div>

        <button class="full-btn sss-start-btn" onclick="startSSSProject()">
            ⚡ 최후의 프로젝트 시작
        </button>
    </div>
</div>


        <div id="modal-overlay"></div>
        <div id="shop-popup" class="popup"><button class="close-btn" onclick="closePopup()">×</button><h2>장비 상점</h2><ul id="shop-list" class="item-list"></ul></div>
<div id="inventory-popup" class="popup" style="min-height: 400px;">
    
    <div id="inv-view-list">
        <button class="close-btn" onclick="closePopup()">×</button>
        <h2>내 장비</h2>
        <p style="color:#8B95A1; font-size:12px; margin-bottom:10px;">아이템을 클릭하여 상세 정보를 확인하세요.</p>
        <ul id="inventory-list" class="item-list" style="max-height:300px; overflow-y:auto;">
            </ul>
    </div>

    <div id="inv-view-detail" style="display:none; text-align:center; animation: fadeIn 0.3s;">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button onclick="backToInventory()" style="background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer; padding:0; margin-right:10px;">
                ←
            </button>
            <h2 style="margin:0; font-size:18px;">장비 상세</h2>
        </div>

        <div style="background: #333D4B; border-radius: 16px; padding: 30px; margin-bottom: 20px; display:flex; flex-direction:column; align-items:center; box-shadow: inset 0 0 20px rgba(0,0,0,0.2);">
            <img id="inv-detail-img" src="" style="width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); margin-bottom:15px;">
            <div id="inv-detail-name" style="font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 5px;">이름</div>
            <div id="inv-detail-power" style="font-size: 14px; color: #3182F6; font-weight: 700;">Power +0</div>
        </div>

        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
            <p id="inv-detail-desc" style="margin: 0; font-size: 15px; font-weight: 600; color: #B0B8C1; line-height: 1.6; font-style: italic;">
                "설명 텍스트"
            </p>
        </div>
    </div>
</div>       
        <div id="portfolio-popup" class="popup"><button class="close-btn" onclick="closePopup()">×</button><h2>완성작</h2><ul id="portfolio-list" class="item-list"></ul></div>
        <div id="planning-popup" class="popup" style="width: 320px;"><button class="close-btn" onclick="closePopup()">×</button><h2>새 프로젝트 기획</h2><input type="text" id="project-name" class="input-name" placeholder="프로젝트명 입력"><div class="select-group"><div class="select-col"><h3>주제 (Genre)</h3><div id="genre-list" class="scroll-box"></div></div><div class="select-col"><h3>스타일 (Style)</h3><div id="style-list" class="scroll-box"></div></div></div><button class="full-btn" onclick="confirmPlanning()">다음 단계</button></div>
        <div id="mission-popup" class="popup"><button class="close-btn" onclick="closePopup()">×</button><h2>전략 선택</h2><button class="full-btn" onclick="setStrategy('quality')">🎨 퀄리티 중심</button><button class="full-btn" style="background:#4CD964;" onclick="setStrategy('speed')">⚡ 속도 중심</button></div>
        
<div id="alba-popup" class="popup">
    <button class="close-btn" onclick="closePopup()">×</button>
    <h2>자금 마련</h2>
    
    <div class="card-btn" onclick="startWorking('normal')">
        <div class="card-info">
            <h3>☕ 카페 알바</h3>
            <p style="color:#B0B8C1">
                보상: <span style="color:#fff; font-weight:bold;">5만원</span> 
                <span style="color:#FF5F5F; margin-left:4px; font-weight:bold;">(HP -20)</span>
            </p>
        </div>
        <button class="btn-action" style="background:rgb(223, 110, 110);">출근</button>
    </div>

    <div class="card-btn" onclick="startMiniGame()">
        <div class="card-info">
            <h3>🎨 단기 디자인 외주</h3>
            <p style="color:#B0B8C1; font-size:12px;">
                성공: 7만+스킬 <span>(HP -20)</span><br>
                <span style="color:#888;">실패 시 보상 0원</span>
            </p>
        </div>
        <button class="btn-action" style="background:#7274ED;">도전</button>
    </div>

    <div class="card-btn">
        <div class="card-info">
            <h3>🔥 특급 야근 (광고)</h3>
            <p style="color:#B0B8C1">
                보상: <span style="color:#FFD700; font-weight:bold;">10만원</span> 
                <span style="color:#4CD964; margin-left:4px; font-weight:900;">(체력 소모 0)</span>
            </p>
        </div>
        <button class="btn-ad" onclick="trySpecialAlba()">지원</button>
    </div>
</div>

        <div id="social-popup" class="popup">
            <button class="close-btn" onclick="closePopup()">×</button>
            <h2 id="social-title">사회생활</h2>
            <div id="social-content"></div>
        </div>

<div id="rest-popup" class="popup">
    <button class="close-btn" onclick="closePopup()">×</button>
    <h2>휴식 선택</h2>
    
    <div class="card-btn">
        <div class="card-info">
            <h3>☕ 커피 수혈</h3>
            <p>HP +30 / 5천원</p>
        </div>
        <button class="btn-action" onclick="doRest('coffee')">마시기</button>
    </div>

    <div class="card-btn">
        <div class="card-info">
            <h3>🛌 꿀잠</h3>
            <p>HP +60 / 무료</p>
        </div>
        <button class="btn-buy" onclick="doRest('sleep')">자기</button>
    </div>

    <div class="card-btn">
        <div class="card-info">
            <h3>✨ 온전한 힐링</h3>
            <p style="color:#4CD964">HP 100% / 광고</p>
        </div>
<button class="btn-ad" onclick="showAd('HP_RECOVER', function(){ doRest('full') })">
            광고 보고 회복
        </button>
    </div>
</div>        
<div id="p2-rest-popup" class="popup">
    <button class="close-btn" onclick="closePopup()">×</button>
    <h2>휴식 하기</h2>
    <p style="text-align:center; color:#B0B8C1; font-size:12px; margin-bottom:15px;">
        * 테니스는 티어가 높을수록 고급 클럽을 이용합니다.
    </p>

    <div class="card-btn">
        <div class="card-info">
            <h3>🎾 테니스 레슨</h3>
            <p id="p2-tennis-cost">가격 계산 중...</p> 
        </div>
        <button class="btn-buy" onclick="doP2RestAction('tennis')">운동</button>
    </div>

    <div class="card-btn">
        <div class="card-info">
            <h3>🏠 집에서 넷플릭스</h3>
            <p>무료 (멘탈 +60)</p>
        </div>
        <button class="btn-buy" onclick="doP2RestAction('home')">휴식</button>
    </div>

    <div class="card-btn" style="border:1px solid #7274ED">
        <div class="card-info">
            <h3>✈️ 해외여행 (광고)</h3>
            <p style="color:#7274ED">무료 (멘탈 완전 회복)</p>
        </div>
      <button class="btn-buy" onclick="showAd('HP_RECOVER', function(){ doP2RestAction('full') })">
            떠나기
        </button>
    </div>
</div>

        <div id="skill-popup" class="popup">
            <button class="close-btn" onclick="closePopup()">×</button>
            <h2>스킬 업</h2>
            <div class="card-btn"><div class="card-info"><h3>🤖 AI 구독</h3><p>디자인 스킬 +2 (4만원)</p></div><button class="btn-buy" onclick="doSkillUp('ai')">수강</button></div>
            <div class="card-btn"><div class="card-info"><h3>🎨 원데이 클래스</h3><p>디자인 스킬 +10 (15만원)</p></div><button class="btn-buy" onclick="doSkillUp('oneday')">수강</button></div>
            <div class="card-btn" style="border:1px solid #FFB356"><div class="card-info"><h3>🔥 디프렙 정규과정</h3><p>디자인 스킬 +50 (50만원)</p></div><button class="btn-buy" onclick="doSkillUp('deprep')">수강</button></div>
        </div>  
        
        <div id="p2-skill-popup" class="popup">
    <button class="close-btn" onclick="closePopup()">×</button>
    <h2>직무 능력 향상</h2>
    <div style="text-align:center; color:#B0B8C1; font-size:12px; margin-bottom:15px;">
        * 레벨이 높을수록 증가율은 감소하고 비용이 높아집니다.
    </div>
    
    <div class="card-btn">
        <div class="card-info">
            <h3>📰 유료 레퍼런스 구독</h3>
            <p id="p2-cost-sub">가격 계산 중...</p> 
        </div>
        <button class="btn-buy" onclick="doP2SkillAction('sub')">구독</button>
    </div>

    <div class="card-btn">
        <div class="card-info">
            <h3>🎤 직무 인사이트 세미나</h3>
            <p id="p2-cost-seminar">가격 계산 중...</p> 
        </div>
        <button class="btn-buy" onclick="doP2SkillAction('seminar')">참석</button>
    </div>

    <div class="card-btn" style="border:1px solid #FFB356">
        <div class="card-info">
            <h3>🔥 디프렙 정규과정</h3>
            <p id="p2-cost-deprep">가격 계산 중...</p> 
        </div>
        <button class="btn-buy" onclick="doP2SkillAction('deprep')">수강</button>
    </div>
</div>
<div id="job-popup" class="popup">
    <button class="close-btn" onclick="closePopup()">×</button>
    <h2>취업 시장</h2>
    
    <div style="text-align:center; font-size:13px; color:#B0B8C1; margin-bottom:15px;">
        내 최고 점수: <span id="best-score" style="color:#fff; font-weight:700;">0</span>점<br>
        <span style="color:#555; font-size:11px;">(2개월마다 갱신됩니다)</span>
    </div>
    
    <ul id="job-list" class="item-list"></ul>
    
    <button class="btn-ad" onclick="showAd('JOB_REFRESH', function(){ refreshJobs() })">
        🔄 공고 새로고침 (광고)
    </button>
</div>

<div id="exit-popup" class="popup-layer" style="display: none;">
    <div class="popup-content toss-style">
        <h3 class="popup-title">레벨 업! 디자이너를<br>종료할까요?</h3>
        
        <div class="popup-btn-group">
            <button class="popup-btn btn-cancel" onclick="closeExitPopup()">취소</button>
            <button class="popup-btn btn-confirm" onclick="quitGame()">종료하기</button>
        </div>
    </div>
</div>
        <div id="settings-popup" class="popup"><button class="close-btn" onclick="closePopup()">×</button><h2>설정 (Settings)</h2><ul class="item-list">
           <li class="card-btn" onclick="closePopup(); openTossLeaderboard();">
    <div class="card-info"><h3 style="color:#FFD700">🏆 랭킹 확인</h3><p>나의 디자이너 순위 보기</p></div><div>></div></li><li class="card-btn" style="cursor: default;"><div class="card-info"><h3>배경음악</h3><p>게임 소리 켜기/끄기</p></div><label class="toggle-switch"><input type="checkbox" id="sound-toggle" checked onchange="toggleSound()"><span class="slider"></span></label></li><li class="card-btn" onclick="resetGameData()"><div class="card-info"><h3 style="color:#FF5F5F">데이터 초기화</h3><p>모든 진행 상황 삭제</p></div><div style="color:#FF5F5F; font-weight:700;">Reset</div></li></ul></div>
        <div id="ranking-popup" class="popup"><button class="close-btn" onclick="closePopup()">×</button><h2>🏆 디자이너 랭킹</h2><div style="background:#333D4B; padding:15px; border-radius:12px; margin-bottom:15px; text-align:center;"><div style="font-size:12px; color:#B0B8C1;">나의 랭킹 점수</div><div id="my-rank-score" style="font-size:24px; font-weight:800; color:#FFD700; margin:5px 0;">0</div><div id="my-rank-text" style="font-size:14px; font-weight:600; color:#fff;">상위 ??%</div></div><ul id="ranking-list" class="item-list"></ul></div>
        <div id="meeting-popup" class="popup" style="z-index: 20002;">
    <h2 style="color:#7274ED;">☕ 킥오프 미팅</h2>
    <div style="text-align:center; margin-bottom:15px;">
        <p style="font-size:12px; color:#B0B8C1;">클라이언트가 요구사항을 쏟아냅니다.</p>
        <div style="background:#fff; color:#333; padding:15px; border-radius:12px; margin:10px 0; font-weight:bold; font-size:14px; position:relative;">
            "<span id="client-msg">...</span>"
        </div>
    </div>
    
    <div class="card-btn" onclick="confirmMeeting('yesman')" style="padding:10px; margin-bottom:8px;">
        <div class="card-info">
            <h3>A. 무리한 수용 (급행)</h3>
            <p style="color:#FF5F5F">진행도 1.5배 / 체력소모 2배</p>
        </div>
    </div>
    <div class="card-btn" onclick="confirmMeeting('pro')" style="padding:10px; margin-bottom:8px;">
        <div class="card-info">
            <h3>B. 정석 대응 (기본)</h3>
            <p style="color:#B0B8C1">변동 없음 (표준)</p>
        </div>
    </div>
    <div class="card-btn" onclick="confirmMeeting('ignore')" style="padding:10px; margin-bottom:8px;">
        <div class="card-info">
            <h3>C. 현실 타협 (절약)</h3>
            <p style="color:#4CD964">체력소모 0.7배 / 진행도 0.6배</p>
        </div>
    </div>
</div>

        <div id="offer-popup" class="popup" style="z-index: 10500;">
            <h2>📩 채용 제안 도착</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:16px; font-weight:bold; color:#fff; margin-bottom:10px;" id="offer-company-name">(주)회사명</div>
                <p style="color:#B0B8C1; font-size:13px; line-height:1.6;">"귀하의 포트폴리오를 인상 깊게 보았습니다.<br>저희와 함께 세상을 바꿔보시겠습니까?"</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="full-btn" style="background:#454F5D; margin-top:0;" onclick="closePopup()">거절하기</button>
                <button class="full-btn" style="background:#3182F6; margin-top:0;" onclick="acceptOffer()">입사하기</button>
            </div>
        </div>

        <div id="success-popup">
    <div class="paper-notice" style="padding: 40px 30px;">
        <div class="notice-header">
            <div class="deco-line"></div>
            <h2 class="notice-title" style="font-size: 24px; margin: 15px 0;">최종 합격 통지서</h2>
            <div class="deco-line"></div>
            <div class="final-stamp">합격</div>
            <div class="approved-stamp">APPROVED</div>
        </div>
        
<div class="notice-text" style="font-size: 16px; line-height: 1.8;">
    귀하는 당사의 채용 전형에서<br>
    우수한 역량을 입증하였기에,<br>
    
    <div style="margin: 20px 0; font-size: 22px; color: #333;">
        <strong id="success-company" class="company-name">(주)회사명</strong>의
    </div>
    정규직 디자이너로 선발되었습니다.<br>
    <br>
    함께하게 되어 영광입니다.
</div>

        <div class="notice-footer" style="margin-top: 40px; border-top: 1px dashed #ddd; padding-top: 20px;">
            <p>📅 <strong>출근 일자:</strong> 다음주 월요일 09:00</p>
            <button class="full-btn sign-btn" onclick="startPhase2()" style="margin-top: 15px;">
                서명하고 입사하기 (Accept)
            </button>
            
            <div onclick="openTossLeaderboard()" style="margin-top: 15px; font-size: 12px; color: #B0B8C1; text-decoration: underline; cursor: pointer;">
                내 합격 점수 랭킹 확인하기
            </div>
        </div>
    </div>
</div>
        <div id="payday-popup" class="popup" style="z-index: 21000; text-align:center;">
    <h2 style="color:#4CD964; border-bottom:1px solid #444; padding-bottom:10px;">💵 급여 명세서</h2>
    
    <div style="background:#fff; color:#333; padding:20px; border-radius:4px; margin-bottom:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transform: rotate(-1deg);">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#555;">
            <span>(+) 월 급여액</span>
            <span id="pay-income" style="font-weight:bold; color:#333;">0</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:14px; color:#FF5F5F;">
            <span>(-) 세금 및 품위 유지비</span>
            <span id="pay-cost" style="font-weight:bold;">0</span>
        </div>
        <div style="border-top:2px dashed #aaa; margin:10px 0;"></div>
        <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:900; color:#3182F6;">
            <span>= 실 수령액</span>
            <span id="pay-total">0</span>
        </div>
    </div>
    
    <p id="pay-msg" style="font-size:13px; color:#B0B8C1; margin-bottom:15px;">"이번 달도 고생 많으셨습니다."</p>
    <button class="full-btn" onclick="confirmPayday()">확인 (입금 완료)</button>
</div>
        <div id="ad-overlay"><h1>ADVERTISEMENT</h1><p>(3초 후 닫기)</p><button onclick="closeAd()" style="margin-top:20px; padding:10px;">닫기</button></div>
        <div id="hall-of-fame-popup" class="popup" style="z-index: 20005;">
    <h2 style="color:#FFD700;">🏆 명예의 전당</h2>
    <div style="text-align:center; color:#B0B8C1; font-size:12px; margin-bottom:15px;">
        S급 프로젝트를 전시하여 영구 버프를 획득하세요.<br>(최대 3개 슬롯)
    </div>


    <div style="background:#333; padding:10px; border-radius:8px; margin-bottom:15px; font-size:13px;">
        <span style="color:#4CD964">💰 연봉 +<span id="hof-wealth">0</span>%</span> | 
        <span style="color:#FFB356">⚡ 속도 +<span id="hof-speed">0</span>%</span> | 
        <span style="color:#7274ED">🎖️ 성과 +<span id="hof-fame">0</span>%</span>
    </div>

    <ul id="hof-list" class="item-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px;">
        </ul>

    <button class="full-btn" onclick="openRegisterPopup()">➕ S급 프로젝트 등록하기</button>
    <button class="full-btn" style="background:#454F5D; margin-top:5px;" onclick="closePopup()">닫기</button>
</div>

<div id="hof-register-popup" class="popup" style="z-index: 20006;">
    <h2>전시할 작품 선택</h2>
    <p style="text-align:center; font-size:12px; color:#B0B8C1; margin-bottom:10px;">기록된 S급 프로젝트만 표시됩니다.</p>
    <ul id="hof-candidate-list" class="item-list" style="max-height:300px; overflow-y:auto;"></ul>
    <button class="full-btn" style="background:#454F5D;" onclick="closeRegisterPopup()">취소</button>
</div>
        <div id="extension-popup" class="popup" style="z-index: 20001;">
            <h2 style="color:#FFB356;">📅 마감 기한 연장</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <p style="font-size:14px; color:#fff; line-height:1.6; margin-bottom:15px;">
                    "아... 이대로면 마감을 못 맞춘다.<br>
                    <span style="color:#FF5F5F; font-weight:bold;">반려 당하면 멘탈이 반토막</span> 날 텐데..."
                </p>
                <div style="background:#333; padding:15px; border-radius:8px; font-size:13px; color:#B0B8C1;">
                    자존심 굽히고 클라이언트에게 사정하시겠습니까?<br>
                    <span style="color:#4CD964;">(광고 시청 시 마감 +1주 연장)</span>
                </div>
            </div>
          <button class="btn-ad" onclick="closePopup(); showAd('EXTEND_DEAD', function(){doExtendDeadline()})">
                📞 전화 걸기 (광고 시청)
            </button>
            <button class="full-btn" style="background:#454F5D; margin-top:10px;" onclick="closePopup()">
                ✋ 아니요, 밤새서 끝냅니다.
            </button>
        </div>

<div id="extension-success-popup" class="popup" style="z-index: 22000;">
    <div class="call-anim-icon">📞</div>
    
    <h2 style="color:#fff; margin-bottom:5px;">협상 성공!</h2>
    <p style="color:#B0B8C1; font-size:12px; margin-bottom:20px;">클라이언트와 통화가 연결되었습니다.</p>

    <div class="client-bubble-box">
        <span class="client-name">CLIENT</span>
        <div class="client-text">
            "하아... 알겠습니다. 이번만 봐드리는 겁니다.<br>
            대신 퀄리티는 확실하게 뽑아주세요."
        </div>
    </div>

<div class="result-badge-row">
    <div class="res-badge badge-green">
        <span>📅</span> 마감 +1주 연장
    </div>
    
    <div class="res-badge badge-red">
        <span>🚫</span> 재사용 불가
    </div>
</div>

    <button class="full-btn" onclick="closePopup()">감사합니다! (복귀)</button>
</div>

        <div id="tutorial-overlay" style="display:none;">
    <div class="tuto-dialog">
        <span id="tuto-name" class="tuto-name"></span>
        <div id="tuto-text" class="tuto-text"></div>
        <button id="tuto-btn" class="tuto-next-btn" onclick="nextTutorialLine()"></button>
    </div>
</div>

<div id="museum-popup" class="popup" style="z-index: 20010;">
    <button class="close-btn" onclick="closePopup()">×</button>
    
    <h2 style="color:#FFD700; text-align:center; margin-bottom:10px;">
        🏛️ 디자인 박물관
    </h2>

    <div class="museum-guide-box">
        <h4 style="margin:0 0 5px 0; color:#fff;">📜 큐레이터의 메모</h4>
        <p>
            "이곳엔 전설적인 디자이너의 유물만 전시됩니다.<br>
            <span style="color:#FFD700;">Space(우주) 티어</span> 기업에서 
            <span style="color:#FF5F5F;">SS급 걸작(Masterpiece)</span>을<br> 
            수행하여 빈 전시관을 채워보세요."
        </p>
    </div>
    <div style="text-align:right; color:#B0B8C1; font-size:12px; margin-bottom:5px; margin-top:10px;">
        수집 현황: <span id="museum-count" style="color:#fff; font-weight:bold;">0</span>/10
    </div>

    <div id="museum-grid" class="museum-grid">
        </div>
</div>
<div id="minigame-popup" class="popup" style="display:none; text-align:center; z-index: 50000; background:rgba(255,255,255,0.98); border:2px solid #333;">
    <h3 style="color:#333; margin-bottom:5px;">⚡ 사장님의 돌발 미션!</h3>
    <p style="color:#666; font-size:14px; margin-bottom:20px;">
        "자네 디자인과지? 이것 좀 정렬해줘!"<br>
        <span style="color:#FF5F5F; font-size:12px;">(빨간 선에 겹칠 때 STOP 누르기)</span>
    </p>

    <div class="game-track-container">
        <div class="center-line"></div>
        <div id="moving-block" class="moving-block"></div>
    </div>

    <div id="minigame-msg" style="height:20px; font-weight:bold; margin-bottom:15px; color:#333; font-size:14px;"></div>

    <button id="minigame-action-btn" class="full-btn" onclick="stopMovingBlock()" style="background:#333; color:#fff;">STOP!</button>
</div>

<div id="crisis-warning-popup" class="popup" style="display:none; z-index: 62000; text-align:center; border: 2px solid #FF5F5F; background: #fff; color:#333; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 300px;">
    <div style="font-size:50px; margin-bottom:15px;">⚠️</div>
    <h2 style="color:#333; font-size:20px; margin-bottom:10px;">프로그램 응답 없음</h2>
    <p style="color:#666; font-size:14px; margin-bottom:20px; line-height:1.5;">
        작업 중 치명적 오류 발생!<br>
        강제 종료를 막으려면 복구하세요.
    </p>
    <button class="full-btn" onclick="realStartCrisis()" style="background:#FF5F5F; color:white; font-weight:bold; animation: blink 1s infinite;">
        🚨 긴급 복구 시도
    </button>
</div>

<div id="crisis-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: 60000; background:#0078D7; text-align:center;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:320px;">
        <div style="font-size:60px; margin-bottom:20px;">😵</div>
        <h2 style="color:#fff; font-size:24px; margin-bottom:10px;">Blue Screen</h2>
        <p style="color:#fff; font-size:15px; margin-bottom:30px; line-height:1.4;">
            데이터 손실 위험!<br>
            <span style="color:#FFD700; font-weight:bold;">버튼을 연타</span>하여 게이지를 채우세요!
        </p>

        <div class="save-bar-container">
            <div id="save-bar-fill" class="save-bar-fill"></div>
            <span id="save-text" style="z-index:2;">SAVING... 50%</span>
        </div>

        <button id="mash-btn" onclick="mashSaveButton()" style="
            width:100%; padding:20px; background:#fff; color:#0078D7; border:none; 
            border-radius:12px; font-weight:900; font-size:22px; margin-top:30px; 
            box-shadow:0 6px 0 #005a9e; cursor:pointer;">
            SAVE !!! (연타)
        </button>
    </div>
</div>

<div id="crash-popup" class="popup" style="display:none; z-index: 61000; text-align:center; border:2px solid #FF5F5F;">
    <div style="font-size:50px; margin-bottom:15px;">💀</div>
    <h2 style="color:#FF5F5F;">치명적인 오류</h2>
    <p style="color:#B0B8C1; font-size:14px; margin-bottom:20px;">
        "예기치 않게 프로그램이 종료되었습니다."<br>
        작업한 내용이 모두 사라집니다.
    </p>

  <button class="btn-ad" onclick="recoverCrash()">
        💾 데이터 복구 (광고 시청)
    </button>
    
    <button class="full-btn" style="background:#454F5D; margin-top:10px;" onclick="acceptCrash()">
        😭 그냥 포기하겠습니다
    </button>
</div>


<div id="cheat-panel" style="position: absolute; top: 340px; left: 10px; z-index: 99999; display: flex; flex-direction: column; gap: 6px;">
    <button onclick="cheatLevelUp()" style="background:rgba(0,0,0,0.8); color:#fff; border:1px solid #9956DE; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        🆙 스킬 +100
    </button>
    
    <button onclick="cheatMoney()" style="background:rgba(0,0,0,0.8); color:#fff; border:1px solid #FFD700; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        💰 월급
    </button>

    <button onclick="cheatHp()" style="background:rgba(0,0,0,0.8); color:#fff; border:1px solid #4CD964; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        ❤️ 체력 풀회복
    </button>

    <button onclick="triggerDesignAward()" style="background:rgba(0,0,0,0.8); color:#fff; border:1px solid #FF6347; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        🏆 어워드 개최
    </button>

    <button onclick="testTrueEnding()" style="background:rgba(0,0,0,0.8); color:#FFD700; border:1px solid #FFD700; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
        🌌 진 엔딩(SSS)
    </button>
    <button onclick="toggleCheatPanel()" style="background:#555; color:#aaa; border:none; padding:0; height:10px; border-radius:4px; margin-top:2px; cursor:pointer;"></button>
</div>
    


<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
<script>
        // 전역 변수 선언 (함수 바깥에 있어야 함)
        let tossUserHash = 'guest'; // 토스 유저 식별값 (기본: guest)
        let bgSprite;
        let sceneContext, sceneOverlay, sceneImage, sceneDialogText;
        let portfolioOverlay, pfDialogText, adCallback = null;
        let currentGenreId, currentStyleId, currentJobList = [];
        let isSoundOn = true; 
        let charHoodieSprite, charSuitSprite;
        let charWorkSprite, charSuitWorkSprite;
        let overlayContainer, overlayText; 
        let soundP1, soundP2, soundClick;
        let soundEnding;
        let soundAI;
        let soundSSS; // ★ SSS급 전용 BGM 변수
        let pendingRivalTarget = 0; // 경고창에서 컷신으로 점수 넘겨줄 변수
        // [면접 쿨타임 저장소] { "회사이름": 잠금해제시간(Timestamp) }
let interviewCooldowns = {};
let currentBgm = null;
/* [추가] 이미지를 화면 비율에 맞춰 꽉 채워주는 함수 (Cover 모드) */
function fitToScreen(image) {
    if (!image || !sceneContext) return;
    
    // 1. 현재 화면 크기 가져오기
    const width = sceneContext.scale.width;
    const height = sceneContext.scale.height;
    
    // 2. 이미지 스케일 초기화 (계산 오류 방지)
    image.setScale(1);
    
    // 3. 비율 계산 (가로/세로 중 더 많이 늘려야 하는 쪽을 기준으로 삼음)
    const scaleX = width / image.width;
    const scaleY = height / image.height;
    const scale = Math.max(scaleX, scaleY);
    
    // 4. 적용 (중앙 정렬)
    image.setScale(scale).setScrollFactor(0);
    image.setPosition(width / 2, height / 2);
}

// [핵심] 브라우저 기본 alert를 커스텀 함수로 덮어쓰기 (오버라이딩)
window.alert = function(message) {
    const overlay = document.getElementById('custom-alert-overlay');
    const msgBox = document.getElementById('custom-alert-msg');
    
    // 줄바꿈 문자(\n)를 HTML 태그(<br>)로 변환
    msgBox.innerHTML = message.replace(/\n/g, '<br>');
    
    // 화면에 표시 (애니메이션 적용)
    overlay.classList.add('alert-active');
    
    // 효과음 재생 (선택사항)
    if(typeof isSoundOn !== 'undefined' && isSoundOn && typeof soundClick !== 'undefined') {
        // soundClick.play(); // 필요하면 주석 해제
    }
};

window.closeCustomAlert = function() {
    const overlay = document.getElementById('custom-alert-overlay');
    overlay.classList.remove('alert-active');
};
// [NEW] 공백기(취준생) 잔소리 대사 (이 코드는 스크립트 위쪽에 두세요)
const naggingMsgs = [
    "옆집 철수는 이번에 S전자 들어갔다더라... (비교 당함)",
    "너 언제까지 컴퓨터만 붙잡고 있을 거니? (등짝 스매싱)",
    "올해 추석에는 큰집 내려가지 말자. 엄마가 창피해서 그래.",
    "나이가 몇인데 아직도 용돈 타령이니? (팩트 폭력)",
    "누구는 벌써 대리 달았다던데... 넌 계획이 있니?",
    "일 안 할 거면 기술이라도 배워라..."
];
  const interviewData = [
    // ----------------------------------------------------
    // [1. 업무 스타일 & 가치관]
    // ----------------------------------------------------
    {
        q: "마감이 10분 남았는데, 치명적인 오타를 발견했다면?",
        a: [
            { text: "제출이 우선! 일단 보내고 나중에 수정한다.", type: 'L', effect: {P:0, L:12, S:-8} }, // (논리↑ / 센스↓) : 실리를 챙김
            { text: "품질이 우선! 늦더라도 고쳐서 보낸다.", type: 'P', effect: {P:12, L:-8, S:0} }, // (열정↑ / 논리↓) : 장인정신, 납기어김
            { text: "오타가 아니라 '디자인적 허용'이라고 우긴다.", type: 'S', effect: {P:-5, L:-5, S:15} } // (센스↑↑ / 나머지↓↓) : 미친 순발력
        ]
    },
    {
        q: "우리 회사는 야근 수당이 없는데, 괜찮으신가요?",
        a: [
            { text: "성장할 수만 있다면 돈은 중요하지 않습니다!", type: 'P', effect: {P:15, L:-10, S:-5} }, // (열정 폭발 / 논리 박살) : 호구? 열정?
            { text: "업무 시간에 집중해서 야근을 안 하겠습니다.", type: 'L', effect: {P:-8, L:15, S:0} }, // (논리 폭발 / 열정 부족) : 칼퇴 선언
            { text: "그럼 저녁 식대는 법카로 주시나요? (웃음)", type: 'S', effect: {P:0, L:0, S:10} } // (센스) : 위트 있게 넘김
        ]
    },
    {
        q: "상사가 촌스러운 '굴림체'를 쓰라고 강요한다면?",
        a: [
            { text: "존경하는 상사님의 안목을 믿고 따릅니다.", type: 'P', effect: {P:10, L:-5, S:-10} }, // (사회생활 만렙 / 감각 포기)
            { text: "가독성 데이터를 근거로 다른 폰트를 설득합니다.", type: 'L', effect: {P:0, L:12, S:0} }, // (정석 논리)
            { text: "굴림체를 힙(Hip)하게 보이도록 레이아웃을 짭니다.", type: 'S', effect: {P:0, L:-5, S:15} } // (디자인 차력쇼)
        ]
    },
    {
        q: "연봉과 워라밸, 그리고 명예 중 하나만 택한다면?",
        a: [
            { text: "회사의 명예가 곧 저의 명예입니다.", type: 'P', effect: {P:12, L:0, S:-5} }, // (충성심)
            { text: "금융 치료(연봉)가 최고의 복지죠.", type: 'L', effect: {P:0, L:10, S:5} }, // (현실적)
            { text: "칼퇴 후 즐기는 취미(워라밸)입니다.", type: 'S', effect: {P:-10, L:0, S:12} } // (솔직함)
        ]
    },
    {
        q: "아무리 생각해도 이 기획은 망할 것 같다면?",
        a: [
            { text: "팀의 결정이니 끝까지 최선을 다해 완주한다.", type: 'P', effect: {P:15, L:-5, S:0} }, // (군말 없는 실행)
            { text: "망하는 이유를 3가지로 요약해 보고한다.", type: 'L', effect: {P:-5, L:15, S:-5} }, // (팩트 폭격기)
            { text: "제 디자인으로 심폐소생술을 시도해 봅니다.", type: 'S', effect: {P:5, L:-5, S:10} } // (자신감)
        ]
    },

    // ----------------------------------------------------
    // [2. 대인 관계 & 커뮤니케이션]
    // ----------------------------------------------------
    {
        q: "개발자가 '기술적으로 구현 불가능해요'라고 눕는다면?",
        a: [
            { text: "제가 코딩을 배워서라도 직접 돕겠습니다.", type: 'P', effect: {P:18, L:-5, S:-5} }, // (광기)
            { text: "비슷한 레퍼런스를 찾아 기술적 가능성을 제시함.", type: 'L', effect: {P:0, L:12, S:0} }, // (팩트 체크)
            { text: "개발자님이 좋아하는 커피를 사 들고 읍소한다.", type: 'S', effect: {P:0, L:-5, S:15} } // (뇌물 공세)
        ]
    },
    {
        q: "클라이언트가 '그냥 알아서 예쁘게 해주세요'라고 한다면?",
        a: [
            { text: "제 감각을 믿고 예술 작품을 만듭니다.", type: 'S', effect: {P:0, L:-10, S:18} }, // (위험한 예술가)
            { text: "구체적인 레퍼런스 10장을 보여주며 취향을 좁힘.", type: 'L', effect: {P:0, L:12, S:0} }, // (안전 제일)
            { text: "밤을 새워서라도 A, B, C안 3개를 준비해감.", type: 'P', effect: {P:15, L:-5, S:0} } // (몸으로 때우기)
        ]
    },
    {
        q: "팀 프로젝트에서 무임승차(프리라이더)하는 동료가 있다면?",
        a: [
            { text: "제가 그 사람 몫까지 두 배로 일합니다.", type: 'P', effect: {P:15, L:-10, S:0} }, // (호구형 인재)
            { text: "업무 분장표와 기여도를 엑셀로 정리해 보고함.", type: 'L', effect: {P:-5, L:15, S:-5} }, // (냉철한 심판관)
            { text: "저녁을 사주며 '잘 좀 하자'고 회유한다.", type: 'S', effect: {P:0, L:0, S:12} } // (정치력)
        ]
    },
    {
        q: "탕비실에 간식이 다 떨어졌는데, 배가 고프다면?",
        a: [
            { text: "제 사비로 간식을 채워 팀원들과 나눕니다.", type: 'P', effect: {P:12, L:-5, S:5} }, // (천사표)
            { text: "총무팀에 정식 공문을 보내 보급을 요청함.", type: 'L', effect: {P:0, L:10, S:-5} }, // (절차 중시)
            { text: "배고픔을 예술적 영감으로 승화시킵니다.", type: 'S', effect: {P:0, L:-5, S:15} } // (4차원)
        ]
    },
    {
        q: "옆자리 동료가 하루 종일 한숨을 쉰다면?",
        a: [
            { text: "무슨 일 있냐며 조용히 티타임을 요청한다.", type: 'S', effect: {P:0, L:0, S:12} }, // (공감 능력)
            { text: "제 업무 리듬이 깨지니 자제해달라고 말한다.", type: 'L', effect: {P:-5, L:15, S:-10} }, // (마이웨이)
            { text: "저도 같이 한숨을 쉬며 화음을 넣습니다.", type: 'P', effect: {P:5, L:-5, S:5} } // (개그 욕심)
        ]
    },

    // ----------------------------------------------------
    // [3. 돌발 상황 & 창의성] (점수 변동폭 큼)
    // ----------------------------------------------------
    {
        q: "내일 지구가 멸망한다면 오늘 무엇을 디자인하겠나?",
        a: [
            { text: "지구 탈출용 우주선 UI를 그리겠습니다.", type: 'L', effect: {P:0, L:12, S:5} },
            { text: "마지막까지 회사 로고를 다듬겠습니다.", type: 'P', effect: {P:20, L:-10, S:-5} }, // (미친 인재)
            { text: "'지구 마감 세일' 포스터를 만듭니다.", type: 'S', effect: {P:0, L:0, S:15} }
        ]
    },
    {
        q: "디자이너에게 가장 필요한 도구는 무엇인가?",
        a: [
            { text: "최신형 맥북과 와콤 타블렛입니다.", type: 'L', effect: {P:0, L:10, S:0} }, // (장비빨)
            { text: "어떤 피드백도 견디는 '강철 멘탈'입니다.", type: 'P', effect: {P:15, L:0, S:0} }, // (중꺾마)
            { text: "영감을 주는 핀터레스트와 인스타입니다.", type: 'S', effect: {P:0, L:-5, S:12} }
        ]
    },
    {
        q: "인쇄물 1만 장을 찍었는데 색감이 잘못 나왔다면?",
        a: [
            { text: "전량 폐기하고 제 월급에서 까주십시오!", type: 'P', effect: {P:18, L:-10, S:0} }, // (책임감 과다)
            { text: "이게 요즘 유행하는 '빈티지 컬러'라고 우긴다.", type: 'S', effect: {P:-5, L:-10, S:20} }, // (사기꾼 기질)
            { text: "오차 범위를 분석해 재발 방지 대책을 세운다.", type: 'L', effect: {P:0, L:15, S:0} } // (수습 전문가)
        ]
    },
    {
        q: "면접관인 제 넥타이 색깔, 어떻게 생각하세요?",
        a: [
            { text: "회사 로고 컬러와 매칭되어 애사심이 느껴집니다!", type: 'P', effect: {P:12, L:0, S:5} }, // (아부)
            { text: "채도와 명도가 피부톤과 아주 잘 어울리십니다.", type: 'L', effect: {P:0, L:12, S:0} }, // (분석적 칭찬)
            { text: "사실 좀... 올드해 보입니다. (솔직)", type: 'S', effect: {P:-5, L:0, S:15} } // (패션 지적질 - 호불호 갈림)
        ]
    },
    {
        q: "로또 1등에 당첨되면 내일 출근 하실 건가요?",
        a: [
            { text: "당연하죠! 저는 일이 너무 즐겁습니다! (거짓)", type: 'P', effect: {P:10, L:-10, S:-5} }, // (너무 티나는 거짓말)
            { text: "인수인계는 끝내고 퇴사하겠습니다. (정색)", type: 'L', effect: {P:-5, L:15, S:0} }, // (책임감은 있음)
            { text: "사장님, 얼마면 회사를 파시겠습니까?", type: 'S', effect: {P:0, L:-5, S:18} } // (플렉스)
        ]
    }
];

        const GameConfig = { initialMoney: 500000, workCost: 5000, workStamina: 30, deadlineRange: [16, 24], crisisChance: 0.03 };
const shopItems = [
    // [Tier 1~3: 기존 유지] 초반 성장 구간
    {id:1, name:"기본 마우스", cost:10000, power:1.5, img:"item_mouse_basic.png", desc:"다이소 에디션"}, 
    {id:2, name:"게이밍 마우스", cost:50000, power:2, img:"item_mouse_game.png", desc:"RGB 감성"}, 
    {id:3, name:"매직 트랙패드", cost:150000, power:3, img:"item_trackpad.png", desc:"손목 보호"}, 
    {id:4, name:"와콤 타블렛", cost:300000, power:4, img:"item_wacom.png", desc:"입문용"}, 
    {id:5, name:"액정 타블렛", cost:800000, power:6, img:"item_tablet_l.png", desc:"화면 그리기"}, 
    {id:6, name:"아이패드 프로", cost:1200000, power:7, img:"item_ipad.png", desc:"스벅 입장권"}, 
    {id:7, name:"커브드 모니터", cost:2000000, power:9, img:"item_monitor.png", desc:"몰입감 최강"}, 
    {id:8, name:"아이맥 프로", cost:5000000, power:12, img:"item_imac.png", desc:"전문가 도구"}, 
    {id:9, name:"허먼밀러 의자", cost:10000000, power:20, img:"item_chair.png", desc:"구름 위"},

    // [Tier 4: Global 구간] 가격 소폭 상향 (중반 허리)
    {id:10, name:"개인 비서 고용", cost:100000000, power:120, img:"char_secretary.png", desc:"스케줄 관리 혁명 (1억)"},
    {id:11, name:"고급 세단", cost:500000000, power:250, img:"item_luxury_sedan.png", desc:"도로 위의 정숙함 (5억)"},
    {id:12, name:"강남 오피스텔", cost:2000000000, power:500, img:"bg_studio_apartment.png", desc:"직주근접 실현 (20억)"},
    {id:13, name:"슈퍼카", cost:5000000000, power:800, img:"item_supercar.png", desc:"압도적 하차감 (50억)"},

    // [Tier 5: Space 구간] ★ 엔드 게임 밸런스 패치 (10배~20배 상향)
    // 기존 50억 -> 500억
    {id:14, name:"개인 전세기", cost:50000000000, power:2000, img:"item_private_jet.png", desc:"해외 미팅 당일치기 (500억)"},
    
    // 기존 100억 -> 1,000억
    {id:15, name:"개인용 양자 컴퓨터", cost:100000000000, power:5000, img:"item_quantum_pc.png", desc:"렌더링 시간 0초 (1,000억)"},
    
    // 기존 200억 -> 2,000억
    {id:16, name:"AI 수트 'Mark PD'", cost:200000000000, power:10000, img:"item_design_suit.png", desc:"자비스 탑재 (2,000억)"},
    
    // ★ 최종: 기존 300억 -> 5,000억 (월급만으론 40년 걸림)
    {id:17, name:"달 기지 별장", cost:500000000000, power:25000, img:"bg_moon_base.png", desc:"지구가 너무 좁다 (5,000억)"}
];
const msgs = { 
    // [기존 업무 멘트 유지]
    work: [
        "1픽셀의 미학(고문) 실천 중", "최종_진짜최종_이게진짜.fig", "화려하지만 심플하게(??)", 
        "로고 크게, 여백 많이.. 하..", "숨 쉬듯이 Ctrl+S", "누끼 따다 영혼 가출", 
        "레이어 정리... 나중에 하자", "이 시안은 휴지통행 확정", "넵, 넵, 넵무새 모드", 
        "금융치료(월급) 시급함", "타자 소리로 열일 연기 중", "점심 메뉴 고민이 주업무", 
        "퇴근 마렵다(출근 10분차)", "혈관에 카페인 수혈 중", "거북목 교정기 검색 중", 
        "로또 당첨되면 뭐할까", "개발팀이랑 협의 중", "UX 핑계로 디자인 퉁치기", 
        "레퍼런스 찾다 쇼핑함", "이건 기획부터 꼬였는데", "애자일하게 갈아엎는 중"
    ],
    // [기존 알바 멘트 유지]
    alba: [
        "어서오세요~ (자본주의 미소 장착)😃", "아아 4잔 나왔습니다~ (목 아픔)",
        "설거지 산더미...😭", "진상 손님 등장... 참아라 나의 인내심",
        "이 돈 모아서 드림카... 아니 맥북 산다 💻", "사장님 눈치 보는 중 (농땡이 아님)",
        "샷 추가 잊지 말자... 집중해!", "오늘 매출 대박이네 (내 돈 아님)",
        "다리가 퉁퉁 붓는다...", "마감 청소 빡세네",
        "손님, 주문하시겠어요? (결정장애 오심)", "진동벨 울려도 왜 안 오시나요..."
    ],
    // [기존 공부 멘트 유지]
    study: [
        "디프렙 강의 최고! 👍", "내 연봉이 높아지는 소리가 들린다 💰",
        "트렌드를 쫓지 마라, 리드하라", "미래의 디자인 리드는 바로 나!",
        "가장 강력한 무기는 실력입니다", "성장하는 내 모습... 제법 멋질지도? ✨",
        "단축키 마스터! 이제 속도 3배 빠름", "이거 배우면 팀장님도 깜짝 놀라시겠지?",
        "새로운 툴? 훗, 주말 안에 마스터해주마", "뇌가 섹시해지는 중...",
        "오늘 배운 스킬, 내일 바로 써먹는다!", "주말엔 역시 자기계발이지!"
    ],
    // [기존 포폴 멘트 유지]
    pf: ["최종_진짜최종.psd", "레이어 이름 정리 좀...", "1픽셀만 왼쪽으로...", "이게_진짜_마지막.zip", "영혼을 갈아넣는 중", "마감 1시간 전!!!", "클라이언트 빙의 중", "색감이 왜 이래?", "밤샘의 요정 출몰", "Ctrl+Z 무한 반복", "제발 오타 없어라", "날 막을 수 없으셈"],

    // ▼▼▼ [NEW] Phase 1: 희망찬 취준생 멘트 (20종) ▼▼▼
    idle_p1: [
        "합격 전화가 올 것 같은 기분 좋은 예감!",
        "이 포트폴리오... 솔직히 내가 봐도 명작인데?",
        "난 될 놈이다! 우주가 나를 돕고 있어!",
        "연봉 협상할 때 다리 꼬고 앉아볼까? (김칫국)",
        "나중에 유명해지면 사인은 어떻게 하지?",
        "오늘 점심은 맛있는 거 먹고 힘내자!",
        "꿈은 크게 가지랬어. 목표는 Space 기업!",
        "곧 디자인계에 내 이름을 떨칠 거야.",
        "첫 월급 타면 부모님 내복부터... 아니 맥북부터?",
        "내 감각은 아직 살아있어! 펄떡펄떡!",
        "오늘따라 컨디션 최고조! 다 덤벼!",
        "딱 맞는 회사가 나를 기다리고 있을 거야.",
        "면접 복장은... 스티브 잡스 스타일?",
        "유튜브로 디자인 트렌드 정주행 완료!",
        "포기란 배추 셀 때나 쓰는 말이지.",
        "내 미래 명함을 상상해보는 중... ✨",
        "언젠가 나만의 브랜드를 만들 거야!",
        "지금 흘린 땀방울이 미래의 연봉이 된다!",
        "세상은 넓고 갈 회사는 많다. 가자!",
        "긍정의 힘! 나는 무조건 성공한다!"
    ],

    // ▼▼▼ [NEW] Phase 2: 성공한 직장인 멘트 (20종) ▼▼▼
    idle_p2: [
        "오늘 업무 왠지 술술 풀리는데? 나 천재인가?",
        "월급날엔 무조건 한우 오마카세 간다!",
        "성과급 받으면 유럽 여행 가야지~ ✈️",
        "칼퇴하고 취미 생활 좀 즐겨볼까?",
        "우리 회사 에이스? 그건 바로 나!",
        "승진이 눈앞에 보인다 보여! (야망)",
        "오늘 점심 메뉴 초이스... 완벽했어.",
        "사장님이 날 흐뭇하게 보시는 것 같아 (착각?)",
        "이번 프로젝트에서 대박 냄새가 난다.",
        "두둑한 통장 잔고를 보니 힘이 솟는다!",
        "모닝 커피 한 잔의 여유... 이게 성공한 삶이지.",
        "내년엔 연봉 앞자리가 무조건 바뀐다!",
        "주말에 뭐 하고 놀지? 벌써 설렌다!",
        "단축키가 손에 착착 감기는구만.",
        "내 디자인이 세상을 바꿀지도 몰라.",
        "이 정도 퀄리티면 팀장님도 기립박수 칠 듯?",
        "오늘따라 내가 좀 멋져 보이는데? (자아도취)",
        "저녁에 테니스나 한 게임 치러 갈까?",
        "다음 휴가는 달 기지 별장으로 가볼까?",
        "자산이 늘어나는 소리가 들린다. 💰"
    ]
};
// [1] 클라이언트 멘트 데이터
const clientMentions = [
    "심플한데 화려하게 해주세요. 느낌 아시죠?",
    "여백은 좋은데 꽉 차 보이게 해주세요.",
    "로고 좀 더 키워주세요. (10번째 요청)",
    "저희 조카가 포토샵을 좀 하는데...",
    "이 색깔 말고 '뜨거운 아이스 아메리카노' 색으로요.",
    "일단 시안 10개만 먼저 볼까요?",
    "요즘 스타일로 힙하게 부탁해요.",
    "내일 아침까지 무조건 됩니다. 그죠?",
    "예산은 없지만 퀄리티는 대기업처럼!"
];
  const companyPool = { 
    // [1. Agency: 헝그리 정신 & 기초 체력]
    agency: [
        {
            name:"Red Dot Studio", req:250, tier:'Agency', label:"에이전시", 
            reqStats: { P:18, L:0, S:0 }, // [열정] 야근
            hint: "목표: 무조건 <span style='color:#FF5F5F'>🔥열정</span>! 끈기를 보여주세요." 
        }, 
        {
            name:"Pixel Lab", req:260, tier:'Agency', label:"에이전시", 
            reqStats: { P:12, L:12, S:0 }, // [열정+논리] 공장형 효율
            hint: "목표: <span style='color:#FF5F5F'>🔥성실함</span>과 <span style='color:#3182F6'>🧠효율성</span>을 동시에!" 
        }, 
        {
            name:"Vector Corp", req:280, tier:'Agency', label:"에이전시", 
            reqStats: { P:10, L:0, S:14 }, // [센스] 부티크
            hint: "목표: 우리에게 필요한 건 <span style='color:#FFD700'>✨센스</span>입니다." 
        },
        // [New] 4. 카페인 디자인 (야근 특화)
        {
            name:"Caffeine Design", req:270, tier:'Agency', label:"에이전시",
            reqStats: { P:15, L:8, S:0 }, // [열정+논리 조금] 좀비처럼 일함
            hint: "목표: 잠들지 않는 <span style='color:#FF5F5F'>🔥체력</span>을 봅니다."
        },
        // [New] 5. Ctrl+C (카피캣)
        {
            name:"Ctrl+C Corp", req:250, tier:'Agency', label:"에이전시",
            reqStats: { P:5, L:5, S:15 }, // [센스] 잘 베끼는 것도 능력
            hint: "목표: 빠르게 캐치하는 <span style='color:#FFD700'>✨눈치(센스)</span>가 생명!"
        }
    ],

    // [2. TopTier: 성장 & 기업 문화]
    toptier: [
        {
            name:"Bamin", req:500, tier:'TopTier', label:"탑티어", prevRank: 1,
            reqStats: { P:10, L:0, S:15 }, // [센스+열정] 키치함
            hint: "목표: <span style='color:#FFD700'>✨위트</span>와 <span style='color:#FF5F5F'>🔥주도성</span>을 봅니다."
        }, 
        {
            name:"Karrot", req:500, tier:'TopTier', label:"탑티어", prevRank: 1,
            reqStats: { P:0, L:18, S:0 }, // [논리] 지역 데이터
            hint: "목표: 오직 <span style='color:#3182F6'>🧠논리적인</span> 해결 능력만 봅니다."
        }, 
        {
            name:"RagZag", req:500, tier:'TopTier', label:"탑티어", prevRank: 1,
            reqStats: { P:0, L:12, S:12 }, // [논리+센스] 패션 데이터
            hint: "목표: <span style='color:#3182F6'>🧠데이터</span>와 <span style='color:#FFD700'>✨트렌드</span>의 조화!"
        },
        // [New] 4. Never (네이버 패러디 - 공채의 정석)
        {
            name:"Never", req:550, tier:'TopTier', label:"탑티어", prevRank: 1,
            reqStats: { P:12, L:12, S:0 }, // [열정+논리] 육각형 인재
            hint: "목표: 기본기가 탄탄한 <span style='color:#3182F6'>🧠모범생</span> 스타일."
        },
        // [New] 5. InstaMood (인스타 패러디 - 감성 충만)
        {
            name:"InstaMood", req:520, tier:'TopTier', label:"탑티어", prevRank: 1,
            reqStats: { P:0, L:5, S:18 }, // [센스 몰빵] 
            hint: "목표: 설명이 필요 없는 <span style='color:#FFD700'>✨비주얼 감각</span>."
        }
    ], 

    // [3. Unicorn: 혁신 & 임팩트]
    unicorn: [
        {
            name:"Tooss", req:1500, tier:'Unicorn', label:"유니콘", prevRank: 2,
            reqStats: { P:14, L:14, S:0 }, // [열정+논리] 금융 혁신
            hint: "목표: 미친 <span style='color:#FF5F5F'>🔥실행력</span>과 <span style='color:#3182F6'>🧠논리</span>가 필요합니다."
        }, 
        {
            name:"Kakaa", req:1500, tier:'Unicorn', label:"유니콘", prevRank: 2,
            reqStats: { P:0, L:10, S:18 }, // [센스+논리] 국민 앱
            hint: "목표: 전 국민을 사로잡을 <span style='color:#FFD700'>✨센스</span>가 압도적이어야 합니다."
        }, 
        {
            name:"Cuupang", req:1500, tier:'Unicorn', label:"유니콘", prevRank: 2,
            reqStats: { P:20, L:8, S:0 }, // [열정 극한] 로켓 배송
            hint: "목표: <span style='color:#FF5F5F'>🔥속도</span>와 <span style='color:#FF5F5F'>🔥집요함</span>! 나머진 필요 없습니다."
        },
        // [New] 4. PlayNow (야놀자 패러디 - 노는 게 일)
        {
            name:"PlayNow", req:1500, tier:'Unicorn', label:"유니콘", prevRank: 2,
            reqStats: { P:15, L:0, S:15 }, // [열정+센스] 잘 노는 사람
            hint: "목표: 일할 땐 일하고 <span style='color:#FFD700'>✨놀 땐 노는</span> 에너지!"
        },
        // [New] 5. MushingSa (무신사 패러디 - 힙한 커머스)
        {
            name:"MushingSa", req:1500, tier:'Unicorn', label:"유니콘", prevRank: 2,
            reqStats: { P:0, L:15, S:12 }, // [논리+센스] 
            hint: "목표: <span style='color:#FFD700'>✨스타일</span>을 <span style='color:#3182F6'>🧠시스템</span>으로 만듭니다."
        }
    ], 

    // [4. Global: 세계 무대]
    global: [
        {
            name:"Googol", req:4000, tier:'Global', label:"글로벌", prevRank: 2,
            reqStats: { P:0, L:22, S:0 }, // [논리 극한] 알고리즘
            hint: "목표: 완벽한 <span style='color:#3182F6'>🧠설계</span>와 <span style='color:#3182F6'>🧠최적화</span>."
        }, 
        {
            name:"Pear", req:4000, tier:'Global', label:"글로벌", prevRank: 2,
            reqStats: { P:0, L:10, S:20 }, // [센스 극한] 감성
            hint: "목표: 세상을 바꿀 <span style='color:#FFD700'>✨디자인 철학</span>과 <span style='color:#FFD700'>✨디테일</span>."
        }, 
        {
            name:"Netflox", req:4000, tier:'Global', label:"글로벌", prevRank: 2,
            reqStats: { P:15, L:0, S:15 }, // [열정+센스] 콘텐츠
            hint: "목표: <span style='color:#FFD700'>✨창의성</span>과 <span style='color:#FF5F5F'>🔥자유</span>를 보장합니다."
        },
        // [New] 4. Amazone (아마존 패러디 - 원칙주의)
        {
            name:"Amazone", req:4200, tier:'Global', label:"글로벌", prevRank: 2,
            reqStats: { P:20, L:15, S:0 }, // [열정+논리] 고객 집착
            hint: "목표: 고객을 향한 <span style='color:#FF5F5F'>🔥집착</span>과 차가운 <span style='color:#3182F6'>🧠이성</span>."
        },
        // [New] 5. Adobi (어도비 패러디 - 툴의 제왕)
        {
            name:"Adobi", req:4100, tier:'Global', label:"글로벌", prevRank: 2,
            reqStats: { P:0, L:15, S:18 }, // [논리+센스] 크리에이티브 툴
            hint: "목표: 창작자를 위한 <span style='color:#3182F6'>🧠기능</span>과 <span style='color:#FFD700'>✨감성</span>의 결합."
        }
    ],

    // [5. Space: 탈지구]
    space: [
        {
            name:"MarsX", req:10000, tier:'Space', label:"스페이스", prevRank: 3,
            reqStats: { P:25, L:0, S:0 }, // [열정 초월] 화성 갈 끄니까
            hint: "목표: 지구를 떠날 <span style='color:#FF5F5F'>🔥광기</span>에 가까운 열정."
        }, 
        {
            name:"NASA Ops", req:10000, tier:'Space', label:"스페이스", prevRank: 3,
            reqStats: { P:15, L:15, S:15 }, // [완전체] 우주비행사
            hint: "목표: <span style='color:#FF5F5F'>🔥체력</span>, <span style='color:#3182F6'>🧠지능</span>, <span style='color:#FFD700'>✨멘탈</span> 모든 게 완벽해야 합니다."
        }, 
        {
            name:"Alien Ware", req:10000, tier:'Space', label:"스페이스", prevRank: 3,
            reqStats: { P:0, L:0, S:25 }, // [센스 초월] 외계 문명
            hint: "목표: 인간의 상식을 뛰어넘는 <span style='color:#FFD700'>✨외계적 발상</span>."
        },
        // [New] 4. Blue Ocean (블루오리진 패러디)
        {
            name:"Blue Ocean", req:11000, tier:'Space', label:"스페이스", prevRank: 3,
            reqStats: { P:18, L:20, S:0 }, // [논리+열정] 정교한 궤도
            hint: "목표: 정교한 <span style='color:#3182F6'>🧠계산</span> 위에 세워진 <span style='color:#FF5F5F'>🔥야망</span>."
        },
        // [New] 5. Jedi Order (스타워즈 패러디)
        {
            name:"Jedi Order", req:12000, tier:'Space', label:"스페이스", prevRank: 3,
            reqStats: { P:20, L:0, S:22 }, // [센스+열정] 포스
            hint: "목표: 당신의 <span style='color:#FFD700'>✨직관(Force)</span>을 믿으세요."
        }
    ]
};
        const projectPools = {
            Agency: ["전단지 디자인", "상세페이지", "배너 광고", "명함 제작", "쇼핑몰 리뉴얼"],
            TopTier: ["앱 GUI 개편", "디자인 시스템", "브랜드 가이드", "아이콘 패키지"],
            Unicorn: ["슈퍼앱 통합", "신규 서비스 런칭", "UX 리서치", "글로벌 프로덕트"],
            Global: ["전사적 OS 구축", "다국어 플랫폼", "AI 인터페이스", "접근성 개선"],
            Space: ["화성 거주지 OS", "우주선 관제 UI", "외계어 번역기", "무중력 UX"]
            
        };
        // [신규] SS급 마스터피스 (박물관 전시용) 데이터
const masterpiecePool = [
    { name: "화성 거주지 헌법", desc: "인류의 새로운 규칙을 새기다" },
    { name: "지구 연방 화폐", desc: "전 지구적 경제 통합의 상징" },
    { name: "외계 문명 시각 언어", desc: "말하지 않아도 통하는 우주의 언어" },
    { name: "인류 기억 타임캡슐", desc: "우리의 역사를 영원히 보존하다" },
    { name: "다이슨 스피어 설계도", desc: "태양 에너지를 감싸는 거대 구조물" },
    { name: "초공간 워프 게이트 UI", desc: "공간을 접는 기술의 인터페이스" },
    { name: "AI 인권 선언문", desc: "기계와 인간의 공존을 디자인하다" },
    { name: "은하계 올림픽 엠블럼", desc: "전 우주가 하나 되는 축제" },
    { name: "불로장생 유전자 키트", desc: "죽음을 극복한 디자인" },
    { name: "제2의 지구 테라포밍", desc: "황무지를 낙원으로 바꾸는 청사진" }
];
    // [수정] 직급 배열 확장 (5단계 '전설' 추가)
const RANKS = ["사원", "대리", "팀장", "이사", "전설"];
        
// [Ver 62.1] 급여 현실화 (너무 퍼주지 않음)
const BASE_SALARY = { 
    Agency: 450000,       
    TopTier: 800000,      
    Unicorn: 3000000,     
    Global: 15000000,     
    Space: 150000000      
};        const RANK_MULTIPLIER = [1, 1.2, 1.5, 2.0]; 

// [Ver 60.2] 아재개그 리스트 (요청사항 반영: 앙팡, 취소, 주말 삭제)
const dadJokes = [
    {q:"왕이 넘어지면?", a:"킹콩"}, 
    {q:"딸기가 직장을 잃으면?", a:"딸기시럽"}, 
    {q:"신발이 화가 나면?", a:"신발끈"}, 
    {q:"반성문을 영어로 하면?", a:"글로벌"}, 
    {q:"소가 노래를 부르면?", a:"소송"}, 
    {q:"세상에서 제일 지루한 중학교는?", a:"로딩중"}, 
    {q:"비가 1시간 동안 내리면?", a:"추적60분"}, 
    {q:"할아버지가 제일 좋아하는 돈은?", a:"할머니"}, 
    {q:"불이 4곳에 나면?", a:"사파이어"}, 
    {q:"얼음이 죽으면?", a:"다이빙"}, 
    {q:"세상에서 가장 착한 사자는?", a:"자원봉사자"}, 
    {q:"아몬드가 죽으면?", a:"다이아몬드"}, 
    {q:"자동차가 울면?", a:"잉카"}, 
    {q:"사과가 웃으면?", a:"풋사과"}, 
    {q:"개가 사람을 가르치면?", a:"개인지도"}, 
    {q:"오리가 얼면?", a:"언덕"}, 
    {q:"가장 억울한 도형은?", a:"원통"}, 
    {q:"싸움을 제일 잘하는 오리는?", a:"을지문덕"},
    {q:"세상에서 가장 뜨거운 과일은?", a:"천도복숭아"},
    {q:"신사가 자기소개하면?", a:"신사임당"},
    {q:"도둑이 훔친 돈은?", a:"슬그머니"},
    {q:"바나나가 웃으면?", a:"바나나킥"},
    {q:"오리를 생으로 먹으면?", a:"회오리"},
    {q:"자동차를 톡 하고 치면?", a:"카톡"},
    {q:"다리미가 좋아하는 음식은?", a:"피자"},
    {q:"3월에 대학생들이 강한 이유는?", a:"개강해서"}
];        const p1ProjectThemes = ["금융 앱", "배달 플랫폼", "커머스 웹", "기업 제안서", "신규 브랜딩", "SaaS 대시보드", "이벤트 랜딩"];

        const initialPlayerState = { 
            totalWeeks: 1, hp: 100, maxHp: 100, money: 500000, designStat: 10, portfolioProgress: 0, portfolioQuality: 0, 
            inventory: ["기본 마우스"], currentPower: 1, isBusy: false, isProjectStarted: false, currentSynergy: 1.0, currentStrategy: 'speed', 
            currentProjectName: '', bestPortfolioScore: 0, jobMarketOpen: false, history: [], mastery: { genre: {}, style: {} }, workedThisWeek: false, premiumJobCount: 0, deadline: 0, currentWeekInProject: 0, pendingCrisis: null,
            
            isPhase2: false, 
            performance: 0, 
            salary: 0, 
            tier: 'Agency', 
            rank: 0, 
            currentProject: null,
            isTutorialDone: false, 
            isP2TutorialDone: false,
            idleWeeks: 0,
            museum: [] // 수집한 Masterpiece 프로젝트가 여기에 저장됨
    
        };
        let player = JSON.parse(JSON.stringify(initialPlayerState)); 

const genres = [
    {id:'g1',name:'금융'},
    {id:'g2',name:'배달'},
    {id:'g3',name:'게임'},
    {id:'g4',name:'공공'},
    {id:'g5',name:'패션'},
    {id:'g6',name:'AI/테크'},   // New
    {id:'g7',name:'헬스/의료'}, // New
    {id:'g8',name:'교육/키즈'}, // New
    {id:'g9',name:'환경/ESG'}   // New
];
const styles = [
    {id:'s1',name:'신뢰감'},
    {id:'s2',name:'팝한'},
    {id:'s3',name:'미니멀'},
    {id:'s4',name:'레트로'},
    {id:'s5',name:'럭셔리'},
    {id:'s6',name:'감성/오가닉'}, // New
    {id:'s7',name:'사이버펑크'},  // New
    {id:'s8',name:'브루탈리즘'}   // New (거칠고 힙한 스타일)
];        genres.forEach(g => player.mastery.genre[g.id] = 1); styles.forEach(s => player.mastery.style[s.id] = 1);

const config = { 
    type: Phaser.AUTO, 
    width: 360, 
    height: 640, 
    backgroundColor: '#191F28', 
    parent: 'game-container', 
    resolution: window.devicePixelRatio || 1,
    pixelArt: false, // 도트 게임 아니면 무조건 false
    antialias: true, // 부드럽게 처리 (이게 꺼지면 계단 현상 발생)
    
    scale: {
        // ★ 핵심: FIT(고정) -> RESIZE(반응형)로 변경
        mode: Phaser.Scale.RESIZE, 
        autoCenter: Phaser.Scale.NO_CENTER, 
        width: '100%',
        height: '100%'
    },
    
    pixelArt: false, 
    scene: { preload: preload, create: create, update: update } 
};

const game = new Phaser.Game(config);

function preload() {
    // 1. [핵심] 현재 실행 중인 index.html의 "진짜 주소(절대 경로)"를 찾아냅니다.
    // 예: https://toss.im/miniapp/1234/
    const absoluteBaseURL = new URL('.', window.location.href).href;
    
    // 2. Phaser에게 "모든 파일은 이 절대 주소 밑의 assets/에서 가져와!"라고 명령합니다.
    // 이렇게 하면 './' 같은 상대 경로가 꼬일 일이 0%가 됩니다.
    this.load.setBaseURL(absoluteBaseURL);
    this.load.path = 'assets/'; 

    console.log("리소스 로딩 시작 (절대 경로 모드):", absoluteBaseURL + 'assets/');

    // 3. 이미지 로드 (파일명만 입력)
    // 실제 요청 주소는 "https://.../assets/bg_main.png" 처럼 변환됩니다.
    this.load.image('bg_main', 'bg_main.png'); 
    this.load.image('bg_alba', 'bg_alba.png'); 
    this.load.image('bg_office', 'bg_office.png'); 
    
    this.load.image('bg_toptier', 'bg_toptier.png');
    this.load.image('bg_unicorn', 'bg_unicorn.png');
    this.load.image('bg_global', 'bg_global.png');
    this.load.image('bg_space', 'bg_space.png');
    
    this.load.image('bg_main_night', 'bg_main_night.png');
    this.load.image('bg_office_night', 'bg_office_night.png');
    this.load.image('bg_toptier_night', 'bg_toptier_night.png');
    this.load.image('bg_unicorn_night', 'bg_unicorn_night.png');
    this.load.image('bg_global_night', 'bg_global_night.png');
    this.load.image('bg_space_night', 'bg_space_night.png');
            
    this.load.image('bg_netflix', 'bg_netflix.png');
    this.load.image('bg_tenis', 'bg_tenis.png');
    this.load.image('bg_travel', 'bg_travel.png');

    this.load.image('scene_study', 'scene_study.png');       
    this.load.image('scene_burning', 'scene_burning.png'); 
    this.load.image('bg_sleep', 'bg_sleep.png');
    this.load.image('bg_empty_room', 'bg_empty_room.png'); 
    
    this.load.image('char_hoodie_front', 'char_hoodie_front.png'); 
    this.load.image('char_suit_front', 'char_suit_front.png'); 
    this.load.image('item_mouse_basic.png', 'item_mouse_basic.png'); 
    
    this.load.image('char_work', 'char_work.png');       
    this.load.image('char_work_2', 'char_work_2.png');   
    this.load.image('char_work_3', 'char_work_3.png');   
    this.load.image('char_work_4', 'char_work_4.png');   

    this.load.image('char_suit_work', 'char_suit_work.png');     
    this.load.image('char_suit_work_2', 'char_suit_work_2.png'); 
    this.load.image('char_suit_work_3', 'char_suit_work_3.png'); 
    this.load.image('char_suit_work_4', 'char_suit_work_4.png'); 
    
    this.load.image('intro_bg', 'intro_bg.png');
    this.load.image('intro_logo', 'intro_logo.png');
    this.load.image('ai', 'ai.png');
    this.load.image('sss_intro', 'sss_intro.png');

    // 사운드
    this.load.audio('bgm_p1', ['bgm_p1.ogg', 'bgm_p1.m4a']);
    this.load.audio('bgm_p2', ['bgm_p2.ogg', 'bgm_p2.m4a']);
    this.load.audio('sfx_btn', 'sfx_btn.wav');
    this.load.audio('sfx_ending', ['sfx_ending.ogg','sfx_ending.m4a']);
    this.load.audio('bgm_ai', ['bgm_ai.ogg', 'bgm_ai.m4a']);
    this.load.audio('bgm_sss', ['bgm_sss.ogg', 'bgm_sss.m4a']);
    
    // ▼▼▼ [에러 추적] 만약 이미지가 안 나오면 어떤 주소를 찾고 있는지 알려줌 ▼▼▼
    this.load.on('loaderror', function(file) {
        alert("이미지 로드 실패!\n파일명: " + file.key + "\n시도한 주소: " + file.src);
    });
            
    loadGameData();
}
       // [3] create 함수 수정 (기존 create 덮어쓰기)
// [기존 create 함수를 이걸로 통째로 교체하세요]
function create() {
    sceneContext = this;
    
    // 1. 사운드 및 버튼 설정
    soundP1 = this.sound.add('bgm_p1', { loop: true, volume: 0.5 });
    soundP2 = this.sound.add('bgm_p2', { loop: true, volume: 0.5 });
    // ★ [추가] AI BGM 설정 (반복 재생 loop: true)
    soundAI = this.sound.add('bgm_ai', { loop: true, volume: 0.6 });
    soundClick = this.sound.add('sfx_btn', { volume: 0.8 });
    soundEnding = this.sound.add('sfx_ending', { loop: false, volume: 1.0 });
    soundSSS = this.sound.add('bgm_sss', { loop: true, volume: 0.6 });
    
    

    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => { if(isSoundOn && soundClick) soundClick.play(); });
    });
    try { document.getElementById('sound-toggle').checked = isSoundOn; } catch(e) {}

    // 2. 이미지 생성
    let bgKey = 'bg_main';
    if (isNightTime()) bgKey += '_night';

    bgSprite = this.add.image(180, 320, bgKey).setDepth(0);
    sceneImage = this.add.image(180, 320, 'bg_alba'); 
    let pfImg = this.add.image(180, 320, 'scene_burning'); 

    // 3. 캐릭터 생성
    // (1) 서있는 캐릭터 (숨김 상태)
    charHoodieSprite = this.add.image(180, 380, 'char_hoodie_front').setDepth(5).setVisible(false); 
    charSuitSprite = this.add.image(180, 380, 'char_suit_front').setDepth(5).setVisible(false); 

    // (2) 일하는 캐릭터 (스프라이트로 생성하되, 애니메이션은 안 씀)
    // ★ 초기 이미지는 기본(char_work, char_suit_work)으로 설정
    charWorkSprite = this.add.sprite(180, 380, 'char_work').setScale(0.5).setDepth(5).setVisible(false);
    charSuitWorkSprite = this.add.sprite(180, 380, 'char_suit_work').setScale(0.5).setDepth(5).setVisible(false);

    // ★★★ [신규] 랜덤 행동 로직 시작 ★★★
    // 사용할 이미지 목록 정의
    const p1_frames = ['char_work', 'char_work_2', 'char_work_3', 'char_work_4'];
    const p2_frames = ['char_suit_work', 'char_suit_work_2', 'char_suit_work_3', 'char_suit_work_4'];

// [create 함수 내부] 랜덤 행동 로직 교체
    const changePoseRandomly = () => {
        const randIdx = Math.floor(Math.random() * 4);
        
        // 1. 현재 화면이 메인 화면인지 체크 (팝업이나 컷신 중엔 켜면 안 됨)
        // (UI 레이어가 보일 때만 강제로 켭니다)
        const isMainScreen = player.isPhase2 
            ? (document.getElementById('phase2-ui-layer').style.display !== 'none')
            : (document.getElementById('ui-layer').style.display !== 'none');

        // 2. 텍스처 교체 및 강제 노출
        if(charWorkSprite) {
            charWorkSprite.setTexture(p1_frames[randIdx]);
            if (!player.isPhase2 && isMainScreen) charWorkSprite.setVisible(true);
        }
        
        if(charSuitWorkSprite) {
            charSuitWorkSprite.setTexture(p2_frames[randIdx]);
            // ★ Phase 2이고 메인화면이면 무조건 보이기
            if (player.isPhase2 && isMainScreen) {
                charSuitWorkSprite.setVisible(true);
                charSuitWorkSprite.setDepth(5); // 깊이도 재확인
            }
        }

        // 3. 다음 행동 예약
        let nextDelay = 3000 + Math.floor(Math.random() * 4000);
        sceneContext.time.addEvent({
            delay: nextDelay,
            callback: changePoseRandomly,
            callbackScope: sceneContext
        });
    };

    // 최초 실행 (게임 시작 1초 뒤부터 행동 개시)
    sceneContext.time.addEvent({ delay: 1000, callback: changePoseRandomly });
    // ★★★ [신규] 랜덤 행동 로직 끝 ★★★


    // 4. 오버레이 설정
    let overlayBg = this.add.rectangle(180, 320, 5000, 5000, 0x000000); 
    sceneOverlay = this.add.container(0, 0, [overlayBg, sceneImage]).setVisible(false).setDepth(100);

    let pfBg = this.add.rectangle(180, 320, 5000, 5000, 0x000000).setAlpha(0.8);
    portfolioOverlay = this.add.container(0, 0, [pfBg, pfImg]).setVisible(false).setDepth(101);

    let olBg = this.add.rectangle(180, 320, 5000, 5000, 0x000000).setAlpha(0.7);
    overlayText = this.add.text(180, 320, "", { fontSize: '20px', color: '#fff', align: 'center' }).setOrigin(0.5);
    overlayContainer = this.add.container(0, 0, [olBg, overlayText]).setVisible(false).setDepth(100);

    // 5. 리사이즈
    const resizeAll = () => {
        const w = sceneContext.scale.width;
        const h = sceneContext.scale.height;

        if(bgSprite) fitToScreen(bgSprite);
        if(sceneImage && sceneImage.visible) fitToScreen(sceneImage);
        if(portfolioOverlay && portfolioOverlay.visible && portfolioOverlay.list[1]) {
            fitToScreen(portfolioOverlay.list[1]);
        }
        
        if(charWorkSprite && charWorkSprite.visible) adjustCharacterSize(charWorkSprite, w, h);
        if(charSuitWorkSprite && charSuitWorkSprite.visible) adjustCharacterSize(charSuitWorkSprite, w, h);

        sceneContext.cameras.main.centerOn(w / 2, h / 2);
    };
    resizeAll();
    this.scale.on('resize', resizeAll);

    // 6. 초기화 및 시작
    setupBackButton();
    initPlanningUI(); generateJobs(); updateUI();
    
    if(player.isPhase2) {
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('phase2-ui-layer').style.display = 'flex';
        setBgByTier(player.tier);
    }
    if (isSoundOn && soundIntro && !player.isPhase2) {
        soundIntro.play();
        currentBgm = soundIntro;
    }

}

// [기존 setBgByTier 함수를 이걸로 교체하세요]
function setBgByTier(tier) {
    let bgKey = 'bg_office'; // 기본(Agency)

    if (tier === 'TopTier') bgKey = 'bg_toptier';
    else if (tier === 'Unicorn') bgKey = 'bg_unicorn';
    else if (tier === 'Global') bgKey = 'bg_global';
    else if (tier === 'Space') bgKey = 'bg_space';
    
    // ★★★ [핵심] 밤이면 파일명 뒤에 _night 붙이기
    if (isNightTime()) {
        bgKey += '_night';
    }
    
    if (bgSprite) {
        // 이미지가 실제로 존재하는지 안전 장치 (혹시 오타 났을까봐)
        if (sceneContext.textures.exists(bgKey)) {
            bgSprite.setTexture(bgKey);
        } else {
            console.log("이미지 누락됨:", bgKey); // 콘솔에 경고
            // 밤 이미지가 없으면 낮 이미지라도 보여줌 (오류 방지)
            bgSprite.setTexture(bgKey.replace('_night', '')); 
        }
    }
}

        function update() { updateUI(); }

        let pendingOffer = null;

// [가이드 #5 준수] 앱이 백그라운드로 가면 소리 끄기, 돌아오면 켜기
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // 앱을 나갔을 때: 무조건 음소거
            if(sceneContext && sceneContext.sound) sceneContext.sound.mute = true;
        } else {
            // 앱으로 돌아왔을 때: 유저 설정(isSoundOn)에 따라 복구
            if(sceneContext && sceneContext.sound) sceneContext.sound.mute = !isSoundOn;
            
            // 혹시 BGM이 멈춰있다면 다시 재생 (안전장치)
            if(isSoundOn && currentBgm && !currentBgm.isPlaying) {
                currentBgm.play();
            }
        }
    });

// [수정] 입사 지원 함수 (하향 이직 방지 로직 추가)
window.applyJob = function(name, req, tier) {
    // 0. [신규] 하향 지원 체크 (페이즈 2 경력직만 해당)
    if (player.isPhase2) {
        const tierOrder = ['Agency', 'TopTier', 'Unicorn', 'Global', 'Space'];
        const myIdx = tierOrder.indexOf(player.tier);
        const targetIdx = tierOrder.indexOf(tier);

        // 내 티어보다 낮은 곳 지원 시 (예: Global -> Unicorn)
        if (targetIdx < myIdx) {
            return alert(`[지원 불가] ✋\n경력 관리를 위해 하향 이직은 불가능합니다.\n(현재: ${player.tier} / 대상: ${tier})`);
        }
    }

    // 1. 서류(점수) 컷
    if(player.bestPortfolioScore < req) { 
        return alert(`[지원 불가] 📄\n포트폴리오 점수가 부족합니다.\n(나의 점수: ${player.bestPortfolioScore} / 커트라인: ${req})`); 
    }
    
    // 2. 직급 컷 (경력직 이직 시 확인)
    const targetJob = currentJobList.find(j => j.name === name);
    if (targetJob && targetJob.prevRank && player.rank < targetJob.prevRank) {
        return alert(`[지원 불가] 경력(직급)이 부족합니다.\n현재 직급보다 더 높은 단계의 회사입니다.`);
    }

    // 3. 서류 합격 -> 면접장 이동
    closePopup(); // 채용공고 닫기
    
    let msg = player.isPhase2 
        ? `[서류 통과] 🎉\n"${name}"에서 이직 면접을 제안했습니다.`
        : `[서류 합격] 🎉\n"${name}"에서 면접 제안이 왔습니다!`;

    alert(`${msg}\n면접장으로 이동합니다.`);
    
    // 면접 시작
    setTimeout(() => {
        startInterview(name, tier);
    }, 300);
};

// [수정] 입사 수락 (전면 광고 제거 -> 즉시 이직)
window.acceptOffer = function() {
    // 1. 팝업 닫기
    closePopup();
    
    // 2. [변경] 광고 없이 바로 이직 처리 시작
    console.log("🚀 이직 수락 (전면 광고 생략)");

    // ▼▼▼ 기존 이직 로직 (그대로 유지) ▼▼▼
    const isFirstTime = !player.isPhase2;
    
    // 데이터 갱신
    player.tier = pendingOffer.newTier;
    player.rank = 0; 
    player.hp = 100; // 이직하면 체력 풀충전 (새 출발)
    player.performance = 0;
    updateSalary(); // 연봉 재계산

    // 연출 재생
    if(isFirstTime) {
        // 1페이즈 -> 2페이즈 (엔딩 연출 후 전환)
        playEndingSequence(pendingOffer.name, pendingOffer.score);
    } else {
        // 2페이즈 -> 2페이즈 (회사 이동 연출)
        playTransferSequence(pendingOffer.name);
    }
};

        function playTransferSequence(companyName) {
            player.isBusy = true;
            document.getElementById('phase2-ui-layer').style.display = 'none'; 
            
            const leaveMsgs = ["인수인계서 완벽하게 정리 끝!", "정든 동료들과 작별 인사...", "내 손때 묻은 키보드야 안녕", "이곳에서의 경험이 헛되지 않았기를...", "책상 정리 완료, 가벼운 마음으로 떠납니다"];
            const arriveMsgs = ["새로운 사원증! 초심으로 돌아가보자", "오피스 뷰가 좋네, 영감이 떠오를 듯!", "팀원들이 환영해주니 의욕이 샘솟는다", "더 넓어진 책상, 더 커진 꿈!", "이 회사의 핵심 인재가 되어주겠어"];
            
            const lMsg = leaveMsgs[Math.floor(Math.random()*leaveMsgs.length)];
            const aMsg = arriveMsgs[Math.floor(Math.random()*arriveMsgs.length)];

            playScene(bgSprite.texture.key, ["짐을 쌉니다...", lMsg, "더 높은 곳을 향해!"], () => {
                
                const flash = sceneContext.add.rectangle(180, 320, 360, 640, 0x000000).setDepth(200).setAlpha(0);
                sceneContext.tweens.add({
                    targets: flash, alpha: 1, duration: 800, yoyo: true, hold: 500,
                    onYoyo: () => {
                        setBgByTier(player.tier); 
                    },
                    onComplete: () => {
                        flash.destroy();
                        document.getElementById('phase2-ui-layer').style.display = 'flex';
                        player.isBusy = false;
                        player.currentProject = null;
                        assignProject(); 
                        alert(`[이직 완료]\n${companyName}에 첫 출근했습니다.\n"${aMsg}"`);
                        updateUI();
                    }
                });
            });
        }

        window.testEnding = function() {
            if(confirm("엔딩 시퀀스를 재생하시겠습니까? (테스트 데이터)")) {
                playEndingSequence('(주)테스트 컴퍼니', 99999);
            }
        }

        function playEndingSequence(companyName, requiredScore) {
            player.isBusy = true;
    // 1. 사운드 처리
    if(soundP1 && soundP1.isPlaying) {
        soundP1.stop();
    }
    if(isSoundOn && soundEnding) {
        soundEnding.play();
    }
    
    player.isBusy = true;
    document.getElementById('ui-layer').style.opacity = '0'; // UI 숨김
    
    // ★★★ [핵심 수정] 엔딩 시작 시 '일하는 캐릭터' 강제로 숨기기 ★★★
    if(charWorkSprite) charWorkSprite.setVisible(false);
    if(charSuitWorkSprite) charSuitWorkSprite.setVisible(false);
    
    // 혹시 켜져 있을지 모르는 서있는 캐릭터들도 일단 숨김 (애니메이션에서 다시 켤 것임)
    if(charHoodieSprite) charHoodieSprite.setVisible(false);
    if(charSuitSprite) charSuitSprite.setVisible(false);
    
    // 2. 화면 중앙 좌표 계산
    const centerX = sceneContext.scale.width / 2;
    const centerY = sceneContext.scale.height / 2;

    // 3. 화이트 플래시 효과
    const flash = sceneContext.add.rectangle(centerX, centerY, 5000, 5000, 0xFFFFFF).setDepth(200).setAlpha(0);
    
    sceneContext.tweens.add({
        targets: flash,
        alpha: 1,
        duration: 600,
        yoyo: true,
        hold: 200,
        onYoyo: () => {
            // [화면이 하얗게 되었을 때 실행]
            
            // 배경을 '빈 방'으로 교체
            bgSprite.setTexture('bg_empty_room');
            fitToScreen(bgSprite); 

            // ★★★ 엔딩용 캐릭터(후드 서있는 모습) 등장 및 위치/크기 조정 ★★★
            // 아까 만든 adjustCharacterSize 함수를 쓰거나, 직접 설정
            charHoodieSprite.setVisible(true);
            
            // 엔딩 연출을 위해 조금 더 크게(기본 크기) 설정하거나 조정
            // 여기서는 기존 adjustCharacterSize 비율을 따르도록 설정
            adjustCharacterSize(charHoodieSprite, sceneContext.scale.width, sceneContext.scale.height);
            
        },
        onComplete: () => {
            flash.destroy();
            
            // 4. 옷 갈아입는 애니메이션 (후드 -> 정장)
            sceneContext.tweens.add({
                targets: charHoodieSprite,
                scaleX: 0, // 홀쭉해지면서 사라짐
                duration: 300,
                onComplete: () => {
                    charHoodieSprite.setVisible(false);
                    
                    // 정장 캐릭터 등장
                    charSuitSprite.setVisible(true);
                    charSuitSprite.scaleX = 0; // 0에서 시작
                    
                    // 위치/크기 맞춤
                    adjustCharacterSize(charSuitSprite, sceneContext.scale.width, sceneContext.scale.height);
                    charSuitSprite.scaleX = 0; // 다시 0으로 (adjust 때문에 커졌을 수 있음)

                    sceneContext.tweens.add({
                        targets: charSuitSprite,
                        scaleX: charHoodieSprite.scaleY, // 원래 비율대로 커짐
                        duration: 800,
                        ease: 'Back.out',
                        onComplete: () => {
                            setTimeout(() => {
                                showSuccessPopup(companyName);
                            }, 500);
                        }
                    });
                }
            });
        }
    });
}
function showSuccessPopup(companyName) {
    // 1. 엔딩 시점 점수 서버 제출 (기존 로직 유지)
    submitTossScore();

    // 2. 회사 이름만 업데이트
    document.getElementById('success-company').innerText = companyName;
    
    // (점수 표시 코드 삭제됨)

    // 3. 팝업 열기
    const popup = document.getElementById('success-popup');
    popup.style.display = 'flex'; 
    player.isBusy = false;
}
        
// [수정] 프로젝트 할당 (SSS급 엔딩 프로젝트 추가)
function assignProject() {
    let tier = 'B';
    let theme = "";
    let isMasterpiece = false;
    let isSingularity = false; // SSS급 플래그

    // -----------------------------------------------------------
    // [1순위] SSS급: 박물관 10개 수집 완료 시 강제 발동
    // -----------------------------------------------------------
    if (player.museum && player.museum.length >= 10 && !player.isEndingSeen) {
        tier = 'SSS';
        theme = "Project: Singularity (특이점)";
        isSingularity = true;
    }
    // [2순위] SS급: Space 티어 + 박물관 미완성 + 15% 확률
    else if (player.tier === 'Space' && (!player.museum || player.museum.length < 10) && Math.random() < 0.15) {
        tier = 'SS';
        isMasterpiece = true;
        
        const collectedNames = player.museum ? player.museum.map(m => m.name) : [];
        const available = masterpiecePool.filter(m => !collectedNames.includes(m.name));
        
        if (available.length > 0) {
            const pick = available[Math.floor(Math.random() * available.length)];
            theme = pick.name; 
        } else {
            tier = 'S'; isMasterpiece = false;
        }
    } 
    // [3순위] 일반 프로젝트
    else {
        const tiers = ['S', 'A', 'B'];
        tier = tiers[Math.floor(Math.random() * tiers.length)];
        const pool = projectPools[player.tier] || projectPools['Agency'];
        theme = pool[Math.floor(Math.random() * pool.length)];
    }

    // -----------------------------------------------------------
    // 2. 마감 기한 설정
    // -----------------------------------------------------------
    let dead = 0;
    if (tier === 'SSS') {
        dead = 15; // SSS급: 15주 (최장 기간)
    } else if (tier === 'SS') {
        dead = 12; // SS급: 12주
    } else if (tier === 'S' || tier === 'A') {
        dead = Math.floor(Math.random() * 2) + 8; // 8~9주
    } else {
        dead = Math.floor(Math.random() * 2) + 6; // 6~7주
    }
    
    // 3. 버프 타입 (SSS급은 모든 버프 복합)
    let type = 'fame'; 
    if (isSingularity) type = 'all'; 
    else if (theme.includes("쇼핑") || theme.includes("금융")) type = 'wealth';
    else if (theme.includes("앱") || theme.includes("게임")) type = 'speed';
    
    // 4. 라이벌 등장 (SSS급, SS급일 때는 라이벌 안 나옴 - 독무대)
    let isRivalMatch = false;
    let rivalScoreTarget = 0;
    let rivalName = "";

    if (!isSingularity && !isMasterpiece && (player.tier === 'Global' || player.tier === 'Space') && Math.random() < 0.2) {
        isRivalMatch = true;
        rivalName = "🤖 Alpha-D";
        let tierMult = player.tier === 'Space' ? 50 : 20;
        let baseScore = (tier === 'S' ? 500 : (tier === 'A' ? 300 : 100));
        rivalScoreTarget = Math.floor(baseScore * tierMult * (1.1 + Math.random() * 0.3));
        openRivalWarningPopup(rivalScoreTarget); 
    }

    // 5. 데이터 저장
    player.currentProject = {
        name: theme,
        tier: tier,
        companyTier: player.tier, 
        originalTier: tier,
        progress: 0,
        deadline: dead,
        currentWeek: 0, 
        isExtended: false,
        meetingDone: false, 
        progMult: 1.0, 
        costMult: 1.0,
        strategyName: "미정",
        buffType: type,
        isRival: isRivalMatch,
        rivalName: rivalName,
        rivalTarget: rivalScoreTarget,
        isMasterpiece: isMasterpiece,
        isSingularity: isSingularity // ★ SSS급 식별자
    };
    
    let logMsg = `[${player.tier}] 신규 ${tier}급 업무 할당! (마감 D-${dead})`;
    if (isSingularity) logMsg = `🌌 [EVENT] 최후의 프로젝트 "특이점" 시작!`;
    else if (isMasterpiece) logMsg = `✨ [전설] 걸작 의뢰 도착: "${theme}"`;
    else if (isRivalMatch) logMsg = `🔥 VS Alpha-D 경쟁 프로젝트 시작!`;
    
    showP2Log(logMsg);
    
   // ▼▼▼ [수정] 단순 알림(alert) 대신 컷신 함수 호출 ▼▼▼
    if(isSingularity) {
        showSSSIntro(); // 멋진 컷신 발동!
    }
}
// [수정] 페이즈 2 업무 수행 (위기 상황 발동 추가)
window.doP2Work = function() {
    if (!player.currentProject) return;
    
    // 1. 미팅 체크
    if (typeof player.currentProject.meetingDone === 'undefined') {
        player.currentProject.meetingDone = false;
        player.currentProject.progMult = 1.0;
        player.currentProject.costMult = 1.0;
        player.currentProject.strategyName = "미정";
    }

    if (!player.currentProject.meetingDone) {
        const msgList = (typeof clientMentions !== 'undefined') ? clientMentions : ["요구사항 확인 중..."];
        const msg = msgList[Math.floor(Math.random() * msgList.length)];
        const msgEl = document.getElementById('client-msg');
        if(msgEl) msgEl.innerText = msg;
        openPopup('meeting-popup');
        return; 
    }

    // 2. 비용 계산
    let baseCost = 20; 
    let mult = player.currentProject.costMult || 1.0;
    let finalCost = Math.floor(baseCost * mult);

    if(player.hp < finalCost) return alert(`체력이 부족합니다. (필요 ${finalCost})`);

    // ▼▼▼ [핵심 추가] 5% 확률로 '응답 없음' 위기 발동! ▼▼▼
    if (Math.random() < 0.07) { 
        startCrisisGame(); // 위기 발생 (경고창 -> 게임)
        return; // 여기서 중단 (성공 시 resumeGameWork 호출됨)
    }
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    // 3. 정상 업무 진행
    realWork(player.currentProject.progMult, finalCost, player.currentProject.strategyName);
}

// [4-2] 미팅 전략 선택
window.confirmMeeting = function(strategy) {
    closePopup();
    
    if (strategy === 'yesman') {
        player.currentProject.progMult = 1.5;
        player.currentProject.costMult = 2.0;
        player.currentProject.strategyName = "🔥무리한 수용";
    } else if (strategy === 'pro') {
        player.currentProject.progMult = 1.0;
        player.currentProject.costMult = 1.0;
        player.currentProject.strategyName = "👔정석 진행";
    } else if (strategy === 'ignore') {
        player.currentProject.progMult = 0.6;
        player.currentProject.costMult = 0.7;
        player.currentProject.strategyName = "🛡️현실 타협";
    }

    player.currentProject.meetingDone = true;
    doP2Work(); // 설정 끝났으니 바로 업무 1회 실행
}

// [수정] 업무 수행 (SSS급 난이도 추가)
function realWork(progMult, finalCost, strategyName) {
    playScene(bgSprite.texture.key, msgs.work, () => {
        player.hp -= finalCost;
        
        const tierCoef = { Agency: 3, TopTier: 5.5, Unicorn: 10, Global: 15, Space: 25 };
        let baseDiff = tierCoef[player.tier] || 3;
        let rankDiffMult = 1 + (player.rank * 0.25);
        let difficulty = Math.floor(baseDiff * rankDiffMult);

        let base = 30; 
        let statBonus = Math.floor(player.designStat * 0.06); 
        let itemBonus = player.currentPower || 0;
        let totalPower = base + statBonus + itemBonus;

        showFloatingText(180, 280, `-${finalCost} HP`, '#FF5F5F');

        let prog = Math.max(1, Math.floor(totalPower / difficulty));

        // ▼▼▼ [핵심] 등급별 난이도 패널티 ▼▼▼
        if (player.currentProject.tier === 'SSS') {
            prog = Math.ceil(prog * 0.2); // ★ SSS급: 20% 속도 (극악)
        } 
        else if (player.currentProject.tier === 'SS') {
            prog = Math.ceil(prog * 0.4); // SS급: 40%
        } 
        else if (player.currentProject.tier === 'S') {
            prog = Math.ceil(prog * 0.6); 
        } 
        else if (player.currentProject.tier === 'A') {
            prog = Math.ceil(prog * 0.7); 
        }

        prog = Math.ceil(prog * progMult);

        if (typeof getHofBuffs === 'function') {
            let speedBuff = getHofBuffs().speed; 
            if (speedBuff > 0) prog = Math.ceil(prog * (1 + speedBuff/100));
        }
        
        prog = Math.max(1, prog);
        player.currentProject.progress += prog;
        
        showFloatingText(180, 240, `+${prog}%`, '#3182F6');

        if(player.currentProject.progress >= 100) {
            completeProject();
        } else {
            showP2Log(`[${strategyName}] 진행도 +${prog}%...`); 
            addTime(true); 
        }
    }, true);
}
// [수정] 프로젝트 완료 (SSS급 진 엔딩 로직 포함)
function completeProject() {
    let tier = player.currentProject.tier;
    
    // ============================================================
    // 🌌 [진 엔딩] SSS급 특이점 프로젝트 완료 시
    // ============================================================
    if (player.currentProject.isSingularity) {
        // 1. 엔딩 플래그 세우기
        player.isEndingSeen = true; 
        player.rank = 4; // 0:사원, 1:대리, 2:팀장, 3:이사, 4:전설(Legend)
        
        // 2. 보상: 막대한 부와 명예
        player.money += 9999999999; // 돈 걱정 끝
        player.performance = 100;   // 성과 MAX
        
        // 3. AI 영입 (데이터에 기록)
        player.hasAiAssistant = true; 

        // 4. 엔딩 팝업 출력
        let statList = [
            { label: "최종 점수", val: "측정 불가 (∞)", color: "#FFD700" },
            { label: "칭호 획득", val: "The Legend", color: "#FFD700" },
            { label: "특전", val: "🤖 Alpha-D 영입", color: "#3182F6" }
        ];

        openResultPopup('success', 
            "🌌 특이점(Singularity) 도달", 
            "🤖 Alpha-D:\n\"당신의 승리입니다. 데이터로 설명할 수 없는\n인간의 '영혼'을 보았습니다.\n\n이제부터 당신을 '마스터'로 모시겠습니다.\"", 
            statList
        );
        
        // 5. 엔딩 사운드 재생
        if(isSoundOn && soundEnding) soundEnding.play();

        // 6. 프로젝트 초기화
        player.currentProject = null;
        
        // 7. 저장 및 UI 갱신
        saveGameData();
        updateUI();
        
        // 8. 추가 안내 (팝업 닫은 후를 대비해 로그 남김)
        setTimeout(() => {
            alert("🏆 [THE LEGEND] 등극을 축하합니다!\n\n이제부터는 [무한 모드]가 시작됩니다.\nAI 비서의 도움을 받아 최고 점수에 도전하세요!");
        }, 1000);

        return; // ★ 여기서 함수 종료 (아래 일반 로직 실행 X)
    }

    // ============================================================
    // 아래는 기존 일반/SS급/라이벌 로직 (그대로 유지)
    // ============================================================
    
    let tierMult = 1;
    if (player.tier === 'Space') tierMult = 50;
    else if (player.tier === 'Global') tierMult = 20;
    else if (player.tier === 'Unicorn') tierMult = 8; 
    else if (player.tier === 'TopTier') tierMult = 3; 

    let baseScore = (tier === 'SS' ? 1500 : (tier === 'S' ? 500 : (tier === 'A' ? 300 : 100)));
    let rawScore = baseScore * tierMult;

    let randomFactor = 0.8 + (Math.random() * 0.4); 
    let isViral = false;
    if (tier === 'S' && Math.random() < 0.1) { isViral = true; randomFactor += 0.3; }

    let rankBonus = 1 + (player.rank * 0.05);
    let finalScore = Math.floor(rawScore * randomFactor * rankBonus);

    if (player.currentProject.isRival) {
        let target = player.currentProject.rivalTarget;
        if (finalScore >= target) {
            let bonusMoney = 100000000; 
            player.money += bonusMoney;
            player.performance += 20; 
        } else {
            player.hp = Math.floor(player.hp / 2);
            player.performance = Math.max(0, player.performance - 10);
            let statList = [
                { label: "내 점수", val: `${finalScore.toLocaleString()}점`, color: "#B0B8C1" },
                { label: "AI 점수", val: `${target.toLocaleString()}점`, color: "#FF5F5F" },
                { label: "결과", val: "패배 (회수됨)", color: "#FF5F5F" }
            ];
            openResultPopup('fail', "🤖 COMPETITION LOST", "점수 미달로 프로젝트가 회수됩니다.", statList);
            player.currentProject = null; 
            return; 
        }
    }

    if (!player.seasonBestScore) player.seasonBestScore = 0;
    if (finalScore > player.seasonBestScore) player.seasonBestScore = finalScore;

    let basePromo = tier === 'SS' ? 50 : (tier === 'S' ? 20 : (tier === 'A' ? 10 : 5));
    let finalPromo = Math.floor(basePromo * (1 + (player.rank * 0.1)));
    player.performance += finalPromo;
    
    let historyName = player.currentProject.name;
    if (isViral) historyName = "🔥 " + historyName;
    if (tier === 'SS') historyName = "🏛️ " + historyName;

    player.history.push({ 
        name: historyName, 
        score: finalScore, 
        grade: tier,
        companyTier: player.currentProject.companyTier || player.tier,
        buffType: player.currentProject.buffType || 'fame'
    });
    if(finalScore > player.bestPortfolioScore) player.bestPortfolioScore = finalScore;

    if (player.currentProject.isMasterpiece) {
        if (!player.museum) player.museum = [];
        const exists = player.museum.some(m => m.name === player.currentProject.name);
        if (!exists) {
            player.museum.push({
                name: player.currentProject.name,
                desc: (typeof masterpiecePool !== 'undefined') 
                      ? (masterpiecePool.find(m => m.name === player.currentProject.name)?.desc || "전설의 유물") 
                      : "전설의 유물",
                score: finalScore,
                date: `${player.totalWeeks}주차`
            });
        }

        let statList = [
            { label: "역사적 가치", val: `${finalScore.toLocaleString()}점`, color: "#FFD700" },
            { label: "명성", val: `+${finalPromo} (Ultra)`, color: "#FFD700" },
            { label: "보상", val: "박물관 등록 완료", color: "#4CD964" }
        ];
        openResultPopup('success', `🏛️ 걸작(Masterpiece) 탄생!`, `위대한 업적을 달성했습니다.\n"${player.currentProject.name}"이(가) 박물관에 전시됩니다.`, statList);
        if(isSoundOn && soundEnding) soundEnding.play();

    } else {
        let msg = `(점수: ${finalScore.toLocaleString()} / 고과 +${finalPromo})`;
        if (isViral) msg += `\n🔥 대박 터짐! 시장 반응 폭발!`;
        else if (player.currentProject.isRival) msg += `\n🤖 AI와의 경쟁에서 승리했습니다!`;

        let statList = [
            { label: "최종 점수", val: `${finalScore.toLocaleString()}점`, color: "#FFD700" },
            { label: "인사 고과", val: `+${finalPromo}` }
        ];
        if (player.currentProject.isRival) statList.push({ label: "승리 보너스", val: "+1억 원", color: "#3182F6" });

        openResultPopup('success', `[${tier}급] 결재 승인!`, msg, statList);
    }

    player.currentProject = null; 
}

// [수정] 마감 실패 처리 (SSS급 전용 패배 연출 추가)
function rejectProject() {
    // ============================================================
    // 1. [SSS급] 특이점 프로젝트 실패 시 (Game Over급 연출)
    // ============================================================
    if (player.currentProject.isSingularity) {
        // 1. 패널티: 멘탈 1로 만듦 (빈사 상태) + 성과 대폭 하락
        player.hp = 1; 
        player.performance = Math.max(0, player.performance - 50);

        // 2. 실패 리포트
        let statList = [
            { label: "검증 결과", val: "불합격 (FAIL)", color: "#FF5F5F" },
            { label: "멘탈 상태", val: "붕괴 (HP 1)", color: "#FF5F5F" },
            { label: "패널티", val: "프로젝트 초기화", color: "#B0B8C1" }
        ];

        // 3. 팝업 호출 (Alpha-D의 차가운 대사)
        openResultPopup('fail', 
            "🤖 SYSTEM ERROR", 
            "Alpha-D:\n\"실망스럽군요. 당신의 데이터에서는\n어떠한 가능성도 발견되지 않았습니다.\n\n(기회를 다시 얻으려면 회복하십시오.)\"", 
            statList
        );

        // 4. 프로젝트 삭제 (팝업 닫으면 assignProject가 다시 SSS급을 줌 -> 재도전)
        player.currentProject = null;
        
        updateUI();
        return; // ★ 함수 종료
    }

    // ============================================================
    // 2. [라이벌] 경쟁 패배 시 (기존 로직)
    // ============================================================
    if (player.currentProject.isRival) {
        player.hp = Math.floor(player.hp / 2); 
        let penalty = 20;
        player.performance = Math.max(0, player.performance - penalty);

        let statList = [
            { label: "경쟁 결과", val: "패배 (Time Over)", color: "#FF5F5F" },
            { label: "인사 고과", val: `-${penalty}`, color: "#FF5F5F" },
            { label: "멘탈", val: "손상됨 (-50%)", color: "#FF5F5F" }
        ];

        openResultPopup('fail', "🤖 COMPETITION LOST", "AI가 먼저 결과물을 제출했습니다.\n당신의 프로젝트는 즉시 폐기됩니다.", statList);
        player.currentProject = null;
        updateUI();
        return; 
    }

    // ============================================================
    // 3. [일반] S/A/B/C급 마감 실패 (기존 강등 로직)
    // ============================================================
    let curr = player.currentProject.tier;
    player.hp = Math.floor(player.hp / 2); 

    // [C급 삼진아웃 로직]
    if (curr === 'C') {
        if (typeof player.currentProject.rejectCount === 'undefined') player.currentProject.rejectCount = 0;
        player.currentProject.rejectCount++;

        if (player.currentProject.rejectCount >= 3) {
            let penalty = 15;
            player.performance = Math.max(0, player.performance - penalty);
            alert(`⛔ [프로젝트 폐기 처분]\n(3회 연속 실패로 업무 회수됨 / 성과 -${penalty})`);
            player.currentProject = null;
            assignProject();
            updateUI();
            return;
        }

        player.performance = Math.max(0, player.performance - 1);
        player.currentProject.deadline += 1; 
        player.currentProject.progress = 0;
        player.currentProject.currentWeek = 0;
        
        alert(`⛔ [C급] 업무 실패! (경고 ${player.currentProject.rejectCount}/3)\n(성과 -1, 멘탈 반토막)\n\n"기회를 한번 더 줍니다. 3번 실패하면 프로젝트는 폐기됩니다."`);
    }
    // [S~B급 강등 로직]
    else {
        let next = curr === 'S' ? 'A' : (curr === 'A' ? 'B' : 'C');
        let penalty = 0;
        if (player.rank > 0) {
            penalty = (player.rank * 2) + 1;
            player.performance = Math.max(0, player.performance - penalty);
        }

        player.currentProject.tier = next;
        player.currentProject.progress = 0;
        player.currentProject.currentWeek = 0;
        player.currentProject.rejectCount = 0;

        if (next === 'A') player.currentProject.deadline = Math.floor(Math.random() * 3) + 6; 
        else player.currentProject.deadline = Math.floor(Math.random() * 2) + 6; 

        let msg = `⛔ 마감 초과! 등급 하락 [${curr} -> ${next}]\n(멘탈 반토막`;
        if (penalty > 0) msg += `, 성과 -${penalty})`;
        else msg += `)`;

        let statList = [];
        if (penalty > 0) statList.push({ label: "인사 고과", val: `-${penalty}`, color: "#FF5F5F" });
        statList.push({ label: "멘탈 손상", val: "-50%", color: "#FF5F5F" });

        openResultPopup('fail', "마감 실패 (강등)", msg, statList);
    }
    
    updateUI();
}

// [수정] 시간 경과 (연말 어워드 개최 로직 추가)
function addTime(workDone = true) {
    player.totalWeeks++; 
    player.workedThisWeek = false;

    // [어워드 카운트]
    if (!player.weeksSinceAward) player.weeksSinceAward = 0;
    player.weeksSinceAward++;

    // 1년(48주)마다 디자인 어워드 개최
    if (player.weeksSinceAward >= 48) {
        triggerDesignAward();
        player.weeksSinceAward = 0; // 카운트 초기화
    }

    // (이하 기존 로직 동일: 공백기 잔소리, 월급날, 마감 체크 등)
    if (!player.isPhase2 && !player.isProjectStarted) {
        if (!player.idleWeeks) player.idleWeeks = 0;
        player.idleWeeks++;
        if (player.idleWeeks >= 4) triggerNaggingEvent();
    } else {
        player.idleWeeks = 0;
    }

    let isPayDay = (player.totalWeeks % 30 === 0); 
    if (isPayDay) {
        let monthlyIncome = 0;
        let monthlyCost = 0;
        let costName = "기타 비용";

        if (player.isPhase2) {
            monthlyIncome = Math.floor(player.salary * 4.5);
            const costTable = { Agency: 300000, TopTier: 600000, Unicorn: 1400000, Global: 20000000, Space: 200000000 };
            let base = costTable[player.tier] || 500000;
            let rankMult = 1 + (player.rank * 0.2);
            monthlyCost = Math.floor(base * rankMult);
            costName = "세금 및 품위 유지비";
        } else {
            monthlyIncome = 0;
            monthlyCost = 150000;
            costName = "생활비 (식비/통신비)";
        }

        player.money += monthlyIncome;
        if (player.money >= monthlyCost) player.money -= monthlyCost;
        else player.money = 0; 

        setTimeout(() => {
            openPaydayPopup(monthlyIncome, monthlyCost, costName);
        }, 300); 
    }

    if(!player.isPhase2 && player.isProjectStarted) { 
        player.currentWeekInProject++; 
        if(player.currentWeekInProject >= player.deadline) finishProject(); 
    }
    
    if(player.isPhase2 && player.currentProject) { 
        player.currentProject.currentWeek++;
        if(player.currentProject.currentWeek > player.currentProject.deadline) rejectProject();
    }
    
    if(player.isPhase2 && player.performance >= 100) {
        if(player.rank < 3) { 
            player.rank++;
            player.performance = 0;
            updateSalary();
            alert(`🎉 [${RANKS[player.rank]}]로 승진! 연봉 협상 완료!`);
        } else { 
            player.performance = 0;
            let bonus = Math.floor(player.salary * 2.5);
            player.money += bonus;
            alert(`🎉 임원 성과급 지급! (+${bonus.toLocaleString()}원)`);
        }
    }

    if(player.totalWeeks % 60 === 0) { 
        generateJobs(); 
        if(document.getElementById('job-popup').style.display === 'flex') openJobMarket(); 
    }
    
    saveGameData(); 
    updateUI();
}

// [수정] openPaydayPopup 함수 (항목 이름표시 추가)
// costName 파라미터 추가됨
window.openPaydayPopup = function(income, cost, costName="세금 및 품위 유지비") {
    
    document.getElementById('pay-income').innerText = `+ ${income.toLocaleString()}`;
    
    // 지출 항목 이름 변경 로직
    // HTML에 <span id="pay-cost-label">...</span> 태그가 없으므로
    // pay-cost 요소의 형제 요소(텍스트)를 바꿔야 합니다. 
    // 가장 쉬운 방법: HTML 구조를 살짝 건드리지 않고 JS로 처리
    
    const costLabel = document.querySelector('#pay-cost').previousElementSibling;
    if(costLabel) costLabel.innerText = `(-) ${costName}`;

    document.getElementById('pay-cost').innerText = `- ${cost.toLocaleString()}`;
    
    let total = income - cost;
    let color = total >= 0 ? '#3182F6' : '#FF5F5F';
    let sign = total >= 0 ? '+' : '';
    
    document.getElementById('pay-total').innerText = `${sign} ${total.toLocaleString()}`;
    document.getElementById('pay-total').style.color = color;

    // 멘트 설정
    let msg = "이번 달도 고생 많으셨습니다.";
    if(total < 0) msg = "⚠️ 잔고가 줄어들고 있습니다. (적자)";
    else if(total > 10000000) msg = "💰 금융 치료가 완료되었습니다.";
    
    document.getElementById('pay-msg').innerText = msg;
    
    openPopup('payday-popup');
}

function updateSalary() {
    let base = BASE_SALARY[player.tier] || 180000;
    let multi = RANK_MULTIPLIER[player.rank] || 1;
    
    // [NEW] 명예의 전당(Wealth) 버프 적용
    let buff = getHofBuffs().wealth; // 예: 3, 6, 9
    let buffMult = 1 + (buff / 100);

    player.salary = Math.floor(base * multi * buffMult);
}

   // [Ver 67.0] UI 날짜 표시 변경 (주 -> 일)
// [수정된 updateUI 함수] : 날짜 및 직급 표시 로직 변경
function updateUI() {
    // 1년 = 360일, 1달 = 30일 기준 계산
    let totalDays = player.totalWeeks; 
    let y = Math.floor(totalDays / 360) + 1;
    let m = Math.floor((totalDays % 360) / 30) + 1;
    let d = (totalDays % 30) + 1;
    
    let dateStr = `${y}년 ${m}월 ${d}일`;

    if(!player.isPhase2) { 
        // Phase 1 UI
        if(document.getElementById('ui-money')) {
            document.getElementById('ui-week').innerText = dateStr;
            document.getElementById('ui-money').innerText = player.money.toLocaleString();
            document.getElementById('hp-bar').style.width = player.hp + "%";
            document.getElementById('exp-bar').style.width = (player.designStat % 100) + "%";
            document.getElementById('ui-lv').innerText = Math.floor(player.designStat / 100) + 1;
            document.getElementById('pf-bar').style.width = Math.min(player.portfolioProgress, 100) + "%";
            // ▼▼▼ [수정] 직급 배지 표시 로직 ▼▼▼
            const rankEl = document.getElementById('p2-rank-badge');
            if(rankEl) {
                if (player.isEndingSeen) {
                    // 엔딩 본 사람은 황금색 'The Legend' 칭호
                    rankEl.innerText = `👑 The Legend (${player.tier})`;
                    rankEl.style.backgroundColor = "rgba(255, 215, 0, 0.3)";
                    rankEl.style.borderColor = "#FFD700";
                    rankEl.style.color = "#FFD700";
                } else {
                    // 일반인은 기존대로
                    rankEl.innerText = `${RANKS[player.rank]} (${player.tier})`;
                    // 스타일 원상복구 (혹시 모르니)
                    rankEl.style.backgroundColor = ""; 
                    rankEl.style.borderColor = "";
                    rankEl.style.color = ""; 
                }
            }
            // ... (버튼 로직 기존 유지) ...
            const btn = document.getElementById('btn-work');
            if(player.isProjectStarted) {
                btn.querySelector('div').innerText="포폴 작업"; 
                let left = player.deadline - player.currentWeekInProject;
                btn.querySelector('span').innerText=`마감 D-${left}`; 
                btn.style.backgroundColor="#FF8B8B";
                document.getElementById('ui-deadline').innerText = `마감 D-${left}`;
            } else {
                btn.querySelector('div').innerText="새 프로젝트"; 
                btn.querySelector('span').innerText="기획하기"; 
                btn.style.backgroundColor="#FF8B8B";
                document.getElementById('ui-deadline').innerText = "";
            }
        }
    } else { 
        // Phase 2 UI
        if(document.getElementById('p2-ui-money')) {
            // [수정] 날짜에서 티어 제거 -> 그냥 날짜만 표시
            document.getElementById('p2-ui-week').innerText = dateStr; 
            
            document.getElementById('p2-ui-money').innerText = player.money.toLocaleString();
            
            let maxHp = getMaxHp();
            let hpPercent = Math.min(100, (player.hp / maxHp) * 100);
            document.getElementById('p2-mental-bar').style.width = hpPercent + "%"; 
            
            document.getElementById('p2-skill-bar').style.width = (player.designStat%100)+"%"; 
            document.getElementById('p2-ui-lv').innerText = Math.floor(player.designStat/100)+1;
            document.getElementById('p2-perf-bar').style.width = Math.min(player.performance,100)+"%";
            
            // [수정] 직급 뱃지에 회사 티어 표시 -> "사원 (Agency)"
            const rankEl = document.getElementById('p2-rank-badge');
            if(rankEl) {
                rankEl.innerText = `${RANKS[player.rank]} (${player.tier})`;
            }
            const musBtn = document.getElementById('btn-museum');
            if(musBtn) {
                // Space 티어이거나, 이미 유물을 하나라도 모았다면 보임
                if (player.tier === 'Space' || (player.museum && player.museum.length > 0)) {
                    musBtn.style.display = 'block'; // 버튼 보이기
                } else {
                    musBtn.style.display = 'none';  // 버튼 숨기기
                }
            }
            renderProjectWidget();
        }
    }
}
// [수정] 프로젝트 위젯 (AI 라이벌 모드 시각화 강화)
function renderProjectWidget() {
    const w = document.getElementById('p2-project-widget');
    
    // 1. 프로젝트 없으면 숨김
    if(!player.currentProject) { 
        w.style.display='none'; 
        w.classList.remove('rival-mode'); // 클래스 초기화
        return; 
    }
    
    w.style.display = 'block';
    
    const proj = player.currentProject;
    
    // 2. [핵심] 라이벌 모드인지 체크하여 스타일 적용
    if (proj.isRival) {
        w.classList.add('rival-mode');
        document.querySelector('#p2-project-widget h4').innerText = "🚨 WARNING: AI RIVALRY";
    } else {
        w.classList.remove('rival-mode');
        document.querySelector('#p2-project-widget h4').innerText = "Current Project";
    }

    // 3. 기본 정보 표시
    document.getElementById('pw-title').innerText = `${proj.name} (${proj.tier}급)`;
    let left = proj.deadline - proj.currentWeek;
    document.getElementById('pw-day').innerText = left < 0 ? 0 : left;
    
    let per = Math.min(100, Math.floor(proj.progress));
    document.getElementById('pw-percent').innerText = per + "%";
    document.getElementById('pw-bar').style.width = per + "%";
    
    // 4. [신규] 라이벌 목표 점수 표시 (위젯 하단에 추가)
    // 기존에 있던 스탬프나 버튼 아래에 정보를 띄웁니다.
    let rivalInfoHtml = "";
    if (proj.isRival) {
        rivalInfoHtml = `
            <div class="rival-target-score">
                <span>🤖 Alpha-D</span>
                <span>Target: ${proj.rivalTarget.toLocaleString()}</span>
            </div>
        `;
    }
    
    // 위젯 내부 HTML 갱신 (스탬프, 버튼 등 기존 요소 유지하면서 라이벌 정보 추가)
    // 기존 구조: h4 -> pw-title -> pw-info -> pw-bar-bg -> pw-stamp -> extend-btn
    // 여기서 pw-bar-bg 바로 아래에 rivalInfo를 끼워넣습니다.
    
    const barBg = w.querySelector('.pw-bar-bg');
    
    // 이미 추가된 라이벌 정보가 있다면 삭제 (중복 방지)
    const oldRivalInfo = w.querySelector('.rival-target-score');
    if(oldRivalInfo) oldRivalInfo.remove();

    if(proj.isRival) {
        barBg.insertAdjacentHTML('afterend', rivalInfoHtml);
    }

    document.getElementById('pw-stamp').style.opacity = proj.tier !== proj.originalTier ? 1 : 0; 

    // 마감 임박 버튼 표시 로직 (기존 유지)
    const extBtn = document.getElementById('pw-extend-btn');
    if (extBtn) {
        if (left <= 1 && per < 100 && !proj.isExtended) {
            extBtn.style.display = 'block';
            extBtn.style.animation = 'blink 1s infinite alternate'; 
        } else {
            extBtn.style.display = 'none';
            extBtn.style.animation = 'none';
        }
    }
}

        window.openExtensionPopup = function() {
            openPopup('extension-popup');
        }

// [수정] 마감 연장 실행 (디자인된 팝업 호출)
window.doExtendDeadline = function() {
    // 1. 기존 연장 팝업 닫기
    const extPopup = document.getElementById('extension-popup');
    if(extPopup) extPopup.style.display = 'none';
    closePopup(); 

    // 2. 로직 처리
    if (player.currentProject && !player.currentProject.isExtended) {
        player.currentProject.deadline += 1; 
        player.currentProject.isExtended = true; 
        
        // ★ [핵심] 기존 alert 대신 새 팝업 열기
        openPopup('extension-success-popup');
        
        // 효과음 (성공음)
        if(isSoundOn && typeof soundClick !== 'undefined') soundClick.play();
        
        updateUI(); 
    }
};

/* [수정] 컷신 재생 함수 (알바, 휴식, 공부, 업무 등 공용) */
/* [수정] 컷신 재생 함수 (업무, 알바, 휴식 등 공용) */
// [수정] 컷신 재생 함수 (음악 유지 기능 적용 완료)
function playScene(key, msgs, cb, keepBgm = false) {
    player.isBusy = true; 
    
    // ▼▼▼ [수정 1] 음악 유지 옵션이 켜져 있으면 끄지 않음
    if (!keepBgm) {
        updateAudioState('mute');
    }
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    // 1. UI 숨김
    document.getElementById(player.isPhase2 ? 'phase2-ui-layer' : 'ui-layer').style.display = 'none';
    
    // 2. 배경 설정 (Phaser)
    let tex = key; 
    if(!sceneContext.textures.exists(tex)) tex = 'bg_main'; 
    
    sceneImage.setTexture(tex); 
    fitToScreen(sceneImage); 
    
    // 배경막 켜기
    sceneOverlay.setVisible(true); 

    // 3. 캐릭터 표시 로직 (기존 그대로 유지)
    const officeBgs = ['bg_office', 'bg_toptier', 'bg_unicorn', 'bg_global', 'bg_space', 
                       'bg_office_night', 'bg_toptier_night', 'bg_unicorn_night', 'bg_global_night', 'bg_space_night'];

    if (player.isPhase2 && officeBgs.includes(key)) {
        if (charSuitWorkSprite) {
            charSuitWorkSprite.setVisible(true);
            charSuitWorkSprite.setDepth(101); 
            adjustCharacterSize(charSuitWorkSprite, sceneContext.scale.width, sceneContext.scale.height);
        }
        if (charHoodieSprite) charHoodieSprite.setVisible(false);
        if (charSuitSprite) charSuitSprite.setVisible(false);
        if (charWorkSprite) charWorkSprite.setVisible(false);

    } else {
        if (charHoodieSprite) charHoodieSprite.setVisible(false);
        if (charSuitSprite) charSuitSprite.setVisible(false);
        if (charWorkSprite) charWorkSprite.setVisible(false);
        if (charSuitWorkSprite) charSuitWorkSprite.setVisible(false);
    }

    // 4. 대화창 표시
    const msgLayer = document.getElementById('scene-message-layer');
    const msgText = document.getElementById('scene-msg-text');
    msgLayer.style.display = 'flex';
    
    let count = 0; 
    msgText.innerText = msgs[Math.floor(Math.random() * msgs.length)];
    
    let iv = setInterval(() => { 
        msgText.innerText = msgs[Math.floor(Math.random() * msgs.length)]; 
        count++; 
        if(count >= 3) { 
            clearInterval(iv); 
            
            // 5. 종료 및 복구
            sceneOverlay.setVisible(false); 
            msgLayer.style.display = 'none'; 
            
            if(player.isPhase2) {
                if(charSuitWorkSprite) {
                    charSuitWorkSprite.setVisible(true);
                    charSuitWorkSprite.setDepth(5); 
                }
            } else {
                if(charWorkSprite) {
                    charWorkSprite.setVisible(true);
                    charWorkSprite.setDepth(5);
                }
            }

            document.getElementById(player.isPhase2 ? 'phase2-ui-layer' : 'ui-layer').style.display = 'flex'; 
            player.isBusy = false; 
            
            cb(); 
            updateUI(); 
            
            // ▼▼▼ [수정 2] 음악을 안 껐다면, 다시 켤(재시작할) 필요도 없음
            if (!keepBgm) {
                updateAudioState('main');
            }
            // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
        } 
    }, 1000);
}
/* [수정] playPortfolioSequence: 박스 제어 코드 삭제 & 리사이징 유지 */
function playPortfolioSequence(cb) {
    player.isBusy = true; 
    document.getElementById('ui-layer').style.display = 'none';
    
    // 1. 이미지 교체
    if(sceneContext.textures.exists('scene_burning')) {
        portfolioOverlay.list[1].setTexture('scene_burning');
    }
    
    // 2. 오버레이 켜기
    portfolioOverlay.setVisible(true);

    // ★ 이미지 크기 맞춤 (필수)
    if(typeof fitToScreen === 'function') fitToScreen(portfolioOverlay.list[1]);

    // 3. HTML 대화창
    const msgLayer = document.getElementById('scene-message-layer');
    const msgText = document.getElementById('scene-msg-text');
    msgLayer.style.display = 'flex';

    let count = 0;
    msgText.innerText = msgs.pf[Math.floor(Math.random() * msgs.pf.length)];

    let iv = setInterval(() => { 
        msgText.innerText = msgs.pf[Math.floor(Math.random() * msgs.pf.length)]; 
        count++; 
        if(count >= 3) { 
            clearInterval(iv); 
            portfolioOverlay.setVisible(false); 
            msgLayer.style.display = 'none'; 
            document.getElementById('ui-layer').style.display = 'flex'; 
            player.isBusy = false; 
            cb(); 
            updateUI(); 
        } 
    }, 1000);
}

        window.openPopup = function(id) { if(player.isBusy) return; document.getElementById('modal-overlay').style.display='block'; document.getElementById(id).style.display='flex';updateAudioState('mute'); }
        window.closePopup = function() { document.getElementById('modal-overlay').style.display='none'; document.querySelectorAll('.popup').forEach(p=>p.style.display='none'); updateAudioState('main');}

// ========================================================
// 📺 [광고 시스템] 토스 AdMob 보상형 광고 통합 (최종)
// ========================================================
// ========================================================
// 📺 [Toss Ads] 광고 ID 설정 (대시보드 ID로 교체 필수!)
// ========================================================
const AD_IDS = {
    // [리워드 광고]
    HP_RECOVER:     "ait.v2.live.c726946e2bf645ce",        // 휴식 (체력 100% 회복)
    EARN_MONEY:     "ait.v2.live.53f60c458918415a",      // 특급 야근 (돈 벌기)
    JOB_REFRESH:    "ait.v2.live.97898cb247a84627",    // 채용 공고 새로고침
    EXTEND_DEAD:    "ait.v2.live.4b0fb71d51914448",        // 마감 기한 연장
    GAME_RESTORE:   "ait.v2.live.947df5d898d24228",        // 크래시 데이터 복구

};

// [수정] 토스 광고 함수 (먹통 방지 로직 적용)
window.showAd = async function(type, successCallback) {
    const targetId = AD_IDS[type];
    if (!targetId) return alert("광고 ID 설정 오류");

    updateAudioState('mute');

    // ★ [핵심] 보상을 받았는지 체크하는 변수
    let isRewardEarned = false;

    // 화면 정리 및 게임 재개 함수
    const forceCleanup = () => {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('ad-overlay').style.display = 'none';
        document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
        
        if(sceneContext) {
            sceneContext.game.loop.wake(); 
            if(sceneContext.sound && sceneContext.sound.context) {
                sceneContext.sound.context.resume(); 
            }
        }
        updateAudioState('main'); 
    };

    try {
        const { GoogleAdMob } = await import('https://esm.sh/@apps-in-toss/web-framework');
        if (GoogleAdMob.loadAppsInTossAdMob.isSupported() !== true) throw new Error("Not Supported");

        const cleanupLoad = GoogleAdMob.loadAppsInTossAdMob({
            options: { adGroupId: targetId },
            onEvent: (loadEvent) => {
                if (loadEvent.type === 'loaded') {
                    cleanupLoad();
                    GoogleAdMob.showAppsInTossAdMob({
                        options: { adGroupId: targetId },
                        onEvent: (showEvent) => {
                            // 1. 보상 획득 시 -> 플래그만 세움 (즉시 지급 X)
                            if (showEvent.type === 'userEarnedReward') {
                                console.log("보상 획득 확인 (지급 대기)");
                                isRewardEarned = true;
                            }
                            
                            // 2. 광고 닫힘 시 -> 이때 보상 지급 및 화면 복구
                            if (showEvent.type === 'dismissed') {
                                console.log("광고 닫힘 -> 처리 시작");
                                if (isRewardEarned) {
                                    successCallback(); // ★ 여기서 콜백 실행
                                }
                                forceCleanup(); // 화면 복구
                            }
                        },
                    });
                } 
                // 로드 단계에서 보상 이벤트가 오는 특이 케이스 대응
                else if (loadEvent.type === 'userEarnedReward') {
                    isRewardEarned = true;
                }
            },
        });

    } catch (e) {

    }
};




        
// [수정] 알바 팝업 열기 (ID 찾는 에러 코드 제거)
window.openAlbaPopup = function() { 
    // 기존에 있던 document.getElementById('btn-normal-alba')... 코드를 삭제함
    openPopup('alba-popup'); 
}
// [수정] 알바 실행 (특급 야근은 무적)
window.startWorking = function(type) {
    // 1. [일반 알바]일 때만 제약 사항 체크
    if (type === 'normal') {
        if (player.workedThisWeek) return alert("이번 주는 이미 일을 했습니다. (다음 주에 가능)");
        if (player.hp < 20) return alert("체력이 부족합니다. (필요: 20)");
    }

    // 2. 보상 설정
    let reward = (type === 'normal') ? 50000 : 100000;
    
    closePopup();
    
    // 3. 실행 및 보상 지급
    playScene('bg_alba', msgs.alba, () => {
        player.money += reward; 
        
        // ★ [핵심] 일반 알바만 체력 차감 & 주간 횟수 차감
        if (type === 'normal') {
            player.hp -= 20; 
            player.workedThisWeek = true;
            showFloatingText(180, 280, `-20 HP`, '#FF5F5F');
        } else {
            // 특급 야근은 체력 유지!
            showFloatingText(180, 280, `체력 소모 없음`, '#4CD964');
        }
        
        showLog(`알바 완료! +${reward.toLocaleString()}원`); 
        showFloatingText(180, 230, `+${reward/10000}만`, '#FFD700');

        addTime();
    });
}
// [2] 팝업창 텍스트도 자동으로 수정 (+4만 -> +5만)
// 이 코드는 즉시 실행되어 화면의 글자를 바꿔줍니다.
const albaLabel = document.querySelector('#alba-popup .card-btn:nth-of-type(1) p');
if(albaLabel) {
    albaLabel.innerText = "+5만 / HP -20";
}

window.trySpecialAlba = function() {
    // 변경 후: 'EARN_MONEY' 타입 추가
    showAd('EARN_MONEY', function(){
        startWorking('special');
    });
}
// [Ver 64.8 Fix] 휴식 팝업 (테니스 멘탈 회복량 표기 추가)
window.openP2RestPopup = function() {
    // 1. 티어별 비용 및 성과 계산
    let cost = 50000;
    let bonus = 1;
    
    if (player.tier === 'Space') { cost = 50000000; bonus = 3; }
    else if (player.tier === 'Global') { cost = 5000000; bonus = 2; }
    else if (player.tier === 'Unicorn') { cost = 1000000; bonus = 2; }
    else if (player.tier === 'TopTier') { cost = 150000; bonus = 1; }
    else { cost = 50000; bonus = 1; } // Agency

    // 2. UI 텍스트 업데이트 (멘탈 +30 문구 추가)
    const costEl = document.getElementById('p2-tennis-cost');
    if (costEl) {
        // [수정됨] "50,000원 (멘탈 +30, 성과 +1)" 형식으로 변경
        costEl.innerText = `${cost.toLocaleString()}원 (멘탈 +30, 성과 +${bonus})`;
    }

    // 3. 팝업 열기
    openPopup('p2-rest-popup');
}
// [수정] 사회생활 팝업 (부장님 퀴즈 시 '닫기' 버튼 차단)
window.openSocialPopup = function() {
    if(player.hp < 10) return alert("멘탈이 너무 약해서 사람을 대할 수 없습니다.");
    
    const rand = Math.random();
    const container = document.getElementById('social-content');
    const title = document.getElementById('social-title');
    
    // ★ [핵심] 팝업 내 닫기 버튼 찾기
    const closeBtn = document.querySelector('#social-popup .close-btn');
    
    // 50% 확률로 퀴즈, 50% 확률로 탕비실 이벤트
    if(rand < 0.5) {
        // 🛑 [퀴즈] 닫기 버튼 숨김 (강제 진행)
        if(closeBtn) closeBtn.style.display = 'none';

        const quiz = dadJokes[Math.floor(Math.random() * dadJokes.length)];
        title.innerText = "👨‍💼 부장님의 기습 퀴즈!";
        container.innerHTML = `
            <div class="quiz-box">
                <div class="quiz-q">"자네, ${quiz.q}"</div>
                <input type="text" id="quiz-input" class="quiz-input" placeholder="정답을 입력하세요">
                <button class="full-btn" onclick="checkDadJoke('${quiz.a}')">정답 외치기</button>
            </div>
        `;
    } else {
        // ✅ [탕비실] 닫기 버튼 다시 보이기 (선택 가능)
        if(closeBtn) closeBtn.style.display = 'flex';

        title.innerText = "☕ 탕비실 생존 전략";
        container.innerHTML = `
            <div class="card-btn pantry-option" onclick="doPantryAction('politics')">
                <div class="card-info">
                    <span class="pantry-tag" style="background:#7274ED; color:#fff">야망</span>
                    <h3>👨‍💼 사내 라인 타기</h3>
                    <p>성공(30%): <span style="color:#FFD700">성과 +15</span> / 실패: 멘탈 -30, 성과 -5</p>
                </div>
            </div>
            
            <div class="card-btn pantry-option" onclick="doPantryAction('gossip')">
                <div class="card-info">
                    <span class="pantry-tag" style="background:#FF5F5F; color:#fff">위험</span>
                    <h3>🤬 뒷담화 하기</h3>
                    <p>성공(40%): <span style="color:#4CD964">멘탈 +50</span> / 실패: 성과 -5</p>
                </div>
            </div>
            
            <div class="card-btn pantry-option" onclick="doPantryAction('snack')">
                <div class="card-info">
                    <span class="pantry-tag" style="background:#FFB356; color:#fff">안전</span>
                    <h3>🍪 법카로 간식 먹기</h3>
                    <p>성공(90%): 멘탈 +10 / 실패: 멘탈 -5</p>
                </div>
            </div>
        `;
    }
    openPopup('social-popup');
}

        window.checkDadJoke = function(answer) {
            const input = document.getElementById('quiz-input').value.replace(/\s+/g, ''); 
            const cleanAnswer = answer.replace(/\s+/g, '');
            closePopup();
            if(input === cleanAnswer) {
                player.performance += 10; player.hp = Math.min(100, player.hp + 5);
                alert(`부장님: "오오!! 역시 자네는 센스가 있어!"\n(성과 +10, 멘탈 +5)`);
            } else {
                player.performance = Math.max(0, player.performance - 10); 
                player.hp -= 5;
                alert(`부장님: "에잉 쯧쯧.. 센스가 없구만."\n(성과 -5, 멘탈 -10)`);
            }
            addTime(true);
        }

       // [Ver 60.0] 탕비실 액션 로직 (밸런스 적용)
window.doPantryAction = function(type) {
    closePopup();
    const rand = Math.random();
    
    // 1. 사내 라인 타기 (Politics)
    if(type === 'politics') {
        if(rand < 0.3) { // 30% 성공
            player.performance = Math.min(100, player.performance + 15); 
            alert("이사님 라인을 제대로 탔습니다!\n(성과 +15 떡상!)");
        } else { 
            player.hp -= 30; 
            // ★ 실패 시 성과 -5 추가
            player.performance = Math.max(0, player.performance - 5);
            alert("줄을 잘못 섰습니다... 이사님이 저를 째려봅니다.\n(멘탈 -30, 성과 -5)");
        }
    }
    // 2. 뒷담화 (Gossip)
    else if(type === 'gossip') {
        if(rand < 0.4) { // 40% 성공
            player.hp = Math.min(100, player.hp + 50); 
            alert("상사 흉을 보니 십년 묵은 체증이 내려갑니다!\n(멘탈 +50 회복)");
        } else { // 50% 실패
            player.performance = Math.max(0, player.performance - 5);
            alert("문 뒤에 부장님이 계셨습니다...\n(성과 -5 감점)");
        }
    } 
    // 3. 간식 (Snack)
    else if(type === 'snack') {
        if(rand < 0.9) { // 90% 성공
            player.hp = Math.min(100, player.hp + 10); 
            alert("당이 충전되었습니다. (멘탈 +10)");
        } else {
            player.hp -= 5; 
            alert("부장님: \"자네만 입인가?\"\n(뺏김, 멘탈 -5)");
        }
    }
    
    addTime(true); // 사회생활도 업무의 연장선 (시간 경과)
}

        window.doSkillUp = function(type) {
            if(player.hp < 20) return alert("체력 부족");
            let cost=0, gain=0;
            if(type === 'ai') { cost = 40000; gain = 2; } 
            else if(type === 'oneday') { cost = 150000; gain = 10; } 
            else { cost = 500000; gain = 50; }
            if(player.money < cost) return alert("돈 부족");
            closePopup();
            playScene('scene_study', msgs.study, () => { 
                player.money -= cost; player.hp -= 20; player.designStat += gain; 
                showLog(`스킬 업! (+${gain})`); addTime(); 
            });
        }
        
// [최종 수정] 스킬 비용 계산 (Agency/TopTier 동결, 이후 점진적 상승)
function getSkillCost(type) {
    let baseCost = 0;
    
    // 1. 기본 가격
    if (type === 'sub') baseCost = 40000;           
    else if (type === 'seminar') baseCost = 150000; 
    else if (type === 'deprep') baseCost = 500000;  

    let lvl = Math.floor(player.designStat / 100); 

    // 2. 레벨별 증가분 (기존 유지)
    // 레벨이 높을수록 기본 비용이 오름
    let levelMult = 1 + (lvl * 0.4);

    // 3. [수정] 티어별 물가 상승률 (요청사항 반영)
    let tierMult = 1.0;
    
    if (player.tier === 'Space') tierMult = 5.0;       // Space: 5배 (최종 콘텐츠)
    else if (player.tier === 'Global') tierMult = 1.2; // Global: 1.2배
    else if (player.tier === 'Unicorn') tierMult = 1.1; // Unicorn: 1.1배
    else if (player.tier === 'TopTier') tierMult = 1.0; // TopTier: 1.0배 (Agency와 동일)
    // Agency는 1.0 (기본)

    // 최종 비용 계산
    return Math.floor(baseCost * levelMult * tierMult);
}

// [Ver 83.0 Fix] 자기계발 효율 감소폭 완화 (표기 로직)
window.openP2SkillPopup = function() {
    // 1. 비용 계산
    const c1 = getSkillCost('sub');
    const c2 = getSkillCost('seminar');
    const c3 = getSkillCost('deprep');

    // 2. 효율 계산 (완화된 로직 적용)
    let lvl = Math.floor(player.designStat / 100);
    let efficiency = 1.0; 
    
    // [수정] Lv.15까지 100% 유지 -> 이후 천천히 감소
    if (lvl >= 50) efficiency = 0.6;      // 초고레벨 (60%)
    else if (lvl >= 30) efficiency = 0.8; // 고레벨 (80%)
    else if (lvl >= 15) efficiency = 0.9; // 중레벨 (90%)
    else efficiency = 1.0;                // 초반 (100%)
    
    // 3. 실제 획득량 계산
    const g1 = Math.max(1, Math.floor(2 * efficiency));
    const g2 = Math.max(1, Math.floor(10 * efficiency));
    const g3 = Math.max(1, Math.floor(40 * efficiency));

    // 4. UI 업데이트
    if(document.getElementById('p2-cost-sub')) {
        document.getElementById('p2-cost-sub').innerText = `스킬 +${g1} (${c1.toLocaleString()}원)`;
        document.getElementById('p2-cost-seminar').innerText = `스킬 +${g2} (${c2.toLocaleString()}원)`;
        document.getElementById('p2-cost-deprep').innerText = `스킬 +${g3} (${c3.toLocaleString()}원)`;
    }

    openPopup('p2-skill-popup');
}

// [Ver 83.0 Fix] 자기계발 효율 감소폭 완화 (실제 적용)
window.doP2SkillAction = function(type) {
    if(player.hp < 20) return alert("멘탈이 부족합니다. (필요: 20)");
    
    // 1. 비용 계산
    let cost = getSkillCost(type);
    
    // 2. 기본 획득량
    let baseGain = 0;
    if (type === 'sub') baseGain = 2;
    else if (type === 'seminar') baseGain = 10;
    else if (type === 'deprep') baseGain = 40;

    if(player.money < cost) {
        return alert(`잔고가 부족합니다.\n필요 금액: ${cost.toLocaleString()}원`);
    }

    // 3. [수정] 효율 감소 로직 완화 (Soft Cap)
    let lvl = Math.floor(player.designStat / 100);
    let efficiency = 1.0; 
    
    if (lvl >= 50) efficiency = 0.6;      // Lv.50~ : 60% (기존 40%에서 상향)
    else if (lvl >= 30) efficiency = 0.8; // Lv.30~ : 80% (기존 40%에서 대폭 상향)
    else if (lvl >= 15) efficiency = 0.9; // Lv.15~ : 90% (기존 60~80%에서 상향)
    else efficiency = 1.0;                // Lv.0~14: 100% (패널티 없음)
    
    // 최종 획득량 (최소 1점 보장)
    let actualGain = Math.max(1, Math.floor(baseGain * efficiency));

    closePopup();
    
    playScene('scene_study', msgs.study, () => {
        player.money -= cost; 
        player.hp -= 20; 
        player.designStat += actualGain;
        
        // 결과 로그
        let resultMsg = `자기계발 완료! (스킬 +${actualGain})`;
        if (efficiency < 1.0) {
            resultMsg += ` [효율 ${Math.round(efficiency*100)}%]`;
        }
        
        showP2Log(resultMsg); 
        addTime(false);
    });
}

        window.doRest = function(type) {
            closePopup(); let rec=0, cost=0; 
            if(type==='coffee'){rec=30; cost=5000;} else if(type==='sleep'){rec=60; cost=0;} else {rec=100; cost=0;}
            if(player.money < cost) return alert("돈 부족");
            player.money -= cost; 
            playScene('bg_sleep', ["휴식 중..."], () => { player.hp = Math.min(100, player.hp + rec); 
                // [★ 추가] 회복 플로팅 (초록색)
    showFloatingText(180, 230, `+${rec} HP`, '#4CD964');
                if(type==='sleep') addTime(); else updateUI(); showLog("휴식 완료."); });
        }
        
        // [수정됨] 휴식 함수 (순수 회복 + 최대 체력 반영)
// [Ver 64.5 Fix] 휴식 함수 (테니스 비용 현실화 & 성과 너프)
window.doP2RestAction = function(type) {
    closePopup();
    let rec=0, cost=0, msg="", bgKey="";
    let perfBonus = 0; 

    if(type==='tennis') { 
        rec=30; // 체력 회복량은 30 고정
        bgKey = 'bg_tenis';
        
        // [NEW] 티어별 테니스 비용 & 성과 차등 적용
        // Agency: 5만 (+1) / Space: 5,000만 (+3)
        if (player.tier === 'Space') {
            cost = 50000000; perfBonus = 3;
            msg = "우주 정거장 코트에서 한 게임! (성과 +3)";
        } else if (player.tier === 'Global') {
            cost = 5000000; perfBonus = 2;
            msg = "VIP 전담 코치 레슨! (성과 +2)";
        } else if (player.tier === 'Unicorn') {
            cost = 1000000; perfBonus = 2;
            msg = "호텔 멤버십 클럽 라운딩 (성과 +2)";
        } else if (player.tier === 'TopTier') {
            cost = 150000; perfBonus = 1;
            msg = "사설 실내 테니스장 레슨 (성과 +1)";
        } else {
            // Agency
            cost = 50000; perfBonus = 1;
            msg = "동네 테니스장 대관 (성과 +1)";
        }
    }
    else if(type==='home') { 
        rec=60; cost=0; msg="넷플릭스 정주행... (힐링)"; 
        bgKey = 'bg_netflix';
    }
    else if(type==='full') { 
        rec=0; // 아래에서 Max로 처리
        cost=0; msg="해외여행 다녀왔습니다! (멘탈 완전 회복)"; 
        bgKey = 'bg_travel';
    }
    
    // 비용 체크
    if(player.money < cost) return alert(`돈이 부족합니다. (필요: ${cost.toLocaleString()}원)`);
    player.money -= cost; 
    
    playScene(bgKey, [msg], () => {
        let max = getMaxHp(); 

        if (type === 'full') {
            player.hp = max; // 여행은 풀충전
            rec = max; 
        } else {
            player.hp = Math.min(max, player.hp + rec);
        }
        
        // 성과 보너스 적용
        if(perfBonus > 0) {
            player.performance = Math.min(100, player.performance + perfBonus);
            showP2Log(`휴식 완료! (멘탈 +${rec}, 성과 +${perfBonus})`);
        } else {
            if (type === 'full') showP2Log("휴식 완료! (멘탈 완전 회복)");
            else showP2Log(`휴식 완료! (멘탈 +${rec})`);
        }
showFloatingText(180, 230, `+${rec} 멘탈`, '#4CD964');
        addTime(false); 
    });
}
       // [수정] 메인 버튼 핸들러 (체력 부족 시 안내 강화)
window.handleProjectButton = function() {
    // 1. 연출 중이면 클릭 방지
    if(player.isBusy) return; 

    // 2. 프로젝트가 시작되지 않았을 때 (새 프로젝트 기획 단계)
    if(!player.isProjectStarted) { 
        // ★ [핵심] 체력 체크 및 알림창 띄우기
        if(player.hp < 30) { 
            alert("체력이 부족합니다. (필요: 30)\n\n[휴식]을 하거나 [커피]를 마셔 회복하세요!"); 
            return; 
        } 
        
        // 체력 충분하면 기획 팝업 열기
        openPopup('planning-popup'); 
    } 
    // 3. 이미 프로젝트 진행 중일 때 (작업 수행)
    else { 
        doProjectWork(); 
    }
}
        window.confirmPlanning = function() {
            const g = document.querySelector('input[name="genre"]:checked'); const s = document.querySelector('input[name="style"]:checked');
            if(!g || !s) return alert("선택 필수"); player.currentProjectName = document.getElementById('project-name').value || "무제"; currentGenreId = g.value; currentStyleId = s.value; closePopup(); openPopup('mission-popup');
        }
        window.setStrategy = function(st) {
            player.currentStrategy = st; closePopup(); player.isProjectStarted = true; player.deadline = Math.floor(Math.random() * 5) + 8; player.currentWeekInProject = 0; player.portfolioProgress = 0; showLog("프로젝트 시작!"); updateUI(); playScene('scene_burning', ["자 이제 시작이야!!"], ()=>{});
        }
        
// ========================================================
// [수정] 포트폴리오 작업 (위기 상황 발동 + 정상 작업 분리)
// ========================================================

// 1. 작업 버튼 눌렀을 때 실행되는 메인 함수
window.doProjectWork = function() {
    // 1. 체력 체크
    if(player.hp < 30) return alert("체력이 부족합니다. (필요: 30)");
    
    closePopup(); // 혹시 열려있는 팝업 닫기

    // 2. [핵심] 5% 확률로 '응답 없음' 위기 발동!
    // (테스트할 때는 0.05를 1.0으로 바꾸면 무조건 뜹니다)
    if (Math.random() < 0.07) { 
        startCrisisGame(); // ★ 위기 게임 시작 (나중에 추가한 함수)
        return; // 여기서 함수 종료 (정상 작업은 위기 넘기고 실행됨)
    }

    // 3. 위기가 아니면 정상적으로 일하기
    processNormalWork();
};

// 2. [신규] 정상적인 업무 처리 함수 (위기 극복 후에도 이걸 호출함)
function processNormalWork() {
    playPortfolioSequence(() => {
        player.hp -= 30; // 체력 소모
        
        // 진행도 증가 (9로 하향된 버전)
        let progress = 9; 
        player.portfolioProgress += progress;

        // 퀄리티 계산
        let baseGain = Math.floor(Math.random() * 5) + 2; 
        let statBonus = player.designStat * 0.04; 
        let equipBonus = player.currentPower * 0.5;
        let qualityGain = baseGain + statBonus + equipBonus;

        // ---------------------------------------------------------
        // [시너지 로직] (기존 코드 그대로 복구)
        // ---------------------------------------------------------
        let synergyMult = 1.0;
        let synergyMsg = ""; 
        const pair = currentGenreId + '+' + currentStyleId;

        // 1) 찰떡궁합 (Best): +20%
        if (
            pair === 'g1+s1' || pair === 'g2+s2' || pair === 'g3+s4' || 
            pair === 'g4+s3' || pair === 'g5+s5' || pair === 'g6+s7' || 
            pair === 'g7+s1' || pair === 'g8+s2' || pair === 'g9+s6'
        ) {
            synergyMult = 1.2;
            synergyMsg = " (컨셉 대박! +20%)";
        }
        // 2) 상극 (Worst): -20%
        else if (
            pair === 'g1+s8' || pair === 'g7+s7' || 
            pair === 'g4+s5' || pair === 'g9+s5'
        ) {
            synergyMult = 0.8;
            synergyMsg = " (컨셉 미스... -20%)";
        }
        // 3) 무난함: -10%
        else if (pair === 'g1+s2' || pair === 'g3+s3') {
            synergyMult = 0.9;
            synergyMsg = " (애매함... -10%)";
        }

        // 전략(속도/퀄리티) 반영
        if(player.currentStrategy === 'speed') qualityGain *= 0.7;
        
        // 최종 점수 반영
        qualityGain = Math.floor(qualityGain * synergyMult);
        player.portfolioQuality += qualityGain;

        showLog(`작업 완료! 퀄리티 +${qualityGain}${synergyMsg}`); 
        addTime();
    });
}

        function finishProject() {
            player.isProjectStarted = false; let score = Math.floor(player.portfolioQuality);
            let grade = 'C'; if(score >= 800) grade='S'; else if(score >= 400) grade='A'; else if(score >= 150) grade='B';
            player.history.push({name:player.currentProjectName, score:score, grade:grade});
            if(score > player.bestPortfolioScore) player.bestPortfolioScore = score;
            submitTossScore();
            alert(`[마감] ${player.currentProjectName}\n등급: ${grade} (${score}점)`);
            player.portfolioProgress = 0; player.portfolioQuality = 0; saveGameData(); updateUI();
        }

        function showLog(m) { document.getElementById('log-text').innerText = m; }
        function showP2Log(m) { document.getElementById('p2-log-text').innerText = m; } 

        function initPlanningUI() { 
            const gb = document.getElementById('genre-list'); gb.innerHTML=''; genres.forEach((g,i) => { const d = document.createElement('label'); d.className = 'radio-item'; d.innerHTML = `<input type="radio" name="genre" value="${g.id}"> ${g.name}</label>`; gb.appendChild(d); }); 
            const sb = document.getElementById('style-list'); sb.innerHTML=''; styles.forEach((s,i) => { const d = document.createElement('label'); d.className = 'radio-item'; d.innerHTML = `<input type="radio" name="style" value="${s.id}"> ${s.name}</label>`; sb.appendChild(d); }); 
        }
        window.renderShop = function() {
            const l = document.getElementById('shop-list'); l.innerHTML='';
            shopItems.forEach(i => {
                const has = player.inventory.includes(i.name); const btnHtml = has ? `<button class="btn-buy" disabled>보유중</button>` : `<button class="btn-buy" onclick="buyItem(${i.id})">구매</button>`;
                l.innerHTML += `<li class="shop-item"><div class="shop-left"><img src="assets/${i.img}" class="shop-thumb"><div class="shop-info"><span class="shop-name">${i.name}</span><span class="shop-desc">${i.desc}</span><span class="shop-price">${i.cost.toLocaleString()}원</span></div></div>${btnHtml}</li>`;
            });
        }
        window.buyItem = function(id) {
            let item = shopItems.find(i=>i.id===id); if(player.money >= item.cost) { player.money-=item.cost; player.inventory.push(item.name); player.currentPower = item.power; alert(`${item.name} 구매 완료!`); saveGameData(); updateUI(); renderShop(); } else alert("돈이 부족합니다!");
        }
// [UPDATE] 인벤토리 열기 (스크롤바 간격 & 화살표 개선 적용)
window.renderInventory = function() {
    // 1. 화면 초기화
    document.getElementById('inv-view-list').style.display = 'block';
    document.getElementById('inv-view-detail').style.display = 'none';

    // 2. 리스트 렌더링
    const l = document.getElementById('inventory-list');
    l.innerHTML = '';

    player.inventory.forEach(itemName => {
        const itemData = shopItems.find(i => i.name === itemName);
        const img = itemData ? itemData.img : 'item_mouse_basic.png';

        l.innerHTML += `
        <li onclick="showInvDetail('${itemName}')" style="cursor: pointer; transition: 0.2s; align-items: center;">
            <div style="display:flex; align-items:center;">
                <img src="assets/${img}" style="width:40px; height:40px; margin-right:15px; border-radius:8px; background:#222; border:1px solid #444; object-fit: contain;">
                
                <div>
                    <div style="font-weight:700; font-size:15px; color:#fff; margin-bottom: 2px;">${itemName}</div>
                    <div style="font-size:11px; color:#888;">보유 중</div>
                </div>
            </div>

            <div style="
                font-size: 24px; 
                color: #B0B8C1; 
                font-weight: 300; 
                margin-right: 5px;
                padding-bottom: 4px; /* 높이 중앙 정렬 미세 조정 */
            ">›</div>
        </li>`;
    });
}

// [NEW] 상세 화면으로 전환 (Drill-down)
window.showInvDetail = function(itemName) {
    const item = shopItems.find(i => i.name === itemName);
    if (!item) return;

    // 데이터 채우기
    document.getElementById('inv-detail-img').src = `assets/${item.img}`;
    document.getElementById('inv-detail-name').innerText = item.name;
    document.getElementById('inv-detail-power').innerText = `작업 효율 +${item.power}`;
    document.getElementById('inv-detail-desc').innerText = `"${item.desc}"`;

    // 화면 전환 (목록 숨김 -> 상세 보임)
    document.getElementById('inv-view-list').style.display = 'none';
    document.getElementById('inv-view-detail').style.display = 'block';
}

// [NEW] 목록 화면으로 복귀 (Back)
window.backToInventory = function() {
    document.getElementById('inv-view-detail').style.display = 'none';
    document.getElementById('inv-view-list').style.display = 'block';
}
        window.renderHistory = function() { document.getElementById('portfolio-list').innerHTML = player.history.map(x=>`<li>${x.name} (${x.grade})</li>`).join(''); }
        
    // [Ver 60.1 Fix] 이직 시장 UI: 점수뿐만 아니라 '직급' 조건도 체크하도록 수정
window.openJobMarket = function(){ 
    const l = document.getElementById('job-list'); l.innerHTML=''; 
    document.getElementById('best-score').innerText = player.bestPortfolioScore;

    currentJobList.forEach(c => {
        // 1. 점수 조건 체크
        const isScoreOk = player.bestPortfolioScore >= c.req;
        
        // 2. [NEW] 직급 조건 체크 (데이터에 prevRank가 없으면 0으로 간주)
        const requiredRank = c.prevRank || 0;
        const isRankOk = player.rank >= requiredRank;
        
        let btnText = "지원";
        let btnState = "";
        
        // 상태별 버튼 텍스트 및 활성화 여부 설정
        if (!isScoreOk) {
            btnText = `${c.req}점 필요`;
            btnState = "disabled";
        } else if (!isRankOk) {
            // [NEW] 점수는 되는데 직급이 모자랄 때
            btnText = `${RANKS[requiredRank]}↑ 필요`; // 예: "팀장↑ 필요"
            btnState = "disabled";
        }
        
        const btnAction = (btnState === "") ? `onclick="applyJob('${c.name}',${c.req}, '${c.tier}')"` : "";
        
        l.innerHTML += `
        <li>
            <div class="job-card">
                <span class="job-tier tier-${c.tier}">${c.label}</span> 
                ${c.name}
            </div>
            <button class="btn-apply" ${btnState} ${btnAction}>${btnText}</button>
        </li>`;
    }); 
};
        
 // [Ver 54.2 Fix] 취업 시장 생성 로직 분리 (취준생 vs 경력직)
function generateJobs() { 
    currentJobList = [];
    
    // ----------------------------------------------------
    // [CASE 1] Phase 1 (취준생): 다양한 기회 제공 (확률 기반)
    // ----------------------------------------------------
    if (!player.isPhase2) {
        let attempts = 0; 
        while(currentJobList.length < 4 && attempts < 100) {
            attempts++;
            let rand = Math.random() * 100; 
            let selectedTier = 'agency';
            
            // 취준생용 확률: Agency(70%), TopTier(25%), Unicorn(5%)
            if (rand < 5) selectedTier = 'unicorn';        
            else if (rand < 30) selectedTier = 'toptier';  
            
            const pool = companyPool[selectedTier];
            if (!pool) continue;

            const company = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
            
            // 점수 변동성은 동일하게 적용
            let variance = Math.floor(company.req * 0.2);
            let randomVar = Math.floor(Math.random() * variance * 2) - variance; 
            company.req = Math.max(0, company.req + randomVar);

            const isDuplicate = currentJobList.find(job => job.name === company.name);
            if(!isDuplicate) { currentJobList.push(company); }
        }
    } 
    // ----------------------------------------------------
    // [CASE 2] Phase 2 (경력직): 커리어 패스 (상향 지원만 가능)
    // ----------------------------------------------------
    else {
        const tierOrder = ['Agency', 'TopTier', 'Unicorn', 'Global', 'Space'];
        let currentIdx = tierOrder.indexOf(player.tier);
        
        let attempts = 0; 
        while(currentJobList.length < 4 && attempts < 100) {
            attempts++;
            
            let rand = Math.random();
            let targetIdx = currentIdx + 1; // 기본: 다음 단계 (승진 이직)
            
            if (rand < 0.3 && currentIdx + 2 < tierOrder.length) {
                targetIdx = currentIdx + 2; // 대박 기회 (점프 이직)
            }
            
            // Space(끝판왕)면 유지
            if (currentIdx >= tierOrder.length - 1) targetIdx = currentIdx; 

            let targetTier = tierOrder[targetIdx];
            if (!targetTier) targetTier = 'Agency'; 

            const pool = companyPool[targetTier.toLowerCase()];
            if (!pool) continue;

            const company = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
            
            // 점수 변동성
            let variance = Math.floor(company.req * 0.2);
            let randomVar = Math.floor(Math.random() * variance * 2) - variance; 
            company.req = Math.max(0, company.req + randomVar);

            const isDuplicate = currentJobList.find(job => job.name === company.name);
            if(!isDuplicate) { currentJobList.push(company); }
        }
    }
}

        window.refreshJobs = function(){ generateJobs(); openJobMarket(); showLog("채용 공고가 새로고침 되었습니다!"); };
        window.resolveCrisis = function(ad) { closePopup(); if(!ad) player.hp-=10; updateUI(); };
        window.watchAdForStamina = function() { closePopup(); player.hp = 100; showLog("체력 회복!"); updateUI(); };
        window.actionRestInPopup = function() { doRest('sleep'); };

        window.testNextTier = function() {
            const tierOrder = ['Agency', 'TopTier', 'Unicorn', 'Global', 'Space'];
            let currentIndex = tierOrder.indexOf(player.tier);
            
            let nextIndex = (currentIndex + 1) % tierOrder.length;
            let nextTier = tierOrder[nextIndex];
            
            player.tier = nextTier;
            player.rank = 0; 
            player.hp = 100; 
            updateSalary();  

            setBgByTier(player.tier);
            assignProject(); 
            updateUI();

            alert(`[테스트 모드]\n${nextTier}로 강제 이직했습니다!`);
        };

window.startPhase2 = function() {
    document.getElementById('success-popup').style.display='none'; 
    setBgByTier(player.tier);
    
    // 1. 기존 캐릭터 숨기기
    if(charWorkSprite) charWorkSprite.setVisible(false);
    if(charHoodieSprite) charHoodieSprite.setVisible(false);
    if(charSuitSprite) charSuitSprite.setVisible(false);
    
    // 2. [핵심] 2페이즈 일하는 캐릭터 보이기
    if(charSuitWorkSprite) {
        charSuitWorkSprite.setVisible(true);
        // 위치/크기 재조정
        const w = sceneContext.scale.width;
        const h = sceneContext.scale.height;
        adjustCharacterSize(charSuitWorkSprite, w, h);
    }
    
    document.getElementById('ui-layer').style.display='none'; 
    document.getElementById('phase2-ui-layer').style.display='flex';
    
    if(!player.isPhase2) {
        player.isPhase2 = true; 
        player.tier = 'Agency'; player.rank = 0; 
        player.money += 2000000; player.hp = 100; player.performance = 0;
        updateSalary();
    }
    assignProject(); 
    updateUI();
    player.isP2TutorialDone = false;
    saveGameData(); 
    
    startTutorialDialogue();
}

        function calculateTotalScore() {
            const pfScore = player.bestPortfolioScore * 50;
            const statScore = player.designStat * 10;
            const moneyScore = Math.floor(player.money / 1000);
            return pfScore + statScore + moneyScore;
        }

        window.openRankingPopup = function() {
            const myScore = calculateTotalScore();
            document.getElementById('my-rank-score').innerText = myScore.toLocaleString();
            const rankData = [ {name:"토스장인", score: myScore + 5000}, {name:"나야디자이너", score: myScore + 2300}, {name:"픽셀깎는노인", score: myScore + 120}, {name:"내이름(ME)", score: myScore, isMe: true}, {name:"신입1", score: Math.max(0, myScore - 1500)}, {name:"지나가던행인", score: Math.max(0, myScore - 4000)} ];
            let percent = 100; if(myScore > 10000) percent = 30; if(myScore > 50000) percent = 10; if(myScore > 100000) percent = 1;
            document.getElementById('my-rank-text').innerText = `상위 ${percent}% 디자이너`;
            const l = document.getElementById('ranking-list'); l.innerHTML = '';
            rankData.forEach((r, i) => {
                const rankClass = r.isMe ? 'ranking-item my-rank' : 'ranking-item';
                const rankColor = i < 3 ? 'top' : '';
                l.innerHTML += `<li class="${rankClass}"><span class="rank-num ${rankColor}">${i+1}</span><span class="rank-name">${r.name}</span><span class="rank-score">${r.score.toLocaleString()}</span></li>`;
            });
            openPopup('ranking-popup');
        }

        // ▼▼▼ 아래 3개 함수를 기존 코드에 덮어쓰세요 ▼▼▼

function saveGameData() { 
// ★ [핵심] 연출(컷신, 엔딩, 미니게임) 중일 때는 저장을 아예 막아버림
    // 이렇게 하면 '빈 방'이나 '이상한 화면' 상태가 저장될 일이 0%가 됩니다.
    if (player.isBusy) {
        console.log("⚠️ 연출 중이라 저장을 건너뜁니다. (데이터 보호)");
        return;
    }

    // 유저 해시를 키값에 포함
    localStorage.setItem('designer_game_data_' + tossUserHash, JSON.stringify(player)); 
    localStorage.setItem('designer_game_sound', isSoundOn); 
}

// [수정] 데이터 로드 (안전장치 추가)
function loadGameData() { 
    // 유저 해시로 데이터 로드
    const savedData = localStorage.getItem('designer_game_data_' + tossUserHash); 
    
    if(savedData) { 
        const parsed = JSON.parse(savedData);
        player = Object.assign({}, initialPlayerState, parsed);
        
        // ★ [핵심] 불러올 때 '연출 중' 상태면 강제로 해제 (멈춤 현상 방지)
        player.isBusy = false; 
        
        // ★ [핵심] 배경이 '빈 방(엔딩)' 상태로 저장되었을 리는 없지만, 혹시 모르니 티어값 보정
        if(!['Agency','TopTier','Unicorn','Global','Space'].includes(player.tier)) {
            player.tier = 'Agency';
        }

        // 구버전 호환성
        if (typeof player.isTutorialDone === 'undefined') player.isTutorialDone = player.isPhase2 ? true : false;
        if (typeof player.idleWeeks === 'undefined') player.idleWeeks = 0;
        if (player.isPhase2) updateSalary(); 
    } else {
        // 데이터 없으면 초기화
        console.log("새로운 유저 데이터 생성 (" + tossUserHash + ")");
        player = JSON.parse(JSON.stringify(initialPlayerState));
        genres.forEach(g => player.mastery.genre[g.id] = 1); 
        styles.forEach(s => player.mastery.style[s.id] = 1);
    }
    
    const savedSound = localStorage.getItem('designer_game_sound'); 
    if(savedSound !== null) isSoundOn = (savedSound === 'true'); 
}

// [수정] 게임 시작 함수 (비동기 로그인 로직 추가)
window.startGame = async function() {
    const intro = document.getElementById('intro-layer');
    if(!intro) return;
// 1. [핵심] 토스 라이브러리 동적 로딩 및 로그인 시도
    try {
        const { getUserKeyForGame } = await import('https://esm.sh/@apps-in-toss/web-framework');
        
        if (getUserKeyForGame) {
            const result = await getUserKeyForGame();
            if (result && result.type === 'HASH') {
                console.log("토스 로그인 성공:", result.hash);
                
                tossUserHash = result.hash; 
            }
        }
    } catch (e) {
        console.log("토스 환경이 아님 (게스트 모드):", e);
        
        // ▼▼▼ [확인용] 실패(게스트) 시 알림창 띄우기 ▼▼▼
        alert("⚠️ 토스 앱이 아닙니다.\n게스트 모드로 시작합니다.");
    }

    // 2. 결정된 유저(또는 게스트)로 데이터 로드
    loadGameData();
    updateUI(); // UI 갱신

    
    // 3. 인트로/사운드 처리 (기존 로직)
    // P2 데이터 호환성 처리
    if(typeof player.isP2TutorialDone === 'undefined') player.isP2TutorialDone = false;


    intro.style.transition = "opacity 0.5s";
    intro.style.opacity = "0";

    setTimeout(() => {
        intro.style.display = "none";
        
        // 튜토리얼 분기 처리
        if (player.isPhase2 && !player.isP2TutorialDone) {
            startTutorialDialogue();
        } else if (!player.isPhase2 && !player.isTutorialDone) {
            startTutorialDialogue();
        } else {
            realGameStart();
        }
    }, 500); 
};

// ▼▼▼ [1] 점수 제출 & 리더보드 열기 함수 추가 ▼▼▼

// 1. 현재 점수를 토스 서버에 제출하는 함수
async function submitTossScore() {
    try {
        // 현재 총점 계산 (기존 함수 활용)
        const myTotalScore = calculateTotalScore(); 
        
        // 라이브러리 로드
        const { submitGameCenterLeaderBoardScore } = await import('https://esm.sh/@apps-in-toss/web-framework');
        
        if (submitGameCenterLeaderBoardScore) {
            // 점수는 문자열(String)로 보내야 함
            const result = await submitGameCenterLeaderBoardScore({ score: myTotalScore.toString() });
            
            if (result && result.statusCode === 'SUCCESS') {
                console.log(`점수 제출 성공: ${myTotalScore}점`);
            }
        }
    } catch (e) {
        // 조용히 넘어감 (게임 흐름 방해 X)
        console.log("점수 제출 건너뜀 (토스 환경 아님)"); 
    }
}

// 2. 리더보드 열기 (점수 제출 -> 리더보드 오픈 순서)
window.openTossLeaderboard = async function() {
    try {
        const { openGameCenterLeaderboard, isMinVersionSupported } = await import('https://esm.sh/@apps-in-toss/web-framework');

        // 최신 점수를 먼저 서버에 반영! (중요)
        await submitTossScore();

        // 버전 체크
        const isSupported = isMinVersionSupported({ android: '5.221.0', ios: '5.221.0' });

        if (isSupported) {
            console.log("리더보드 뷰 호출");
            await openGameCenterLeaderboard();
        } else {
            alert("토스 앱을 업데이트해주세요.\n(리더보드 미지원 버전)");
        }
    } catch (e) {
        // 토스 앱이 아닐 경우
        alert("이 기능은 토스 앱에서만 가능합니다.\n(현재 점수: " + calculateTotalScore().toLocaleString() + "점)");
    }
};

window.toggleSound = function() { isSoundOn = document.getElementById('sound-toggle').checked; if(sceneContext && sceneContext.sound) sceneContext.sound.mute = !isSoundOn; saveGameData(); }
// [수정] 데이터 초기화 (유저별 데이터 삭제로 변경)
window.resetGameData = function() { 
    if(confirm("정말 모든 데이터를 삭제하고 초기화 하시겠습니까?")) { 
        // 1. 현재 로그인된 유저의 데이터 삭제 (핵심!)
        localStorage.removeItem('designer_game_data_' + tossUserHash); 
        
        // 2. 혹시 남아있을지 모르는 옛날 데이터도 삭제 (청소용)
        localStorage.removeItem('designer_game_data'); 
        
        // 3. 새로고침
        location.reload(); 
    } 
};
/* -----------------------------------------------------------
   [종료 팝업 및 뒤로가기 방지 로직]
   HTML 버튼의 onclick="함수명"과 정확히 일치시켰습니다.
----------------------------------------------------------- */

// 1. 뒤로가기 방지 설정 (페이지 로드 시 실행 필요)
function setupBackButton() { 
    history.pushState(null, null, location.href); 
    window.onpopstate = function () { 
        history.pushState(null, null, location.href); 
        openExitPopup(); // 뒤로가기 누르면 종료 팝업 띄움
    }; 
}

// 2. 팝업 열기 (X버튼 & 뒤로가기 키 공용)
window.openExitPopup = function() {
    var popup = document.getElementById('exit-popup');
    if (popup) {
        popup.style.display = 'flex'; // 팝업 보이기
        
        // (선택사항) 팝업 뜰 때 애니메이션 효과 리셋
        var content = popup.querySelector('.popup-content');
        if(content) {
            content.style.animation = 'none';
            content.offsetHeight; /* 리플로우 발생 (애니메이션 재시작용) */
            content.style.animation = 'slideUpFade 0.3s ease-out forwards';
        }
    }
}

// 3. 팝업 닫기 ('닫기' 버튼용) -> ★ 이 함수가 없어서 닫기가 안 됐을 겁니다
window.closeExitPopup = function() {
    var popup = document.getElementById('exit-popup');
    if (popup) {
        popup.style.display = 'none'; // 팝업 숨기기
    }
}

// 4. 게임 종료 ('종료하기' 버튼용) -> ★ 이름 변경 (confirmExit -> quitGame)
window.quitGame = function() {
    alert("게임을 종료합니다.\n진행 상황이 저장되었습니다.");
    
    // PC/모바일 브라우저 탭 닫기 시도
    window.close(); 
    
    // 카카오톡/앱 내 브라우저 종료 시도
    if(navigator.app && navigator.app.exitApp) {
        navigator.app.exitApp();
    }
}
// [Ver 60.5 Fix] 말풍선 위치 수정 (올바른 캐릭터 변수 참조)
function showSpeechBubble(text) {
    // 기존 말풍선 삭제
    const existing = document.getElementById('char-speech');
    if (existing) existing.remove();

    // 1. 현재 활성화된 캐릭터 찾기
    let targetSprite;
    let targetLayer;

    if (player.isPhase2) {
        targetSprite = charSuitSprite; // 정장 입은 고양이
        targetLayer = document.getElementById('phase2-ui-layer');
    } else {
        targetSprite = charHoodieSprite; // 후드티 입은 고양이
        targetLayer = document.getElementById('ui-layer');
    }

    if (!targetSprite || !targetLayer) return;

    // 2. 말풍선 생성
    const bubble = document.createElement('div');
    bubble.id = 'char-speech';
    bubble.className = 'speech-bubble';
    bubble.innerText = text;

    // 3. 캐릭터 위치 기준으로 좌표 계산
    // targetSprite.x는 화면 중앙(180)입니다.
    // 말풍선 너비(약 140px)를 고려해서 왼쪽으로 이동시킵니다.
    const offsetX = 120; 
    
    bubble.style.left = (targetSprite.x - offsetX) + 'px';
    bubble.style.top = '220px'; // 캐릭터 머리 높이 (고정값)

    // 4. 레이어에 추가
    targetLayer.appendChild(bubble);

    // 5. 3초 뒤 사라짐
    setTimeout(() => {
        if (bubble && bubble.parentNode) {
            bubble.style.opacity = '0'; 
            bubble.style.transition = 'opacity 0.5s';
            setTimeout(() => bubble.remove(), 500);
        }
    }, 3000);
}

setInterval(() => {
    // 조건: 바쁘지 않음 AND 팝업창 안 떠있음
    const isPopupOpen = document.getElementById('modal-overlay').style.display === 'block';
    
    // 메인 화면(UI 레이어가 보일 때)인지 체크
    const uiId = player.isPhase2 ? 'phase2-ui-layer' : 'ui-layer';
    const isMainScreen = document.getElementById(uiId).style.display !== 'none';
    
    if (!player.isBusy && !isPopupOpen && isMainScreen) {
        // [핵심] 현재 상황(취준/직장)에 맞는 긍정 멘트 로드
        // 만약 데이터가 없으면 기본값([])을 써서 에러 방지
        let targetMsgs = player.isPhase2 ? (msgs.idle_p2 || []) : (msgs.idle_p1 || []);
        
        if (targetMsgs.length > 0) {
            const msg = targetMsgs[Math.floor(Math.random() * targetMsgs.length)];
            showSpeechBubble(msg); 
        }
    }
}, 5000); // 5초마다 긍정 에너지 발산

// [Ver 63.5 Fix] 멘탈통 증가폭 하향 (레벨당 0.8)
function getMaxHp() {
    let lvl = Math.floor(player.designStat / 100);
    // [수정] 100 + (레벨 * 0.8)
    // Lv.26 기준: 100 + 20 = 120 (TopTier 4회, Unicorn 3회 가능)
    return 100 + Math.floor(lvl * 0.5);
}
// [Ver 64.0] 명예의 전당 시스템

// 1. 데이터 초기화 (로드 시 없으면 생성)
if (!player.hallOfFame) player.hallOfFame = [];

// 2. 현재 버프 합계 계산 함수
// [Ver 64.2] 티어별 차등 버프 계산
function getHofBuffs() {
    let buffs = { wealth: 0, speed: 0, fame: 0 };
    
    if(player.hallOfFame) {
        player.hallOfFame.forEach(item => {
            // 1. 티어별 가중치 설정
            let power = 1; // 기본 (Agency 혹은 옛날 데이터)
            
            if (item.companyTier === 'TopTier') power = 2;
            else if (item.companyTier === 'Unicorn') power = 3;
            else if (item.companyTier === 'Global') power = 4;
            else if (item.companyTier === 'Space') power = 5;

            // 2. 버프 합산
            if (item.buffType === 'wealth') buffs.wealth += power;
            if (item.buffType === 'speed') buffs.speed += power;
            if (item.buffType === 'fame') buffs.fame += power;
        });
    }
    return buffs;
}

// [수정] 명예의 전당 열기 (데이터 안전장치 추가)
window.openHallOfFame = function() {
    // ★ [핵심 수정] 데이터가 없으면 빈 배열로 즉시 초기화 (에러 방지)
    if (!player.hallOfFame) player.hallOfFame = [];
    if (!player.history) player.history = [];

    const list = document.getElementById('hof-list');
    list.innerHTML = '';
    
    player.hallOfFame.forEach((item, index) => {
        // 아이콘/텍스트 설정 (기존 로직 유지)
        let typeIcon = item.buffType === 'wealth' ? '💰' : (item.buffType === 'speed' ? '⚡' : '🎖️');
        let typeName = item.buffType === 'wealth' ? '연봉' : (item.buffType === 'speed' ? '속도' : '성과');
        
        let power = 1;
        if (item.companyTier === 'TopTier') power = 2;
        else if (item.companyTier === 'Unicorn') power = 3;
        else if (item.companyTier === 'Global') power = 4;
        else if (item.companyTier === 'Space') power = 5;

        let originTag = item.companyTier ? `[${item.companyTier}]` : `[Agency]`;

        list.innerHTML += `
        <li style="border: 1px solid #FFD700;">
            <div class="card-info">
                <h3 style="color:#FFD700; font-size:14px;">${typeIcon} ${item.name}</h3>
                <p style="font-size:12px; color:#B0B8C1;">
                    <span style="color:#fff; font-weight:bold;">${originTag}</span>
                    ${typeName} +${power}%
                </p>
            </div>
            <button class="btn-action" style="background:#FF5F5F; min-width:50px; font-size:11px;" onclick="removeFromHof(${index})">해제</button>
        </li>`;
    });

    // 빈 슬롯 표시
    for(let i=player.hallOfFame.length; i<3; i++) {
        list.innerHTML += `<li style="opacity:0.5; justify-content:center; border:1px dashed #555; font-size:12px;">(빈 슬롯)</li>`;
    }

    // 상단 요약 업데이트 (안전장치 함수 호출)
    const buffs = (typeof getHofBuffs === 'function') ? getHofBuffs() : { wealth:0, speed:0, fame:0 };
    
    if(document.getElementById('hof-wealth')) document.getElementById('hof-wealth').innerText = buffs.wealth;
    if(document.getElementById('hof-speed')) document.getElementById('hof-speed').innerText = buffs.speed;
    if(document.getElementById('hof-fame')) document.getElementById('hof-fame').innerText = buffs.fame;

    openPopup('hall-of-fame-popup');
}

// 4. 등록 팝업 열기
window.openRegisterPopup = function() {
    if (player.hallOfFame.length >= 3) return alert("전시 공간이 부족합니다. 기존 작품을 제거해주세요.");
    
    const list = document.getElementById('hof-candidate-list');
    list.innerHTML = '';
    
    // 기록(history)에서 S급이면서 아직 등록 안 된 것들만 필터링
    const candidates = player.history.filter(h => h.grade === 'S' && !player.hallOfFame.some(hof => hof.name === h.name));
    
    if (candidates.length === 0) {
        list.innerHTML = '<li style="justify-content:center;">등록 가능한 S급 프로젝트가 없습니다.</li>';
    }

    candidates.forEach(c => {
        // 구버전 데이터 호환 (buffType이 없으면 랜덤 부여)
        if(!c.buffType) c.buffType = ['wealth','speed','fame'][Math.floor(Math.random()*3)];
        
        let typeIcon = c.buffType === 'wealth' ? '💰' : (c.buffType === 'speed' ? '⚡' : '🎖️');
        
        // onclick 이벤트에 객체를 직접 넣기 어려우므로 인덱스 활용 등을 해야하나, 여기선 간편하게 구현
        // 주의: history 배열 순서가 바뀌지 않는다고 가정
        const idx = player.history.indexOf(c);
        
        list.innerHTML += `
        <li onclick="registerToHof(${idx})">
            <div class="card-info">
                <h3>${c.name}</h3>
                <p>${typeIcon} 효과 보유</p>
            </div>
            <button class="btn-buy">전시</button>
        </li>`;
    });
    
    document.getElementById('hall-of-fame-popup').style.display = 'none'; // 메인 닫고
    document.getElementById('hof-register-popup').style.display = 'flex'; // 등록 열기
}
// [FIX] 등록 취소 시 다시 명예의 전당 메인으로 복귀
window.closeRegisterPopup = function() {
    document.getElementById('hof-register-popup').style.display = 'none'; // 등록 팝업 닫기
    openHallOfFame(); // 메인 명예의 전당 팝업 다시 열기 (이게 핵심!)
}
// 5. 실제 등록
window.registerToHof = function(historyIdx) {
    const item = player.history[historyIdx];
    if(!item.buffType) item.buffType = ['wealth','speed','fame'][Math.floor(Math.random()*3)];
    
    player.hallOfFame.push(item);
    
    document.getElementById('hof-register-popup').style.display = 'none';
    openHallOfFame(); // 다시 메인 열기
}

// 6. 제거
window.removeFromHof = function(index) {
    if(confirm("전시를 내리시겠습니까? 버프가 사라집니다.")) {
        player.hallOfFame.splice(index, 1);
        openHallOfFame();
    }
}





// [수정] 메인 게임 화면 진입 (초기화 강화)
function realGameStart() {
    const w = sceneContext.scale.width;
    const h = sceneContext.scale.height;

    // 1. [핵심] 엔딩 BGM이 들린다면 강제로 끄기
    if(soundEnding && soundEnding.isPlaying) {
        soundEnding.stop();
    }

    // 2. 캐릭터 일단 다 숨김
    if(charHoodieSprite) charHoodieSprite.setVisible(false);
    if(charSuitSprite) charSuitSprite.setVisible(false);
    if(charWorkSprite) charWorkSprite.setVisible(false);
    if(charSuitWorkSprite) charSuitWorkSprite.setVisible(false);

    // 3. 페이즈에 맞는 캐릭터와 배경 켜기
    if(player.isPhase2) {
        document.getElementById('phase2-ui-layer').style.display = 'flex';
        
        // 배경 강제 설정 (빈 화면 방지)
        setBgByTier(player.tier); 
        
        if(charSuitWorkSprite) {
            charSuitWorkSprite.setVisible(true);
            adjustCharacterSize(charSuitWorkSprite, w, h);
        }
    } else {
        document.getElementById('ui-layer').style.display = 'flex';
        
        // 배경 강제 설정
        if(bgSprite) {
            let bgKey = isNightTime() ? 'bg_main_night' : 'bg_main';
            if(sceneContext.textures.exists(bgKey)) bgSprite.setTexture(bgKey);
            else bgSprite.setTexture('bg_main'); // 안전장치
            fitToScreen(bgSprite);
        }

        if(charWorkSprite) {
            charWorkSprite.setVisible(true);
            adjustCharacterSize(charWorkSprite, w, h);
        }
    }
    
    // 4. 상태 강제 초기화 (혹시 모르니 한번 더)
    player.isBusy = false;
    if(sceneOverlay) sceneOverlay.setVisible(false); // 컷신 배경 끄기

    updateAudioState('main');
}
// [수정] 오디오 상태 관리 (SSS급 우선순위 적용)
function updateAudioState(state) {
    if (!isSoundOn) {
        if(currentBgm && currentBgm.isPlaying) currentBgm.stop();
        if(soundIntro) soundIntro.stop();
        // SSS 음악도 멈춤
        if(soundSSS && soundSSS.isPlaying) soundSSS.stop();
        return;
    }

    // state: 'main' (재생), 'mute' (일시정지/멈춤)
    if (state === 'mute') {
        if (soundP1 && soundP1.isPlaying) soundP1.pause();
        if (soundP2 && soundP2.isPlaying) soundP2.pause();
        if (soundSSS && soundSSS.isPlaying) soundSSS.pause(); // SSS 일시정지
        if (soundAI && soundAI.isPlaying) soundAI.pause();
    } 
    else if (state === 'main') {
        if (soundAI) soundAI.stop(); // 컷신 음악 끄기

        // ▼▼▼ [핵심] BGM 우선순위 결정 로직 ▼▼▼
        let targetBgm;

        // 1순위: SSS급 프로젝트 진행 중일 때
        if (player.currentProject && player.currentProject.isSingularity) {
            targetBgm = soundSSS;
        } 
        // 2순위: Phase 2 (직장인)
        else if (player.isPhase2) {
            targetBgm = soundP2;
        } 
        // 3순위: Phase 1 (취준생)
        else {
            targetBgm = soundP1;
        }

        // --- 재생 로직 (변경 필요할 때만 스위칭) ---
        
        // 만약 다른 음악이 나오고 있다면 끄기
        if (currentBgm && currentBgm !== targetBgm) {
            currentBgm.stop();
        }
        
        // 목표 음악이 재생 중이 아니라면 재생
        if (targetBgm && !targetBgm.isPlaying) {
            targetBgm.play();
        }
        
        // 현재 BGM 갱신
        currentBgm = targetBgm;
    }
}
// [튜토리얼 데이터]
const tutoMessages = [
    { name: "🎓 멘토", text: "반갑네! 자네가 훌륭한 디자이너가 될 수 있도록 내가 하나씩 알려주겠네." },
    { name: "🎓 멘토", text: "자네의 목표는 최고의 [포트폴리오]를 만들어 좋은 회사에 '취업'하는 걸세!" },
    { name: "💡 생존 팁", text: "돈이 없으면 [알바]를 뛰어야 해. 하지만 [체력] 관리는 필수네. 쓰러지면 안 되니까." },
    { name: "💡 성장 팁", text: "번 돈으로 [스킬 업]을 하고 좋은 [장비]를 맞춰야 명작이 나온다네." },
    { name: "🎓 멘토", text: "자, 이제 [새 프로젝트]를 눌러서 첫 작품을 만들어보게. 행운을 비네!" }
];
// ★ [추가] 페이즈 2 (직장인) 대사
const tutoMessagesP2 = [
    { name: "팀장", text: "자네가 새로 온 신입인가? 합격을 축하하네." },
    { name: "팀장", text: "회사는 실전이야. [업무 수행]을 통해 성과를 증명하고 승진하게." },
    { name: "💡 처세술", text: "힘들 땐 [동료]들과 어울리거나 [휴식]으로 멘탈을 관리해야 오래 버틸 수 있어." },
    { name: "💡 자기계발", text: "현실에 안주하지 말고 [스킬]을 계속 갈고닦게. 그래야 더 높은 곳(이직)으로 갈 수 있지." },
    { name: "팀장", text: "자, 그럼 자리로 가서 업무를 시작해 보게나!" }
];
let tutoIndex = 0;

// 1. 튜토리얼 시작
function startTutorialDialogue() {
    tutoIndex = 0;
    document.getElementById('tutorial-overlay').style.display = 'flex';
    showTutoLine();
}

// 2. 대사 보여주기 (페이즈에 따라 데이터 교체)
function showTutoLine() {
    // ★ 현재 페이즈에 맞는 메시지 배열 선택
    const currentMsgs = player.isPhase2 ? tutoMessagesP2 : tutoMessages;
    const data = currentMsgs[tutoIndex];
    
    document.getElementById('tuto-name').innerText = data.name;
    document.getElementById('tuto-text').innerText = data.text;
    
    // 버튼 텍스트 변경 logic
    const btn = document.getElementById('tuto-btn');
    if(tutoIndex === currentMsgs.length - 1) {
        // 페이즈에 따라 버튼 멘트도 다르게
        btn.innerText = player.isPhase2 ? "업무 시작하기 (Start)" : "디자이너 도전하기 (Start)";
        btn.style.backgroundColor = "#3182F6"; 
    } else {
        btn.innerText = "네, 알겠습니다. (다음)";
        btn.style.backgroundColor = "#191F28";
    }
}

// [수정] 튜토리얼 종료 처리 (자동 기획 팝업 오픈)
window.nextTutorialLine = function() {
    tutoIndex++;
    
    // 현재 페이즈 메시지 배열 확인
    const currentMsgs = player.isPhase2 ? tutoMessagesP2 : tutoMessages;

    if(tutoIndex < currentMsgs.length) {
        // 대사 진행
        showTutoLine();
    } else {
        // 튜토리얼 종료 (창 닫기)
        document.getElementById('tutorial-overlay').style.display = 'none';

        if (player.isPhase2) {
            // [Phase 2] 직장인
            player.isP2TutorialDone = true; 
            saveGameData();
            realGameStart();
        } else {
            // [Phase 1] 취준생
            player.isTutorialDone = true;   
            
            // 1. 메인 화면(캐릭터, UI) 표시
            realGameStart(); 
            
            // 2. 저장
            saveGameData();
            
            // 3. [핵심] 안내 후 '기획 팝업' 자동 오픈
            setTimeout(() => {
                alert("🚀 튜토리얼 완료!\n\n이제 당신만의 첫 프로젝트를 시작할 차례입니다.\n원하는 주제와 스타일을 선택해 보세요!");
                
                // 강제 시작 대신, 기획 팝업을 열어줌
                openPopup('planning-popup'); 
            }, 300);
        }
    }
}
// [수정] 플로팅 텍스트 (이모지+줄바꿈 지원을 위해 innerHTML 사용)
function showFloatingText(x, y, text, color='#fff') {
    const el = document.createElement('div');
    el.className = 'float-text';
    
    // ★ 핵심 변경: innerText -> innerHTML (태그 인식)
    el.innerHTML = text; 
    
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.color = color;
    
    // 중앙 정렬 및 텍스트 중앙 정렬 추가
    el.style.transform = 'translate(-50%, -50%)'; 
    el.style.textAlign = 'center'; 
    el.style.zIndex = '99999';
    
    document.getElementById('game-container').appendChild(el);

    // 애니메이션 후 삭제
    setTimeout(() => {
        el.remove();
    }, 1000); // 1초 뒤 사라짐
}
// [낮/밤 판별 함수]
// 밤 기준: 오후 6시(18시) ~ 오전 6시(06시)
function isNightTime() {
    const h = new Date().getHours();
    return h >= 18 || h < 6;
}
// [면접 시스템 변수]
let interviewStep = 0;
let interviewStats = { P: 10, L: 10, S: 10 }; // 초기 스탯 (열정, 논리, 센스)
let interviewTargetJob = null;
let currentQuestions = [];

// 1. 면접 시작
// [Ver 76.0 Fix] 면접 힌트 미노출 수정 (데이터 조회 기능 추가)
function startInterview(jobName, tier) {
    // ★★★ [신규 기능] 쿨타임 체크 (입구 컷) ★★★
    if (interviewCooldowns[jobName] && Date.now() < interviewCooldowns[jobName]) {
        let remainSec = Math.ceil((interviewCooldowns[jobName] - Date.now()) / 1000);
        alert(`[지원 불가] 🛑\n불합격의 충격으로 멘탈이 나갔습니다.\n\n마음을 추스르기까지 ${remainSec}초 남았습니다.`);
        return; // 면접 시작 안 하고 강제 종료
    }
    // 1. 원본 데이터(companyPool)에서 해당 회사의 정보를 찾습니다.
    let poolKey = tier.toLowerCase(); // 'Agency' -> 'agency'
    let pool = companyPool[poolKey]; 
    
    // 안전장치
    if (!pool) pool = []; 

    // 이름이 같은 회사 정보를 찾음
    let targetData = pool.find(c => c.name === jobName);

    // 2. 찾은 정보를 interviewTargetJob에 넣습니다. (이제 hint도 포함됨!)
    if (targetData) {
        // 깊은 복사로 가져옴 (원본 손상 방지)
        interviewTargetJob = JSON.parse(JSON.stringify(targetData));
    } else {
        // 만약 못 찾으면 기본값 (안전장치)
        interviewTargetJob = { name: jobName, tier: tier, hint: "목표: 최선을 다해 답변하세요!" };
    }

    // 3. 면접 초기화
    interviewStep = 0;
    interviewStats = { P: 10, L: 10, S: 10 }; 
    
    // 질문 3개 랜덤
    let shuffled = [...interviewData].sort(() => 0.5 - Math.random());
    currentQuestions = shuffled.slice(0, 3);

    updateInterviewUI();
    openPopup('interview-popup');
}

// [수정] UI 업데이트 (스탯 표시 제거 -> 대기 상태 텍스트)
function updateInterviewUI() {
    const statsDisplay = document.getElementById('interview-stats-display');
    
    // 1. 상단 박스 초기화 (질문이 넘어갈 때마다)
    if(statsDisplay) {
        // 기존 클래스 제거 (애니메이션 리셋)
        statsDisplay.classList.remove('reaction-pop');
        
        // 기본 상태 텍스트 (이모지 없음)
        statsDisplay.innerHTML = `<span style="color:#B0B8C1; font-size:12px;">👂 경청 중...</span>`;
        statsDisplay.style.borderColor = "#444"; // 테두리 색 초기화
    }

    // 종료 체크
    if (interviewStep >= 3) {
        playInterviewSuspense();
        return;
    }

    const qData = currentQuestions[interviewStep];
    
    // 2. 질문 텍스트 업데이트
    document.getElementById('interview-q-text').innerText = `Q${interviewStep+1}. ${qData.q}`;

    // 3. 힌트 업데이트
    const hintEl = document.getElementById('interview-q-hint');
    if (interviewTargetJob && interviewTargetJob.hint) {
        hintEl.innerHTML = interviewTargetJob.hint;
    } else {
        hintEl.innerHTML = "목표: 최선을 다해 답변하세요!";
    }
    hintEl.className = "interview-hint-badge hint-blue"; 

    // 4. 답변 버튼 생성
    const ansContainer = document.getElementById('interview-answers');
    ansContainer.innerHTML = '';
    
    let answers = [...qData.a].sort(() => 0.5 - Math.random()); 

    answers.forEach(ans => {
        const btn = document.createElement('button');
        btn.className = 'interview-btn'; 
        btn.innerText = ans.text;
        btn.onclick = () => submitAnswer(ans.effect);
        ansContainer.appendChild(btn);
    });
}

// [수정] 답변 제출 (플로팅 제거 -> 우측 상단에 반응 표시)
function submitAnswer(effect) {
    // 1. 스탯 계산
    interviewStats.P += effect.P;
    interviewStats.L += effect.L;
    interviewStats.S += effect.S;

    interviewStats.P = Math.max(0, interviewStats.P);
    interviewStats.L = Math.max(0, interviewStats.L);
    interviewStats.S = Math.max(0, interviewStats.S);

    // 2. 반응 분석
    let maxChange = Math.max(effect.P, effect.L, effect.S);
    let minChange = Math.min(effect.P, effect.L, effect.S);
    
    let emoji = "";
    let reactionMsg = "";
    let reactionColor = "#fff"; // 텍스트 색상
    let borderColor = "#444";   // 박스 테두리 색상

    // (1) 대실수
    if (minChange <= -8) {
        emoji = "😡"; 
        reactionMsg = "치명적 실수!";
        reactionColor = "#FF5F5F"; 
        borderColor = "#FF5F5F";
    }
    else if (minChange <= -5) {
        emoji = "🤨"; 
        reactionMsg = "반응이 싸합니다.";
        reactionColor = "#FF8B8B"; 
        borderColor = "#FF8B8B";
    }
    // (2) 대박
    else if (maxChange >= 12) {
        emoji = "🤩"; 
        reactionMsg = "완벽합니다!";
        reactionColor = "#4CD964"; 
        borderColor = "#4CD964";
    }
    else if (maxChange >= 8) {
        emoji = "🙂"; 
        reactionMsg = "호감 상승";
        reactionColor = "#66FF99"; 
        borderColor = "#66FF99";
    }
    // (3) 무난함
    else {
        emoji = "😐"; 
        reactionMsg = "평이하군요.";
        reactionColor = "#B0B8C1"; 
        borderColor = "#B0B8C1";
    }

    // 3. [핵심] 우측 상단 박스에 집어넣기 (겹침 방지)
    const statsDisplay = document.getElementById('interview-stats-display');
    if(statsDisplay) {
        // 내용 교체 (이모지 + 텍스트)
        statsDisplay.innerHTML = `
            <span style="font-size:18px;">${emoji}</span>
            <span style="font-size:13px; font-weight:bold; color:${reactionColor};">${reactionMsg}</span>
        `;
        
        // 테두리 색상 변경으로 강조
        statsDisplay.style.borderColor = borderColor;
        
        // 팝업 애니메이션 효과 (강조)
        statsDisplay.classList.remove('reaction-pop'); // 리셋
        void statsDisplay.offsetWidth; // 리플로우 강제 (애니메이션 재시작용 꼼수)
        statsDisplay.classList.add('reaction-pop');
    }

    // 4. 다음 단계로
    interviewStep++;
    
    // 답변 버튼을 0.8초 뒤에 갱신 (반응을 볼 시간을 줌)
    setTimeout(() => {
        updateInterviewUI();
    }, 800);
}

// [수정] 면접 결과 처리 (디자인 팝업 적용)
window.finishInterview = function() {
    closePopup(); // 면접 진행 팝업 닫기
    
    let passed = false;
    let failReason = "";

    // 1. 과락 및 점수 체크 (기존 로직 유지)
    if (interviewStats.P < 5 || interviewStats.L < 5 || interviewStats.S < 5) {
        passed = false;
        failReason = "인재상과 맞지 않는 부분이 있어 아쉽게 탈락하셨습니다.";
    } 
    else {
        if (interviewTargetJob.tier === 'Agency') {
            if (interviewStats.P >= 20) passed = true;
            else failReason = `열정이 부족하여 불합격했습니다.\n(필요: 열정 20점 이상)`;
        } 
        else {
            if (interviewStats.L >= 22 || interviewStats.S >= 22) passed = true;
            else failReason = `확실한 강점(논리 or 센스 22점↑) 어필에 실패했습니다.`;
        }
    }

    // 2. 팝업 데이터 설정 및 열기
    showInterviewResultPopup(passed, failReason);
};

// [신규] 결과 팝업 띄우기 함수
function showInterviewResultPopup(passed, failReason) {
    const popup = document.getElementById('interview-result-popup');
    const card = document.getElementById('interview-result-card');
    const icon = document.getElementById('res-icon');
    const title = document.getElementById('res-title');
    const company = document.getElementById('res-company');
    const msg = document.getElementById('res-msg');
    const subMsg = document.getElementById('res-sub-msg');
    const btnArea = document.getElementById('res-btn-area');

    // 팝업 열기 (배경 오버레이 포함)
    document.getElementById('modal-overlay').style.display = 'block';
    popup.style.display = 'flex';

    company.innerText = `${interviewTargetJob.name} 인사팀`;

    if (passed) {
        // [합격 스타일]
        card.className = "result-card-box theme-success";
        icon.innerText = "🎉";
        title.innerText = "최종 합격!";
        msg.innerHTML = `축하합니다!<br>귀하를 <b>${interviewTargetJob.tier}</b> 등급 디자이너로<br>채용하고자 합니다.`;
        subMsg.innerText = "";
        
        // 합격 데이터 저장
        if(interviewCooldowns[interviewTargetJob.name]) delete interviewCooldowns[interviewTargetJob.name];
        pendingOffer = { 
            name: interviewTargetJob.name, 
            score: player.bestPortfolioScore, 
            newTier: interviewTargetJob.tier 
        };

        // 버튼: 입사하기
        btnArea.innerHTML = `
            <button class="full-btn" onclick="acceptOffer()" style="background:#3182F6;">
                서명하고 입사하기
            </button>
        `;
        
        // 효과음
        if(isSoundOn && soundEnding) soundEnding.play();

    } else {
        // [불합격 스타일]
        card.className = "result-card-box theme-fail";
        icon.innerText = "😭";
        title.innerText = "불합격 통보";
        msg.innerHTML = `아쉽게도 이번 채용에서는<br>귀하를 모시지 못하게 되었습니다.<br><br>"${failReason}"`;
        
        // 페널티 적용
        player.hp = Math.max(0, player.hp - 30);
        let penaltyTime = 3 * 60 * 1000;
        interviewCooldowns[interviewTargetJob.name] = Date.now() + penaltyTime;
        
        subMsg.innerText = `(멘탈 -30, 3분간 재지원 불가)`;

        // 버튼: 닫기
        btnArea.innerHTML = `
            <button class="full-btn" onclick="closePopup()" style="background:#454F5D;">
                돌아가기
            </button>
        `;
    }
}

// [NEW] 부모님 잔소리 이벤트 함수
function triggerNaggingEvent() {
    // 1. 랜덤 대사 추출
    const msg = naggingMsgs[Math.floor(Math.random() * naggingMsgs.length)];
    
    // 2. 멘탈 감소 (HP -10)
    player.hp = Math.max(0, player.hp - 10);
    
    // 3. 카운터 리셋 (한번 혼났으니 당분간 조용함)
    player.idleWeeks = 0;

    // 4. 알림창 띄우기
    alert(`💢 [공백기 경고] 부모님의 잔소리!\n\n"${msg}"\n\n(포트폴리오 작업을 너무 오래 쉬었습니다. 멘탈 -10)`);
    
    // 5. UI 업데이트 (HP 깎인 거 반영)
    updateUI();
}


// [캐릭터 크기 및 위치 조정 헬퍼 함수]
function adjustCharacterSize(sprite, w, h) {
    if(!sprite) return;
    
    // 1. 크기: 화면 높이의 25%로 대폭 축소 (기존 35% -> 25%)
    // 더 작게 하려면 0.2로 줄이세요.
    const targetHeight = h * 0.25; 
    
    // 2. 비율 유지하며 크기 변경
    sprite.setDisplaySize(targetHeight * (sprite.width / sprite.height), targetHeight);
    
// 3. 위치: 위로 끌어올림 (수정됨)
// h * 0.05 만큼 빼서 화면 중앙보다 위로 올립니다.
sprite.setPosition(w / 2, h / 2 - (h * 0.02));

    // 4. 고정
    sprite.setScrollFactor(0);
    // ★★★ [핵심] 여기서 강제로 보이게 만듭니다! ★★★
    sprite.setVisible(true); 
    sprite.setAlpha(1); // 혹시 투명도가 0일까봐 1로 강제 설정
}
if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker Registered'));
    }
    // ==========================================
// [테스트용 치트 함수]
// ==========================================

// 1. 스킬 레벨 업 (디자인 스탯 +100)
window.cheatLevelUp = function() {
    player.designStat += 100;
    updateUI();
    // 화면 중앙에 연출 텍스트 띄우기
    showFloatingText(180, 300, "스킬 급상승! (+100)", "#9956DE");
}

window.cheatMoney = function() {
    // 1. 현재 정보로 급여 갱신
    updateSalary(); 

    // 2. 월 수입 계산 (주급 * 4.5)
    let monthlyIncome = Math.floor(player.salary * 4.5);
    
    // 3. 세금(품위유지비) 계산 (게임 내 로직과 동일)
    const costTable = { Agency: 300000, TopTier: 600000, Unicorn: 1400000, Global: 20000000, Space: 200000000 };
    // 현재 티어에 맞는 기본 세금 가져오기 (없으면 Agency 기준)
    let baseCost = costTable[player.tier] || 300000;
    // 직급(사원,대리,팀장..)에 따른 가중치
    let rankMult = 1 + (player.rank * 0.2);
    let monthlyCost = Math.floor(baseCost * rankMult);
    let costName = "세금 및 품위 유지비";

    // [예외 처리] 만약 취준생(Phase 1)이라 월급이 0원인 경우, 
    // 치트 기능이 작동하도록 Agency 급여 기준으로 강제 설정
    if (!player.isPhase2 || monthlyIncome === 0) {
        monthlyIncome = Math.floor(450000 * 4.5); // Agency 기본급 기준
        monthlyCost = 150000; // Phase 1 생활비
        costName = "특별 생활비 (치트)";
    }

    // 4. 실제 입금 처리 (수입 더하고 세금 뺌)
    player.money += monthlyIncome;
    
    if (player.money >= monthlyCost) {
        player.money -= monthlyCost;
    } else {
        player.money = 0; // 잔고 부족 시 0원
    }

    // 5. UI 갱신
    updateUI();

    // 6. 월급 명세서 팝업 띄우기 (기존 함수 재사용)
    // openPaydayPopup(수입, 지출, 지출항목이름)
    openPaydayPopup(monthlyIncome, monthlyCost, costName);
    
    // 이펙트
    showFloatingText(180, 300, "월급 수령 완료", "#4CD964");
}

// 3. 체력 완전 회복
window.cheatHp = function() {
    player.hp = getMaxHp(); // 현재 레벨에 맞는 최대 체력으로 회복
    updateUI();
    showFloatingText(180, 300, "컨디션 최고조! (Full)", "#4CD964");
}

// 4. 패널 숨기기/보이기 (테스트 중 화면 가릴 때 사용)
window.toggleCheatPanel = function() {
    const btns = document.querySelectorAll('#cheat-panel button:not(:last-child)');
    btns.forEach(btn => {
        btn.style.display = (btn.style.display === 'none') ? 'block' : 'none';
    });
}
// [수정] 디자인 어워드 (팝업 띄우기)
// 기존 alert 방식 대신 전용 팝업을 띄웁니다.
window.triggerDesignAward = function() {
    // 이번 시즌 최고 점수 확인
    let score = player.seasonBestScore || 0;
    
    // 점수별 등급 및 상금 산정
    let title = "참가상 (No Rank)";
    let prizeMoney = 0; 
    let icon = "📄";
    let color = "#888"; // 기본 색상

    if (score >= 100000) { 
        title = "🏆 대상 (Grand Prix)"; 
        prizeMoney = 500000000; icon = "👑"; color = "#FFD700"; // 골드
    } else if (score >= 50000) { 
        title = "🥇 금상 (Gold)"; 
        prizeMoney = 200000000; icon = "🥇"; color = "#FFD700";
    } else if (score >= 10000) { 
        title = "🥈 은상 (Silver)"; 
        prizeMoney = 50000000; icon = "🥈"; color = "#C0C0C0"; // 실버
    } else if (score >= 3000) { 
        title = "🥉 동상 (Bronze)"; 
        prizeMoney = 10000000; icon = "🥉"; color = "#CD7F32"; // 브론즈
    }

    // 1. 팝업 내용 채우기
    document.getElementById('award-icon').innerText = icon;
    document.getElementById('award-title').innerText = title;
    document.getElementById('award-title').style.color = color; // 등급별 색상 적용
    document.getElementById('award-score-val').innerText = score.toLocaleString();
    
    const prizeEl = document.getElementById('award-money');
    if (prizeMoney > 0) {
        prizeEl.innerText = `₩ ${prizeMoney.toLocaleString()}`;
        // 버튼에 데이터 심어두기 (클릭 시 수령)
        document.querySelector('.award-btn').setAttribute('data-prize', prizeMoney);
        document.querySelector('.award-btn').innerText = "상금 수령하기";
        document.querySelector('.award-btn').disabled = false;
        
        // 팡파레 효과음 (엔딩음 활용)
        if(isSoundOn && soundEnding) soundEnding.play();
    } else {
        prizeEl.innerText = "수상 실패";
        document.querySelector('.award-btn').setAttribute('data-prize', 0);
        document.querySelector('.award-btn').innerText = "다음 기회에...";
    }

    // 2. 팝업 열기
    document.getElementById('award-popup').style.display = 'flex';
};

// [신규] 상금 수령 버튼 클릭 시 실행
window.claimAward = function() {
    const btn = document.querySelector('.award-btn');
    const prize = parseInt(btn.getAttribute('data-prize') || 0);

    // 1. 돈 지급
    if (prize > 0) {
        player.money += prize;
        showFloatingText(180, 300, `+${prize.toLocaleString()}원`, '#FFD700'); // 돈 획득 연출
    }

    // 2. 시즌 점수 초기화
    player.seasonBestScore = 0;

    // 3. 팝업 닫기
    document.getElementById('award-popup').style.display = 'none';
    
    // 4. 저장 및 UI 갱신
    saveGameData();
    updateUI();
    
    // 5. 토스 랭킹 점수 갱신 (상금 먹어서 총점 올랐으니까)
    if(window.submitTossScore) window.submitTossScore();
};

// [복구] 급여 계산 (어워드 영구 인상 로직 삭제됨)
function updateSalary() {
    let base = BASE_SALARY[player.tier] || 180000;
    let multi = RANK_MULTIPLIER[player.rank] || 1;
    
    // 명예의 전당(Wealth) 버프만 적용
    let buff = getHofBuffs().wealth; 
    let buffMult = 1 + (buff / 100);

    player.salary = Math.floor(base * multi * buffMult);
}
// [신규] 면접 결과 발표 전 긴장감 조성 함수
function playInterviewSuspense() {
    const overlay = document.getElementById('suspense-overlay');
    const txt = document.getElementById('suspense-text');
    const heart = overlay.querySelector('div:first-child');
    
    // 1. 오버레이 켜기
    // 기존 면접 팝업은 닫지 않고 그 위에 덮습니다 (더 자연스러움)
    overlay.style.display = 'flex';
    heart.classList.add('heart-effect'); // 쿵쿵 애니메이션 시작

    // 2. 긴장되는 멘트 시퀀스
    const suspenseMsgs = [
        "면접관들이 서로 눈빛을 교환합니다...", 
        "당신의 답변을 다시 체크 중...", 
        "인사팀장이 고개를 끄덕입니다...", 
        "채용 담당자가 펜을 들었습니다!", 
        "과연 결과는...?"
    ];

    let step = 0;
    
    // 첫 멘트
    txt.innerText = suspenseMsgs[0];

    // 3. 1초마다 멘트 변경 (총 3초 대기)
    let iv = setInterval(() => {
        step++;
        if (step < 3) { // 3단계까지만 보여줌
            // 랜덤 멘트 출력으로 지루함 방지
            const msg = suspenseMsgs[Math.floor(Math.random() * suspenseMsgs.length)];
            txt.innerText = msg;
        } else {
            // 4. 종료 및 결과 발표
            clearInterval(iv);
            overlay.style.display = 'none';
            heart.classList.remove('heart-effect');
            
            // ★ 여기서 진짜 결과 함수를 호출!
            finishInterview(); 
        }
    }, 1200); // 1.2초 간격
}
// [교체] 결과 팝업 열기 (이모지 로직 제거됨)
window.openResultPopup = function(type, title, desc, stats) {
    const popup = document.getElementById('result-popup');
    const card = popup.querySelector('.result-card');
    const stamp = document.getElementById('result-stamp'); // 도장
    const statBox = document.getElementById('result-stat-box');

    // 1. 초기화 (클래스 리셋)
    card.classList.remove('res-success', 'res-fail');
    
    // 애니메이션 재실행을 위한 꼼수 (도장 쾅!)
    stamp.style.animation = 'none';
    stamp.offsetHeight; /* 리플로우 */
    stamp.style.animation = 'stampCrash 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';

    // 2. 타입별 설정
    if (type === 'success') {
        card.classList.add('res-success');
        stamp.innerText = "APPROVED"; // 성공 도장
    } else {
        card.classList.add('res-fail');
        stamp.innerText = "REJECTED"; // 실패 도장
    }

    // 3. 텍스트 채우기 (중앙 정렬은 CSS가 담당)
    document.getElementById('result-title').innerText = title;
    
    // 4. 점수표 채우기
    statBox.innerHTML = '';
    stats.forEach(s => {
        let color = s.val.toString().includes('-') ? '#FF5F5F' : '#4CD964';
        if(s.color) color = s.color;
        
        statBox.innerHTML += `
            <div class="stat-row">
                <span style="color:#8B95A1;">${s.label}</span>
                <span style="color:${color}; font-weight:700;">${s.val}</span>
            </div>
        `;
    });

    openPopup('result-popup');
};

// [수정] 결과 팝업 닫기 (광고 없이 즉시 진행)
window.closeResultPopup = function() {
    // 1. 팝업 닫기
    const popup = document.getElementById('result-popup');
    if(popup) popup.style.display = 'none';
    closePopup(); // 배경(오버레이) 닫기

    // 2. 후처리 (다음 단계 진행)
    if (player.isPhase2) {
        // 프로젝트가 비어있으면(완료했거나 AI한테 져서 삭제됨) 새 프로젝트 할당
        if (!player.currentProject) {
            console.log("새 프로젝트 할당 시작...");
            assignProject(); // 새 업무 받기
            
            // 시간 경과 (주차 넘어감)
            addTime(true); 
        }
        // UI 갱신
        updateUI();
    } else {
        // 페이즈 1이면 그냥 저장하고 끝
        saveGameData();
        updateUI();
    }
};

// [수정] AI 컷신 실행 (이미지 로딩 버그 수정)
function showRivalIntro(targetScore) {
    const layer = document.getElementById('rival-intro-layer');
    const img = layer.querySelector('.rival-bg-img'); // 이미지 요소
    const textBox = document.getElementById('rival-typing-text');
    const scoreBox = document.getElementById('rival-intro-target');
    
    // 1. 화면 켜기
    layer.style.display = 'block';
    layer.style.opacity = "1"; // 투명도 확실히 복구
    scoreBox.innerText = targetScore.toLocaleString();
    
    // 2. [핵심] 이미지 애니메이션 강제 리셋 (버그 수정)
    // 기존 애니메이션 클래스를 제거했다가 다시 붙여서 처음부터 재생되게 함
    img.style.animation = 'none';
    img.offsetHeight; /* 리플로우 강제 (브라우저가 스타일 변경을 인식하게 함) */
    img.style.animation = 'dramaFadeIn 2s forwards, slowZoom 10s infinite alternate';
    img.style.opacity = "0"; // 시작은 투명하게

    // 3. AI 대사 리스트
    const lines = [
        "검토 결과, 인간의 승률은 0.002% 입니다.\n포기하시겠습니까?",
        "효율성 제로의 유기체여...\n나의 연산 속도를 따라올 수 있겠나?",
        "데이터 분석 완료. 너의 패턴은 단순하군.\n압도적인 차이를 보여주지.",
        "감정 따위가 디자인에 필요할까?\n완벽한 논리의 미학을 가르쳐주마."
    ];
    const text = lines[Math.floor(Math.random() * lines.length)];
    
    // 4. 타이핑 효과
    textBox.innerText = "";
    let i = 0;
    if (window.rivalTypingIv) clearInterval(window.rivalTypingIv);
    
    setTimeout(() => {
        window.rivalTypingIv = setInterval(() => {
            textBox.innerText += text.charAt(i);
            i++;
            if (i >= text.length) clearInterval(window.rivalTypingIv);
        }, 50);
    }, 1000);
}
// 경고창 열기 (assignProject에서 호출)
window.openRivalWarningPopup = function(targetScore) {
    pendingRivalTarget = targetScore; // 점수 임시 저장
    
    // 팝업 열기
    const popup = document.getElementById('rival-warning-popup');
    popup.style.display = 'flex';
    
// ▼▼▼ [음악 교체 로직] ▼▼▼
    if (isSoundOn) {
        // 1. 현재 재생 중인 음악(사무실 BGM) 일시정지
        if (currentBgm && currentBgm.isPlaying) {
            currentBgm.pause();
        }

        // 2. AI 테마곡 재생
        if (soundAI) {
            soundAI.currentTime = 0; // 처음부터
            soundAI.play();
            currentBgm = soundAI; // ★ 현재 BGM을 AI로 교체 (백그라운드 갔다 와도 이게 재생됨)
        }
    }
};

// 경고창 확인 버튼 클릭 시 -> 컷신으로 이동
window.confirmRivalWarning = function() {
    document.getElementById('rival-warning-popup').style.display = 'none';
    
    // 저장해둔 점수를 들고 컷신 시작
    showRivalIntro(pendingRivalTarget);
};
// [수정] 컷신 닫기 (음악 원상복구 추가)
window.closeRivalIntro = function() {
    console.log("도전 수락 버튼 클릭됨"); 
    
    const layer = document.getElementById('rival-intro-layer');
    if (!layer) return;

    if (window.rivalTypingIv) {
        clearInterval(window.rivalTypingIv);
        window.rivalTypingIv = null;
    }

    // 부드럽게 사라지기
    layer.style.transition = "opacity 0.5s";
    layer.style.opacity = "0";
    
    setTimeout(() => {
        layer.style.display = 'none';
        layer.style.opacity = "1"; 
        layer.style.transition = ""; 
        
        updateUI();

        // ▼▼▼ [음악 복구 로직] ▼▼▼
        if (isSoundOn) {
            // 1. AI 음악 정지
            if (soundAI) soundAI.stop();

            // 2. 사무실 음악(Phase 2) 다시 재생
            if (soundP2) {
                soundP2.play();
                currentBgm = soundP2; // ★ 현재 BGM 복구
            }
        }

    }, 500);
};

// [재정의] AI 컷신 열기 함수 (안전장치 포함)
window.showRivalIntro = function(targetScore) {
    const layer = document.getElementById('rival-intro-layer');
    const img = layer.querySelector('.rival-bg-img'); 
    const textBox = document.getElementById('rival-typing-text');
    const scoreBox = document.getElementById('rival-intro-target');
    
    // 1. 화면 켜기
    layer.style.display = 'block';
    layer.style.opacity = "1";
    scoreBox.innerText = targetScore.toLocaleString();
    
    // 2. 이미지 애니메이션 리셋 (버그 방지)
    if(img) {
        img.style.animation = 'none';
        img.offsetHeight; /* 리플로우 */
        img.style.animation = 'dramaFadeIn 2s forwards, slowZoom 10s infinite alternate';
        img.style.opacity = "0"; 
    }

    // 3. AI 대사
    const lines = [
        "검토 결과, 인간의 승률은 0.002% 입니다.\n포기하시겠습니까?",
        "효율성 제로의 유기체여...\n나의 연산 속도를 따라올 수 있겠나?",
        "데이터 분석 완료. 너의 패턴은 단순하군.\n압도적인 차이를 보여주지.",
        "감정 따위가 디자인에 필요할까?\n완벽한 논리의 미학을 가르쳐주마."
    ];
    const text = lines[Math.floor(Math.random() * lines.length)];
    
    // 4. 타이핑 효과
    textBox.innerText = "";
    let i = 0;
    if (window.rivalTypingIv) clearInterval(window.rivalTypingIv);
    
    // 1초 뒤(이미지가 좀 밝아진 뒤) 타이핑 시작
    setTimeout(() => {
        window.rivalTypingIv = setInterval(() => {
            if(!textBox) return;
            textBox.innerText += text.charAt(i);
            i++;
            if (i >= text.length) clearInterval(window.rivalTypingIv);
        }, 50);
    }, 1000);
};

// ========================================================
// 🎯 [통합 수정] 알바 돌발 미션 (1px 중앙 정렬) 완벽 수정판
// ========================================================

// 전역 변수 재선언 (기존 변수 충돌 방지 및 초기화)
var miniGameId = null;   
var gameDirection = 1;   
var gamePosition = 0;    
var isGameRunning = false;

// [수정] 게임 시작 (배경 어둡게 처리 추가)
window.startMiniGame = function() {
    // 1. 체력 체크
    if(typeof player !== 'undefined' && player.hp < 20) {
        return alert("체력이 부족합니다. (필요: 20)");
    }

    // 2. 기존 팝업(알바 선택창) 닫기
    closePopup(); 

    // 3. 데이터 갱신
    if(typeof player !== 'undefined') {
        player.hp -= 20;
        player.workedThisWeek = true;
        updateUI();
    }

    // 4. ★ [핵심] 배경 오버레이(어두운 막) 켜기!
    document.getElementById('modal-overlay').style.display = 'block';

    // 5. 미니게임 팝업 열기
    const popup = document.getElementById('minigame-popup');
    if(popup) popup.style.display = 'block';
    
    // UI 초기화
    const msgBox = document.getElementById('minigame-msg');
    if(msgBox) {
        msgBox.innerText = "타이밍을 맞춰보세요!";
        msgBox.style.color = "#333";
    }

    const btn = document.getElementById('minigame-action-btn');
    if(btn) {
        btn.innerText = "STOP!";
        btn.onclick = stopMovingBlock; 
        btn.disabled = false;
    }
    
    // 리셋 및 시작
    if (miniGameId) cancelAnimationFrame(miniGameId);
    gamePosition = 0;
    gameDirection = 1;
    isGameRunning = true;
    runGameLoop();
};

// 2. 애니메이션 루프 (무한 반복)
function runGameLoop() {
    if (!isGameRunning) return;

    // 속도 계산 (안전장치: player나 stat이 없으면 기본 속도 2.5 적용)
    let currentSpeed = 2.5; 
    if (typeof player !== 'undefined' && player.designStat) {
        currentSpeed = 2.5 + (player.designStat / 300);
    }

    // 위치 이동
    gamePosition += currentSpeed * gameDirection;

    // 벽 튕기기 (0 ~ 92%) - 박스 크기 고려해서 92%로 조정
    if (gamePosition >= 92) { 
        gamePosition = 92;
        gameDirection = -1; // 왼쪽으로
    } else if (gamePosition <= 0) { 
        gamePosition = 0;
        gameDirection = 1; // 오른쪽으로
    }

    // 화면 그리기 (DOM 업데이트)
    const block = document.getElementById('moving-block');
    if (block) {
        block.style.left = gamePosition + '%';
    } else {
        console.error("❌ 'moving-block' 요소를 찾을 수 없습니다.");
        isGameRunning = false;
        return;
    }

    // 다음 프레임 요청
    miniGameId = requestAnimationFrame(runGameLoop);
}

// [수정] 정지 및 결과 판정 (닫을 때 배경 끄기 추가)
window.stopMovingBlock = function() {
    isGameRunning = false;
    if(miniGameId) cancelAnimationFrame(miniGameId);
    
    const btn = document.getElementById('minigame-action-btn');
    if(btn) btn.disabled = true;

    // 판정
    const target = 47; 
    const diff = Math.abs(gamePosition - target);
    const msgBox = document.getElementById('minigame-msg');
    
    // 결과 확인
    if (diff < 5.0) { 
        let bonus = 70000;
        if(typeof player !== 'undefined') {
            player.money += bonus;
            player.designStat += 5;
        }
        
        if(msgBox) {
            msgBox.innerText = `✅ 납품 성공! (+7만원 / 감각+5)`;
            msgBox.style.color = "#4CD964";
        }
        if(typeof showFloatingText === 'function') showFloatingText(180, 230, "+70,000원", "#FFD700");

    } else {
        if(msgBox) {
            msgBox.innerText = `💥 납품 거절당함... (수익 0원)`;
            msgBox.style.color = "#FF5F5F";
        }
        if(typeof showFloatingText === 'function') showFloatingText(180, 230, "FAIL...", "#FF5F5F");
    }
    
    if(typeof updateUI === 'function') updateUI();
    if(typeof saveGameData === 'function') saveGameData();
    if(typeof addTime === 'function') addTime(); 

    // 버튼을 '닫기'로 변경
    if(btn) {
        btn.innerText = "닫기";
        btn.disabled = false;
        
        // ★ [닫기 클릭 이벤트]
        btn.onclick = function() {
            // 팝업 닫기
            document.getElementById('minigame-popup').style.display = 'none';
            // ★ [핵심] 배경 오버레이도 같이 끄기!
            document.getElementById('modal-overlay').style.display = 'none';
        };
    }
};

// ========================================================
// ⌨️ [통합] Ctrl+S 연타 게임 (경고 -> 게임 -> 결과)
// ========================================================

var crisisTimer = null;
var saveProgress = 50; 
var decreaseRate = 0.6; // 게이지 감소 속도

// 1. [진입점] 위기 발생 (경고창 띄우기)
// doProjectWork 함수에서 5% 확률로 이 함수를 호출합니다.
window.startCrisisGame = function() {
    console.log("⚠️ 위기 상황 발동: 경고창 오픈");

    // 배경 오버레이(어두운 막) 켜기
    const overlay = document.getElementById('modal-overlay');
    if(overlay) overlay.style.display = 'block';
    
    // 혹시 켜져 있을지 모르는 게임창은 끄고
    const gamePopup = document.getElementById('crisis-popup');
    if(gamePopup) gamePopup.style.display = 'none';

    // ★ 경고창(Warning Popup)을 먼저 켭니다
    const warningPopup = document.getElementById('crisis-warning-popup');
    if(warningPopup) warningPopup.style.display = 'flex';
};

// [수정] 게임 시작 및 난이도 설정
window.realStartCrisis = function() {
    console.log("🚨 게임 시작: 블루스크린 오픈");

    document.getElementById('crisis-warning-popup').style.display = 'none';
    const gamePopup = document.getElementById('crisis-popup');
    if(gamePopup) gamePopup.style.display = 'block';

    saveProgress = 50; 
    
    // ▼▼▼ [밸런스 수정 1] 감소 속도 상향 (0.8 -> 1.2) ▼▼▼
    // 숫자가 클수록 더 빨리 떨어집니다. (1.5 넘어가면 너무 어려움)
    decreaseRate = 1.0; 
    
    updateCrisisUI();

    if(crisisTimer) clearInterval(crisisTimer);
    crisisTimer = setInterval(crisisLoop, 50);
};

// 3. [루프] 시간 흐름에 따른 게이지 감소
function crisisLoop() {
    saveProgress -= decreaseRate;
    
    // 실패 조건 (0 이하)
    if (saveProgress <= 0) {
        saveProgress = 0;
        endCrisis(false); // 실패 처리
        return;
    }
    
    updateCrisisUI();
}

// [수정] 버튼 연타 (장비빨 제거 -> 100% 피지컬 승부)
window.mashSaveButton = function() {
    // ★ [핵심] 장비(currentPower) 변수 제거!
    // 누구나 똑같이 한 번 클릭당 3.5%씩 차오릅니다.
    // (감소 속도가 1.2이므로, 초당 7번 이상 연타해야 게이지가 올라갑니다!)
    let power = 3.8; 
    
    saveProgress += power;

    if (saveProgress >= 100) {
        saveProgress = 100;
        endCrisis(true); 
        return;
    }
    
    updateCrisisUI();
};

// 5. [UI] 화면 갱신
function updateCrisisUI() {
    const bar = document.getElementById('save-bar-fill');
    const txt = document.getElementById('save-text');
    
    if(!bar || !txt) return;

    // 표기용 정수 변환
    let displayProg = Math.max(0, Math.min(100, Math.floor(saveProgress)));

    bar.style.width = displayProg + "%";
    txt.innerText = `SAVING... ${displayProg}%`;
    
    // 색상 변경 (30% 미만이면 빨간색 경고)
    if(displayProg < 30) {
        bar.style.backgroundColor = "#FF5F5F";
    } else {
        bar.style.backgroundColor = "#4CD964";
    }
}

// [수정] 결과 처리 (성공 시 페이즈에 맞는 업무 복귀)
function endCrisis(isSuccess) {
    // 루프 정지
    if(crisisTimer) clearInterval(crisisTimer);
    
    // 게임창 닫기
    document.getElementById('crisis-popup').style.display = 'none';
    
    if (isSuccess) {
        // [성공] 배경 끄고 정상 업무 복귀
        document.getElementById('modal-overlay').style.display = 'none';
        alert("휴... 저장에 성공했습니다! (작업 계속 진행)");
        
        // ★ [핵심] 페이즈에 따라 다른 업무 함수 호출
        if (player.isPhase2) {
            // [Phase 2] 사무실 업무 (realWork 호출)
            // 기존 doP2Work의 비용/배율 계산 로직을 가져옴
            let baseCost = 20; 
            let mult = player.currentProject.costMult || 1.0;
            let finalCost = Math.floor(baseCost * mult);
            let strat = player.currentProject.strategyName || "일반";

            // 사무실 컷신 실행
            realWork(player.currentProject.progMult || 1.0, finalCost, strat);
        } else {
            // [Phase 1] 포트폴리오 작업 (processNormalWork 호출)
            if(typeof processNormalWork === 'function') {
                processNormalWork();
            }
        }
    } else {
        // [실패] 배경 유지하고 크래시(실패) 팝업 띄우기
        const crashPopup = document.getElementById('crash-popup');
        if(crashPopup) crashPopup.style.display = 'flex';
    }
}

// [수정] 데이터 복구 (광고 시청 후 페이즈 분기)
window.recoverCrash = function() {
    const resumeWork = () => {
        document.getElementById('crash-popup').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        alert("백업 파일을 찾았습니다! 작업을 계속합니다.");
        
        // ★ [핵심] 여기서도 페이즈 분기 처리
        if (player.isPhase2) {
            let baseCost = 20; 
            let mult = player.currentProject.costMult || 1.0;
            let finalCost = Math.floor(baseCost * mult);
            let strat = player.currentProject.strategyName || "복구됨";
            
            realWork(player.currentProject.progMult || 1.0, finalCost, strat);
        } else {
            if(typeof processNormalWork === 'function') processNormalWork();
        }
    };

    if(typeof showAd === 'function') {
   showAd('GAME_RESTORE', resumeWork);
    } else {
        alert("광고 로드 실패. 그냥 복구해드립니다.");
        resumeWork();
    }
};

// 8. [포기] 작업 취소 (패널티)
window.acceptCrash = function() {
    document.getElementById('crash-popup').style.display = 'none';
    document.getElementById('modal-overlay').style.display = 'none';
    
    if(typeof player !== 'undefined') {
        player.hp -= 30; // 체력만 날림
    }
    
    if(typeof addTime === 'function') addTime();
    
    alert("프로그램이 강제 종료되었습니다.\n(체력 -30, 이번 작업 소득 없음)");
    
    if(typeof updateUI === 'function') updateUI();
};

// [수정] 급여 확인 버튼 (광고 없이 즉시 닫기)
window.confirmPayday = function() {
    closePopup(); // 팝업 닫기
    updateAudioState('main'); // 소리 다시 켜기
    console.log("💸 월급 수령 확인 완료");
};

// [수정] SSS급 강제 할당 테스트 (이미지 컷신 연동)
window.testTrueEnding = function() {
    if(!confirm("⚠️ SSS급 '특이점' 프로젝트를 강제로 할당받으시겠습니까?")) return;

    // 1. 강제 환경 설정 (Phase 2, Space Tier)
    if (!player.isPhase2) {
        player.isPhase2 = true;
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('phase2-ui-layer').style.display = 'flex';
    }
    player.tier = 'Space';
    player.rank = 3; 
    updateSalary();
    setBgByTier('Space');

    // 2. SSS급 프로젝트 데이터 주입
    player.currentProject = {
        name: "Project: Singularity (특이점)",
        tier: 'SSS',
        companyTier: 'Space',
        originalTier: 'SSS',
        progress: 0,
        deadline: 15,
        currentWeek: 0,
        isExtended: false,
        meetingDone: false,
        progMult: 1.0,
        costMult: 1.0,
        strategyName: "미정",
        buffType: 'all',
        isRival: false,
        rivalName: "",
        rivalTarget: 0,
        isMasterpiece: false,
        isSingularity: true   // ★ 핵심 플래그
    };

    // 3. UI 갱신 및 로그
    updateUI();
    showP2Log("🌌 [Cheat] 최후의 프로젝트가 할당되었습니다.");
    
    // ▼▼▼ [수정] 텍스트 알림(alert) 제거 -> 이미지 컷신 함수 호출 ▼▼▼
    if (typeof showSSSIntro === 'function') {
        showSSSIntro(); // 컷신 재생!
    } else {
        console.error("showSSSIntro 함수를 찾을 수 없습니다.");
        alert("컷신 함수가 없습니다.");
    }
};

// [신규] 박물관 열기
window.openMuseum = function() {
    // 혹시 데이터가 없으면 초기화
    if (!player.museum) player.museum = [];
    renderMuseum();
    openPopup('museum-popup');
};

// [수정] 박물관 렌더링 (빈 슬롯 멘트 구체화)
window.renderMuseum = function() {
    const grid = document.getElementById('museum-grid');
    const countEl = document.getElementById('museum-count');
    
    if (!grid || !countEl) return;
    
    grid.innerHTML = '';
    
    // 현재 수집 개수
    const currentCount = player.museum ? player.museum.length : 0;
    countEl.innerText = currentCount;

    // 10개 슬롯 그리기
    for (let i = 0; i < 10; i++) {
        const item = player.museum[i]; 
        
        if (item) {
            // [획득 완료]
            grid.innerHTML += `
                <div class="museum-item acquired">
                    <div class="artifact-icon">🏺</div>
                    <div class="artifact-name">${item.name}</div>
                    <div class="artifact-desc">"${item.desc || '전설의 유물'}"</div>
                </div>
            `;
        } else {
            // [미획득 - 힌트 강화]
            grid.innerHTML += `
                <div class="museum-item empty">
                    <div class="artifact-icon" style="filter:grayscale(1); opacity:0.5;">🔒</div>
                    <div class="artifact-name" style="color:#777;">[ 비어있음 ]</div>
                    <div class="artifact-desc" style="color:#555;">
                        Space 티어 진입 후<br>
                        <span style="color:#888; font-weight:bold;">SS급 프로젝트</span> 발견
                    </div>
                </div>
            `;
        }
    }
};


// [신규] SSS급 인트로 컷신 열기
function showSSSIntro() {
    const layer = document.getElementById('sss-intro-layer');
    if (!layer) return;

    // 1. UI 숨김 (몰입감)
    document.getElementById('phase2-ui-layer').style.display = 'none';
    
    // 2. 컷신 표시
    layer.style.display = 'flex';
    
    // 3. (선택사항) BGM 변경: AI 테마곡이 있다면 재생
    if (isSoundOn && soundAI) {
        if(currentBgm) currentBgm.stop();
        soundAI.currentTime = 0;
        soundAI.play();
        currentBgm = soundAI;
    }
}

// [신규] 컷신 닫고 게임 시작
window.startSSSProject = function() {
    const layer = document.getElementById('sss-intro-layer');
    
    // 1. 컷신 페이드 아웃
    layer.style.transition = 'opacity 0.5s';
    layer.style.opacity = '0';
    
    setTimeout(() => {
        layer.style.display = 'none';
        layer.style.opacity = '1'; // 다음을 위해 복구
        layer.style.transition = '';

        // 2. UI 복구
        document.getElementById('phase2-ui-layer').style.display = 'flex';
        
        // 3. 로그 출력
        showFloatingText(180, 300, "🔥 임무 시작!", "#FF5F5F");
        // ▼▼▼ [추가] BGM 상태 갱신 호출 ▼▼▼
        // 이제 프로젝트가 할당된 상태이므로, updateAudioState가
        // 자동으로 SSS급 BGM을 감지하여 재생합니다.
        updateAudioState('main');
    }, 500);
};

// ========================================================
// 🔒 [출시 모드] 모든 치트 및 테스트 버튼 일괄 숨기기 (자동)
// ========================================================
window.addEventListener('load', function() {
    // 1. [치트 패널] ID로 찾아서 숨기기
    const cheatPanel = document.getElementById('cheat-panel');
    if (cheatPanel) {
        cheatPanel.style.display = 'none';
    }

    // 2. [디버그 버튼] 클래스로 찾아서 숨기기 (엔딩 테스트 등)
    const debugButtons = document.querySelectorAll('.debug-btn');
    debugButtons.forEach(btn => {
        btn.style.display = 'none';
    });

    // 3. [자동 탐색] onclick 코드에 'test'나 'cheat'가 들어간 모든 버튼 숨기기
    // (숨겨진 곳에 있는 강제 이직 버튼 등을 싹 찾아서 처리)
    const allButtons = document.querySelectorAll('button');
    allButtons.forEach(btn => {
        const action = btn.getAttribute('onclick');
        if (action) {
            const lowerAction = action.toLowerCase();
            // 함수 이름에 'cheat', 'test', 'reset' 단어가 포함되어 있으면 숨김
            if (lowerAction.includes('cheat') || 
                lowerAction.includes('test') || 
                lowerAction.includes('resetgamedata')) {
                
                // 설정 팝업 안에 있는 '초기화' 버튼은 제외하고 싶다면 조건 추가 가능
                // 여기서는 안전하게 다 숨깁니다.
                btn.style.display = 'none';
            }
        }
    });

    console.log("🚫 [배포 모드 적용] 모든 테스트/치트 기능이 화면에서 제거되었습니다.");
});

// 스크립트 맨 끝에 추가
window.openTossLeaderboard = openTossLeaderboard;
window.triggerDesignAward = triggerDesignAward;
window.claimAward = claimAward;


 </script>
</body>
</html>